/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */
"use strict";var Mediabunny=(()=>{var qi=Object.defineProperty;var ys=Object.getOwnPropertyDescriptor;var Ss=Object.getOwnPropertyNames;var Cs=Object.prototype.hasOwnProperty;var xs=(i,e)=>{for(var t in e)qi(i,t,{get:e[t],enumerable:!0})},vs=(i,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Ss(e))!Cs.call(i,n)&&n!==t&&qi(i,n,{get:()=>e[n],enumerable:!(r=ys(e,n))||r.enumerable});return i};var Ps=i=>vs(qi({},"__esModule",{value:!0}),i);var pc={};xs(pc,{ALL_FORMATS:()=>bs,ALL_TRACK_TYPES:()=>xa,AUDIO_CODECS:()=>X,AdtsOutputFormat:()=>Si,AudioBufferSink:()=>hi,AudioBufferSource:()=>Ai,AudioSample:()=>se,AudioSampleSink:()=>He,AudioSampleSource:()=>dt,AudioSource:()=>Ee,BaseMediaSampleSink:()=>_t,BlobSource:()=>Bi,BufferSource:()=>Oi,BufferTarget:()=>kt,CanvasSink:()=>At,CanvasSource:()=>Ii,Conversion:()=>Ki,CustomAudioDecoder:()=>ar,CustomAudioEncoder:()=>sr,CustomVideoDecoder:()=>ir,CustomVideoEncoder:()=>nr,EncodedAudioPacketSource:()=>Vt,EncodedPacket:()=>M,EncodedPacketSink:()=>we,EncodedVideoPacketSource:()=>Bt,Input:()=>Ht,InputAudioTrack:()=>$,InputFormat:()=>ge,InputTrack:()=>Ke,InputVideoTrack:()=>me,IsobmffInputFormat:()=>Lt,IsobmffOutputFormat:()=>Ft,MATROSKA:()=>Ua,MP3:()=>Na,MP4:()=>Da,MatroskaInputFormat:()=>Wt,MediaSource:()=>ct,MediaStreamAudioTrackSource:()=>Ri,MediaStreamVideoTrackSource:()=>_i,MkvOutputFormat:()=>Ot,MovOutputFormat:()=>Ze,Mp3InputFormat:()=>Tr,Mp3OutputFormat:()=>wi,Mp4InputFormat:()=>br,Mp4OutputFormat:()=>lr,NON_PCM_AUDIO_CODECS:()=>ye,OGG:()=>Wa,OggInputFormat:()=>Sr,OggOutputFormat:()=>yi,Output:()=>Ut,OutputFormat:()=>pe,PCM_AUDIO_CODECS:()=>U,QTFF:()=>Va,QUALITY_HIGH:()=>Gt,QUALITY_LOW:()=>gn,QUALITY_MEDIUM:()=>bn,QUALITY_VERY_HIGH:()=>kn,QUALITY_VERY_LOW:()=>hn,Quality:()=>G,QuickTimeInputFormat:()=>kr,SUBTITLE_CODECS:()=>ce,Source:()=>Ie,StreamSource:()=>Mi,StreamTarget:()=>Yr,SubtitleSource:()=>ut,Target:()=>We,TextSubtitleSource:()=>Fi,UrlSource:()=>Di,VIDEO_CODECS:()=>j,VideoSample:()=>ne,VideoSampleSink:()=>st,VideoSampleSource:()=>Dt,VideoSource:()=>Pe,WAVE:()=>La,WEBM:()=>za,WavOutputFormat:()=>Ti,WaveInputFormat:()=>yr,WebMInputFormat:()=>wr,WebMOutputFormat:()=>rt,canEncode:()=>os,canEncodeAudio:()=>fr,canEncodeSubtitles:()=>pr,canEncodeVideo:()=>mr,getEncodableAudioCodecs:()=>Mt,getEncodableCodecs:()=>cs,getEncodableSubtitleCodecs:()=>Ta,getEncodableVideoCodecs:()=>wa,getFirstEncodableAudioCodec:()=>ds,getFirstEncodableSubtitleCodec:()=>us,getFirstEncodableVideoCodec:()=>Ei,registerDecoder:()=>Zn,registerEncoder:()=>Jn});function m(i){if(!i)throw new Error("Assertion failed.")}var Ue=i=>{let e=(i%360+360)%360;if(e===0||e===90||e===180||e===270)return e;throw new Error(`Invalid rotation ${i}.`)},z=i=>i&&i[i.length-1],je=i=>i>=0&&i<2**32,N=class i{constructor(e){this.bytes=e;this.pos=0}seekToByte(e){this.pos=8*e}readBit(){let e=Math.floor(this.pos/8),t=this.bytes[e]??0,r=7-(this.pos&7),n=(t&1<<r)>>r;return this.pos++,n}readBits(e){if(e===1)return this.readBit();let t=0;for(let r=0;r<e;r++)t<<=1,t|=this.readBit();return t}writeBits(e,t){let r=this.pos+e;for(let n=this.pos;n<r;n++){let a=Math.floor(n/8),s=this.bytes[a],o=7-(n&7);s&=~(1<<o),s|=(t&1<<r-n-1)>>r-n-1<<o,this.bytes[a]=s}this.pos=r}readAlignedByte(){if(this.pos%8!==0)throw new Error("Bitstream is not byte-aligned.");let e=this.pos/8,t=this.bytes[e]??0;return this.pos+=8,t}skipBits(e){this.pos+=e}getBitsLeft(){return this.bytes.length*8-this.pos}clone(){let e=new i(this.bytes);return e.pos=this.pos,e}},I=i=>{let e=0;for(;i.readBits(1)===0&&e<32;)e++;if(e>=32)throw new Error("Invalid exponential-Golomb code.");return(1<<e)-1+i.readBits(e)},mt=i=>{let e=I(i);return(e&1)===0?-(e>>1):e+1>>1},$a=(i,e,t,r)=>{for(let n=e;n<t;n++){let a=Math.floor(n/8),s=i[a],o=7-(n&7);s&=~(1<<o),s|=(r&1<<t-n-1)>>t-n-1<<o,i[a]=s}},K=i=>i instanceof Uint8Array?i:i instanceof ArrayBuffer?new Uint8Array(i):new Uint8Array(i.buffer,i.byteOffset,i.byteLength),re=i=>i instanceof DataView?i:i instanceof ArrayBuffer?new DataView(i):new DataView(i.buffer,i.byteOffset,i.byteLength),xr=new TextDecoder,oe=new TextEncoder,ji=i=>Object.fromEntries(Object.entries(i).map(([e,t])=>[t,e])),_e={bt709:1,bt470bg:5,smpte170m:6,bt2020:9,smpte432:12},vr=ji(_e),Ae={bt709:1,smpte170m:6,linear:8,"iec61966-2-1":13,pg:16,hlg:18},Pr=ji(Ae),Re={rgb:0,bt709:1,bt470bg:5,smpte170m:6,"bt2020-ncl":9},Er=ji(Re),Ir=i=>!!i&&!!i.primaries&&!!i.transfer&&!!i.matrix&&i.fullRange!==void 0,ft=i=>i instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&i instanceof SharedArrayBuffer||ArrayBuffer.isView(i),te=class{constructor(){this.currentPromise=Promise.resolve()}async acquire(){let e,t=new Promise(n=>{e=n}),r=this.currentPromise;return this.currentPromise=t,await r,e}},$i=i=>[...i].map(e=>e.toString(16).padStart(2,"0")).join(""),Gi=i=>(i=i>>1&1431655765|(i&1431655765)<<1,i=i>>2&858993459|(i&858993459)<<2,i=i>>4&252645135|(i&252645135)<<4,i=i>>8&16711935|(i&16711935)<<8,i=i>>16&65535|(i&65535)<<16,i>>>0),W=(i,e,t)=>{let r=0,n=i.length-1,a=-1;for(;r<=n;){let s=r+n>>1,o=t(i[s]);o===e?(a=s,n=s-1):o<e?r=s+1:n=s-1}return a},B=(i,e,t)=>{let r=0,n=i.length-1,a=-1;for(;r<=n;){let s=r+(n-r+1)/2|0;t(i[s])<=e?(a=s,r=s+1):n=s-1}return a},be=(i,e,t)=>{let r=B(i,t(e),t);i.splice(r+1,0,e)},L=()=>{let i,e;return{promise:new Promise((r,n)=>{i=r,e=n}),resolve:i,reject:e}},Ga=(i,e)=>{let t=i.indexOf(e);t!==-1&&i.splice(t,1)},Xi=(i,e)=>{for(let t=i.length-1;t>=0;t--)if(e(i[t]))return i[t]},_r=(i,e)=>{for(let t=i.length-1;t>=0;t--)if(e(i[t]))return t;return-1},Xa=async function*(i){Symbol.iterator in i?yield*i[Symbol.iterator]():yield*i[Symbol.asyncIterator]()},Ya=i=>{if(!(Symbol.iterator in i)&&!(Symbol.asyncIterator in i))throw new TypeError("Argument must be an iterable or async iterable.")},ke=i=>{throw new Error(`Unexpected value: ${i}`)},Yi=(i,e,t)=>{let r=i.getUint8(e),n=i.getUint8(e+1),a=i.getUint8(e+2);return t?r|n<<8|a<<16:r<<16|n<<8|a},Za=(i,e,t)=>Yi(i,e,t)<<8>>8,Zi=(i,e,t,r)=>{t=t>>>0,t=t&16777215,r?(i.setUint8(e,t&255),i.setUint8(e+1,t>>>8&255),i.setUint8(e+2,t>>>16&255)):(i.setUint8(e,t>>>16&255),i.setUint8(e+1,t>>>8&255),i.setUint8(e+2,t&255))},Ja=(i,e,t,r)=>{t=J(t,-8388608,8388607),t<0&&(t=t+16777216&16777215),Zi(i,e,t,r)},en=(i,e,t,r)=>{r?(i.setUint32(e+0,t,!0),i.setInt32(e+4,Math.floor(t/2**32),!0)):(i.setInt32(e+0,Math.floor(t/2**32),!0),i.setUint32(e+4,t,!0))},Kt=(i,e)=>({async next(){let t=await i.next();return t.done?{value:void 0,done:!0}:{value:e(t.value),done:!1}},return(){return i.return()},throw(t){return i.throw(t)},[Symbol.asyncIterator](){return this}}),J=(i,e,t)=>Math.max(e,Math.min(t,i)),Q="und",pt=(i,e)=>{let t=10**e;return Math.round(i*t)/t},qt=(i,e)=>Math.round(i/e)*e,tn=i=>{let e=0;for(;i;)e++,i>>=1;return e},Es=/^[a-z]{3}$/,Fe=i=>Es.test(i),Te=1e6*(1+Number.EPSILON),Qt=(i,e)=>{let t={...i};for(let r in e)typeof i[r]=="object"&&i[r]!==null&&typeof e[r]=="object"&&e[r]!==null?t[r]=Qt(i[r],e[r]):t[r]=e[r];return t},Ar=async(i,e,t)=>{let r=0;for(;;)try{return await fetch(i,e)}catch(n){r++;let a=t(r);if(a===null)throw n;if(console.error("Retrying failed fetch. Error:",n),!Number.isFinite(a)||a<0)throw new TypeError("Retry delay must be a non-negative finite number.");a>0&&await new Promise(s=>setTimeout(s,1e3*a))}},rn=(i,e)=>{let t=i<0?-1:1;i=Math.abs(i);let r=0,n=1,a=1,s=0,o=i;for(;;){let c=Math.floor(o),u=c*a+r,d=c*s+n;if(d>e)return{numerator:t*a,denominator:s};if(r=a,n=s,a=u,s=d,o=1/(o-c),!isFinite(o))break}return{numerator:t*a,denominator:s}},Ve=class{constructor(){this.currentPromise=Promise.resolve()}call(e){return this.currentPromise=this.currentPromise.then(e)}},Qi=null,Rr=()=>{if(Qi!==null)return Qi;let i=!!(typeof navigator<"u"&&navigator.vendor?.match(/apple/i)&&!navigator.userAgent?.match(/crios/i)&&!navigator.userAgent?.match(/fxios/i)&&!navigator.userAgent?.match(/Opera|OPT\//));return Qi=i,i};var j=["avc","hevc","vp9","av1","vp8"],U=["pcm-s16","pcm-s16be","pcm-s24","pcm-s24be","pcm-s32","pcm-s32be","pcm-f32","pcm-f32be","pcm-f64","pcm-f64be","pcm-u8","pcm-s8","ulaw","alaw"],ye=["aac","opus","mp3","vorbis","flac"],X=[...ye,...U],ce=["webvtt"],an=[{maxMacroblocks:99,maxBitrate:64e3,level:10},{maxMacroblocks:396,maxBitrate:192e3,level:11},{maxMacroblocks:396,maxBitrate:384e3,level:12},{maxMacroblocks:396,maxBitrate:768e3,level:13},{maxMacroblocks:396,maxBitrate:2e6,level:20},{maxMacroblocks:792,maxBitrate:4e6,level:21},{maxMacroblocks:1620,maxBitrate:4e6,level:22},{maxMacroblocks:1620,maxBitrate:1e7,level:30},{maxMacroblocks:3600,maxBitrate:14e6,level:31},{maxMacroblocks:5120,maxBitrate:2e7,level:32},{maxMacroblocks:8192,maxBitrate:2e7,level:40},{maxMacroblocks:8192,maxBitrate:5e7,level:41},{maxMacroblocks:8704,maxBitrate:5e7,level:42},{maxMacroblocks:22080,maxBitrate:135e6,level:50},{maxMacroblocks:36864,maxBitrate:24e7,level:51},{maxMacroblocks:36864,maxBitrate:24e7,level:52},{maxMacroblocks:139264,maxBitrate:24e7,level:60},{maxMacroblocks:139264,maxBitrate:48e7,level:61},{maxMacroblocks:139264,maxBitrate:8e8,level:62}],nn=[{maxPictureSize:36864,maxBitrate:128e3,tier:"L",level:30},{maxPictureSize:122880,maxBitrate:15e5,tier:"L",level:60},{maxPictureSize:245760,maxBitrate:3e6,tier:"L",level:63},{maxPictureSize:552960,maxBitrate:6e6,tier:"L",level:90},{maxPictureSize:983040,maxBitrate:1e7,tier:"L",level:93},{maxPictureSize:2228224,maxBitrate:12e6,tier:"L",level:120},{maxPictureSize:2228224,maxBitrate:3e7,tier:"H",level:120},{maxPictureSize:2228224,maxBitrate:2e7,tier:"L",level:123},{maxPictureSize:2228224,maxBitrate:5e7,tier:"H",level:123},{maxPictureSize:8912896,maxBitrate:25e6,tier:"L",level:150},{maxPictureSize:8912896,maxBitrate:1e8,tier:"H",level:150},{maxPictureSize:8912896,maxBitrate:4e7,tier:"L",level:153},{maxPictureSize:8912896,maxBitrate:16e7,tier:"H",level:153},{maxPictureSize:8912896,maxBitrate:6e7,tier:"L",level:156},{maxPictureSize:8912896,maxBitrate:24e7,tier:"H",level:156},{maxPictureSize:35651584,maxBitrate:6e7,tier:"L",level:180},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:180},{maxPictureSize:35651584,maxBitrate:12e7,tier:"L",level:183},{maxPictureSize:35651584,maxBitrate:48e7,tier:"H",level:183},{maxPictureSize:35651584,maxBitrate:24e7,tier:"L",level:186},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:186}],Oe=[{maxPictureSize:36864,maxBitrate:2e5,level:10},{maxPictureSize:73728,maxBitrate:8e5,level:11},{maxPictureSize:122880,maxBitrate:18e5,level:20},{maxPictureSize:245760,maxBitrate:36e5,level:21},{maxPictureSize:552960,maxBitrate:72e5,level:30},{maxPictureSize:983040,maxBitrate:12e6,level:31},{maxPictureSize:2228224,maxBitrate:18e6,level:40},{maxPictureSize:2228224,maxBitrate:3e7,level:41},{maxPictureSize:8912896,maxBitrate:6e7,level:50},{maxPictureSize:8912896,maxBitrate:12e7,level:51},{maxPictureSize:8912896,maxBitrate:18e7,level:52},{maxPictureSize:35651584,maxBitrate:18e7,level:60},{maxPictureSize:35651584,maxBitrate:24e7,level:61},{maxPictureSize:35651584,maxBitrate:48e7,level:62}],sn=[{maxPictureSize:147456,maxBitrate:15e5,tier:"M",level:0},{maxPictureSize:278784,maxBitrate:3e6,tier:"M",level:1},{maxPictureSize:665856,maxBitrate:6e6,tier:"M",level:4},{maxPictureSize:1065024,maxBitrate:1e7,tier:"M",level:5},{maxPictureSize:2359296,maxBitrate:12e6,tier:"M",level:8},{maxPictureSize:2359296,maxBitrate:3e7,tier:"H",level:8},{maxPictureSize:2359296,maxBitrate:2e7,tier:"M",level:9},{maxPictureSize:2359296,maxBitrate:5e7,tier:"H",level:9},{maxPictureSize:8912896,maxBitrate:3e7,tier:"M",level:12},{maxPictureSize:8912896,maxBitrate:1e8,tier:"H",level:12},{maxPictureSize:8912896,maxBitrate:4e7,tier:"M",level:13},{maxPictureSize:8912896,maxBitrate:16e7,tier:"H",level:13},{maxPictureSize:8912896,maxBitrate:6e7,tier:"M",level:14},{maxPictureSize:8912896,maxBitrate:24e7,tier:"H",level:14},{maxPictureSize:35651584,maxBitrate:6e7,tier:"M",level:15},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:15},{maxPictureSize:35651584,maxBitrate:6e7,tier:"M",level:16},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:16},{maxPictureSize:35651584,maxBitrate:1e8,tier:"M",level:17},{maxPictureSize:35651584,maxBitrate:48e7,tier:"H",level:17},{maxPictureSize:35651584,maxBitrate:16e7,tier:"M",level:18},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:18},{maxPictureSize:35651584,maxBitrate:16e7,tier:"M",level:19},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:19}],on=".01.01.01.01.00",cn=".0.110.01.01.01.0",dn=(i,e,t,r)=>{if(i==="avc"){let a=Math.ceil(e/16)*Math.ceil(t/16),s=an.find(l=>a<=l.maxMacroblocks&&r<=l.maxBitrate)??z(an),o=s?s.level:0,c="64".padStart(2,"0"),u="00",d=o.toString(16).padStart(2,"0");return`avc1.${c}${u}${d}`}else if(i==="hevc"){let n="",s="6",o=e*t,c=nn.find(d=>o<=d.maxPictureSize&&r<=d.maxBitrate)??z(nn);return`hev1.${n}1.${s}.${c.tier}${c.level}.B0`}else{if(i==="vp8")return"vp8";if(i==="vp9"){let n="00",a=e*t,s=Oe.find(c=>a<=c.maxPictureSize&&r<=c.maxBitrate)??z(Oe);return`vp09.${n}.${s.level.toString().padStart(2,"0")}.08`}else if(i==="av1"){let a=e*t,s=sn.find(u=>a<=u.maxPictureSize&&r<=u.maxBitrate)??z(sn);return`av01.0.${s.level.toString().padStart(2,"0")}${s.tier}.08`}}throw new TypeError(`Unhandled codec '${i}'.`)},un=i=>{let e=i.split("."),t=Number(e[1]),r=Number(e[2]),n=Number(e[3]),a=e[4]?Number(e[4]):1;return[1,1,t,2,1,r,3,1,n,4,1,a]},Fr=i=>{let e=i.split("."),n=(1<<7)+1,a=Number(e[1]),s=e[2],o=Number(s.slice(0,-1)),c=(a<<5)+o,u=s.slice(-1)==="H"?1:0,l=Number(e[3])===8?0:1,f=0,h=e[4]?Number(e[4]):0,p=e[5]?Number(e[5][0]):1,k=e[5]?Number(e[5][1]):1,g=e[5]?Number(e[5][2]):0,b=(u<<7)+(l<<6)+(f<<5)+(h<<4)+(p<<3)+(k<<2)+g;return[n,c,b,0]},Or=i=>{let{codec:e,codecDescription:t,colorSpace:r,avcCodecInfo:n,hevcCodecInfo:a,vp9CodecInfo:s,av1CodecInfo:o}=i;if(e==="avc"){if(n){let c=new Uint8Array([n.avcProfileIndication,n.profileCompatibility,n.avcLevelIndication]);return`avc1.${$i(c)}`}if(!t||t.byteLength<4)throw new TypeError("AVC decoder description is not provided or is not at least 4 bytes long.");return`avc1.${$i(t.subarray(1,4))}`}else if(e==="hevc"){let c,u,d,l,f,h;if(a)c=a.generalProfileSpace,u=a.generalProfileIdc,d=Gi(a.generalProfileCompatibilityFlags),l=a.generalTierFlag,f=a.generalLevelIdc,h=[...a.generalConstraintIndicatorFlags];else{if(!t||t.byteLength<23)throw new TypeError("HEVC decoder description is not provided or is not at least 23 bytes long.");let k=re(t),g=k.getUint8(1);c=g>>6&3,u=g&31,d=Gi(k.getUint32(2)),l=g>>5&1,f=k.getUint8(12),h=[];for(let b=0;b<6;b++)h.push(k.getUint8(6+b))}let p="hev1.";for(p+=["","A","B","C"][c]+u,p+=".",p+=d.toString(16).toUpperCase(),p+=".",p+=l===0?"L":"H",p+=f;h.length>0&&h[h.length-1]===0;)h.pop();return h.length>0&&(p+=".",p+=h.map(k=>k.toString(16).toUpperCase()).join(".")),p}else{if(e==="vp8")return"vp8";if(e==="vp9"){if(!s){let b=i.width*i.height,w=z(Oe).level;for(let S of Oe)if(b<=S.maxPictureSize){w=S.level;break}return`vp09.00.${w.toString().padStart(2,"0")}.08`}let c=s.profile.toString().padStart(2,"0"),u=s.level.toString().padStart(2,"0"),d=s.bitDepth.toString().padStart(2,"0"),l=s.chromaSubsampling.toString().padStart(2,"0"),f=s.colourPrimaries.toString().padStart(2,"0"),h=s.transferCharacteristics.toString().padStart(2,"0"),p=s.matrixCoefficients.toString().padStart(2,"0"),k=s.videoFullRangeFlag.toString().padStart(2,"0"),g=`vp09.${c}.${u}.${d}.${l}`;return g+=`.${f}.${h}.${p}.${k}`,g.endsWith(on)&&(g=g.slice(0,-on.length)),g}else if(e==="av1"){if(!o){let S=i.width*i.height,x=z(Oe).level;for(let y of Oe)if(S<=y.maxPictureSize){x=y.level;break}return`av01.0.${x.toString().padStart(2,"0")}M.08`}let c=o.profile,u=o.level.toString().padStart(2,"0"),d=o.tier?"H":"M",l=o.bitDepth.toString().padStart(2,"0"),f=o.monochrome?"1":"0",h=100*o.chromaSubsamplingX+10*o.chromaSubsamplingY+1*(o.chromaSubsamplingX&&o.chromaSubsamplingY?o.chromaSamplePosition:0),p=r?.primaries?_e[r.primaries]:1,k=r?.transfer?Ae[r.transfer]:1,g=r?.matrix?Re[r.matrix]:1,b=r?.fullRange?1:0,w=`av01.${c}.${u}${d}.${l}`;return w+=`.${f}.${h.toString().padStart(3,"0")}`,w+=`.${p.toString().padStart(2,"0")}`,w+=`.${k.toString().padStart(2,"0")}`,w+=`.${g.toString().padStart(2,"0")}`,w+=`.${b}`,w.endsWith(cn)&&(w=w.slice(0,-cn.length)),w}}throw new TypeError(`Unhandled codec '${e}'.`)},ln=(i,e,t)=>{if(i==="aac")return e>=2&&t<=24e3?"mp4a.40.29":t<=24e3?"mp4a.40.5":"mp4a.40.2";if(i==="mp3")return"mp3";if(i==="opus")return"opus";if(i==="vorbis")return"vorbis";if(i==="flac")return"flac";if(U.includes(i))return i;throw new TypeError(`Unhandled codec '${i}'.`)},Mr=i=>{let{codec:e,codecDescription:t,aacCodecInfo:r}=i;if(e==="aac"){if(!r)throw new TypeError("AAC codec info must be provided.");return r.isMpeg2?"mp4a.67":`mp4a.40.${$t(t).objectType}`}else{if(e==="mp3")return"mp3";if(e==="opus")return"opus";if(e==="vorbis")return"vorbis";if(e==="flac")return"flac";if(e&&U.includes(e))return e}throw new TypeError(`Unhandled codec '${e}'.`)},jt=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],Ji=[-1,1,2,3,4,5,6,8],$t=i=>{if(!i||i.byteLength<2)throw new TypeError("AAC description must be at least 2 bytes long.");let e=new N(i),t=e.readBits(5);t===31&&(t=32+e.readBits(6));let r=e.readBits(4),n=null;r===15?n=e.readBits(24):r<jt.length&&(n=jt[r]);let a=e.readBits(4),s=null;return a>=1&&a<=7&&(s=Ji[a]),{objectType:t,frequencyIndex:r,sampleRate:n,channelConfiguration:a,numberOfChannels:s}},ht=48e3,mn=/^pcm-([usf])(\d+)+(be)?$/,ee=i=>{if(m(U.includes(i)),i==="ulaw")return{dataType:"ulaw",sampleSize:1,littleEndian:!0,silentValue:255};if(i==="alaw")return{dataType:"alaw",sampleSize:1,littleEndian:!0,silentValue:213};let e=mn.exec(i);m(e);let t;e[1]==="u"?t="unsigned":e[1]==="s"?t="signed":t="float";let r=Number(e[2])/8,n=e[3]!=="be",a=i==="pcm-u8"?2**7:0;return{dataType:t,sampleSize:r,littleEndian:n,silentValue:a}},ea=i=>i.startsWith("avc1")||i.startsWith("avc3")?"avc":i.startsWith("hev1")||i.startsWith("hvc1")?"hevc":i==="vp8"?"vp8":i.startsWith("vp09")?"vp9":i.startsWith("av01")?"av1":i.startsWith("mp4a.40")||i==="mp4a.67"?"aac":i==="mp3"||i==="mp4a.69"||i==="mp4a.6B"||i==="mp4a.6b"?"mp3":i==="opus"?"opus":i==="vorbis"?"vorbis":i==="flac"?"flac":i==="ulaw"?"ulaw":i==="alaw"?"alaw":mn.test(i)?i:i==="webvtt"?"webvtt":null,fn=i=>i==="avc"?{avc:{format:"avc"}}:i==="hevc"?{hevc:{format:"hevc"}}:{},pn=i=>i==="aac"?{aac:{format:"aac"}}:i==="opus"?{opus:{format:"opus"}}:{},G=class{constructor(e){this._factor=e}_toVideoBitrate(e,t,r){let n=t*r,a={avc:1,hevc:.6,vp9:.6,av1:.4,vp8:1.2},s=1920*1080,o=3e6,c=Math.pow(n/s,.95),l=o*c*a[e]*this._factor;return Math.ceil(l/1e3)*1e3}_toAudioBitrate(e){if(U.includes(e)||e==="flac")return;let r={aac:128e3,opus:64e3,mp3:16e4,vorbis:64e3}[e];if(!r)throw new Error(`Unhandled codec: ${e}`);let n=r*this._factor;return e==="aac"?n=[96e3,128e3,16e4,192e3].reduce((s,o)=>Math.abs(o-n)<Math.abs(s-n)?o:s):e==="opus"||e==="vorbis"?n=Math.max(6e3,n):e==="mp3"&&(n=[8e3,16e3,24e3,32e3,4e4,48e3,64e3,8e4,96e3,112e3,128e3,16e4,192e3,224e3,256e3,32e4].reduce((s,o)=>Math.abs(o-n)<Math.abs(s-n)?o:s)),Math.round(n/1e3)*1e3}},hn=new G(.3),gn=new G(.6),bn=new G(1),Gt=new G(2),kn=new G(4),Is=["avc1","avc3","hev1","hvc1","vp8","vp09","av01"],_s=/^(avc1|avc3)\.[0-9a-fA-F]{6}$/,As=/^(hev1|hvc1)\.(?:[ABC]?\d+)\.[0-9a-fA-F]{1,8}\.[LH]\d+(?:\.[0-9a-fA-F]{1,2}){0,6}$/,Rs=/^vp09(?:\.\d{2}){3}(?:(?:\.\d{2}){5})?$/,Fs=/^av01\.\d\.\d{2}[MH]\.\d{2}(?:\.\d\.\d{3}\.\d{2}\.\d{2}\.\d{2}\.\d)?$/,Br=i=>{if(!i)throw new TypeError("Video chunk metadata must be provided.");if(typeof i!="object")throw new TypeError("Video chunk metadata must be an object.");if(!i.decoderConfig)throw new TypeError("Video chunk metadata must include a decoder configuration.");if(typeof i.decoderConfig!="object")throw new TypeError("Video chunk metadata decoder configuration must be an object.");if(typeof i.decoderConfig.codec!="string")throw new TypeError("Video chunk metadata decoder configuration must specify a codec string.");if(!Is.some(e=>i.decoderConfig.codec.startsWith(e)))throw new TypeError("Video chunk metadata decoder configuration codec string must be a valid video codec string as specified in the WebCodecs Codec Registry.");if(!Number.isInteger(i.decoderConfig.codedWidth)||i.decoderConfig.codedWidth<=0)throw new TypeError("Video chunk metadata decoder configuration must specify a valid codedWidth (positive integer).");if(!Number.isInteger(i.decoderConfig.codedHeight)||i.decoderConfig.codedHeight<=0)throw new TypeError("Video chunk metadata decoder configuration must specify a valid codedHeight (positive integer).");if(i.decoderConfig.description!==void 0&&!ft(i.decoderConfig.description))throw new TypeError("Video chunk metadata decoder configuration description, when defined, must be an ArrayBuffer or an ArrayBuffer view.");if(i.decoderConfig.colorSpace!==void 0){let{colorSpace:e}=i.decoderConfig;if(typeof e!="object")throw new TypeError("Video chunk metadata decoder configuration colorSpace, when provided, must be an object.");let t=Object.keys(_e);if(e.primaries!=null&&!t.includes(e.primaries))throw new TypeError(`Video chunk metadata decoder configuration colorSpace primaries, when defined, must be one of ${t.join(", ")}.`);let r=Object.keys(Ae);if(e.transfer!=null&&!r.includes(e.transfer))throw new TypeError(`Video chunk metadata decoder configuration colorSpace transfer, when defined, must be one of ${r.join(", ")}.`);let n=Object.keys(Re);if(e.matrix!=null&&!n.includes(e.matrix))throw new TypeError(`Video chunk metadata decoder configuration colorSpace matrix, when defined, must be one of ${n.join(", ")}.`);if(e.fullRange!=null&&typeof e.fullRange!="boolean")throw new TypeError("Video chunk metadata decoder configuration colorSpace fullRange, when defined, must be a boolean.")}if(i.decoderConfig.codec.startsWith("avc1")||i.decoderConfig.codec.startsWith("avc3")){if(!_s.test(i.decoderConfig.codec))throw new TypeError("Video chunk metadata decoder configuration codec string for AVC must be a valid AVC codec string as specified in Section 3.4 of RFC 6381.")}else if(i.decoderConfig.codec.startsWith("hev1")||i.decoderConfig.codec.startsWith("hvc1")){if(!As.test(i.decoderConfig.codec))throw new TypeError("Video chunk metadata decoder configuration codec string for HEVC must be a valid HEVC codec string as specified in Section E.3 of ISO 14496-15.")}else if(i.decoderConfig.codec.startsWith("vp8")){if(i.decoderConfig.codec!=="vp8")throw new TypeError('Video chunk metadata decoder configuration codec string for VP8 must be "vp8".')}else if(i.decoderConfig.codec.startsWith("vp09")){if(!Rs.test(i.decoderConfig.codec))throw new TypeError('Video chunk metadata decoder configuration codec string for VP9 must be a valid VP9 codec string as specified in Section "Codecs Parameter String" of https://www.webmproject.org/vp9/mp4/.')}else if(i.decoderConfig.codec.startsWith("av01")&&!Fs.test(i.decoderConfig.codec))throw new TypeError('Video chunk metadata decoder configuration codec string for AV1 must be a valid AV1 codec string as specified in Section "Codecs Parameter String" of https://aomediacodec.github.io/av1-isobmff/.')},Os=["mp4a","mp3","opus","vorbis","flac","ulaw","alaw","pcm"],Se=i=>{if(!i)throw new TypeError("Audio chunk metadata must be provided.");if(typeof i!="object")throw new TypeError("Audio chunk metadata must be an object.");if(!i.decoderConfig)throw new TypeError("Audio chunk metadata must include a decoder configuration.");if(typeof i.decoderConfig!="object")throw new TypeError("Audio chunk metadata decoder configuration must be an object.");if(typeof i.decoderConfig.codec!="string")throw new TypeError("Audio chunk metadata decoder configuration must specify a codec string.");if(!Os.some(e=>i.decoderConfig.codec.startsWith(e)))throw new TypeError("Audio chunk metadata decoder configuration codec string must be a valid audio codec string as specified in the WebCodecs Codec Registry.");if(!Number.isInteger(i.decoderConfig.sampleRate)||i.decoderConfig.sampleRate<=0)throw new TypeError("Audio chunk metadata decoder configuration must specify a valid sampleRate (positive integer).");if(!Number.isInteger(i.decoderConfig.numberOfChannels)||i.decoderConfig.numberOfChannels<=0)throw new TypeError("Audio chunk metadata decoder configuration must specify a valid numberOfChannels (positive integer).");if(i.decoderConfig.description!==void 0&&!ft(i.decoderConfig.description))throw new TypeError("Audio chunk metadata decoder configuration description, when defined, must be an ArrayBuffer or an ArrayBuffer view.");if(i.decoderConfig.codec.startsWith("mp4a")&&i.decoderConfig.codec!=="mp4a.69"&&i.decoderConfig.codec!=="mp4a.6B"&&i.decoderConfig.codec!=="mp4a.6b"){if(!["mp4a.40.2","mp4a.40.02","mp4a.40.5","mp4a.40.05","mp4a.40.29","mp4a.67"].includes(i.decoderConfig.codec))throw new TypeError("Audio chunk metadata decoder configuration codec string for AAC must be a valid AAC codec string as specified in https://www.w3.org/TR/webcodecs-aac-codec-registration/.");if(!i.decoderConfig.description)throw new TypeError("Audio chunk metadata decoder configuration for AAC must include a description, which is expected to be an AudioSpecificConfig as specified in ISO 14496-3.")}else if(i.decoderConfig.codec.startsWith("mp3")||i.decoderConfig.codec.startsWith("mp4a")){if(i.decoderConfig.codec!=="mp3"&&i.decoderConfig.codec!=="mp4a.69"&&i.decoderConfig.codec!=="mp4a.6B"&&i.decoderConfig.codec!=="mp4a.6b")throw new TypeError('Audio chunk metadata decoder configuration codec string for MP3 must be "mp3", "mp4a.69" or "mp4a.6B".')}else if(i.decoderConfig.codec.startsWith("opus")){if(i.decoderConfig.codec!=="opus")throw new TypeError('Audio chunk metadata decoder configuration codec string for Opus must be "opus".');if(i.decoderConfig.description&&i.decoderConfig.description.byteLength<18)throw new TypeError("Audio chunk metadata decoder configuration description, when specified, is expected to be an Identification Header as specified in Section 5.1 of RFC 7845.")}else if(i.decoderConfig.codec.startsWith("vorbis")){if(i.decoderConfig.codec!=="vorbis")throw new TypeError('Audio chunk metadata decoder configuration codec string for Vorbis must be "vorbis".');if(!i.decoderConfig.description)throw new TypeError("Audio chunk metadata decoder configuration for Vorbis must include a description, which is expected to adhere to the format described in https://www.w3.org/TR/webcodecs-vorbis-codec-registration/.")}else if(i.decoderConfig.codec.startsWith("flac")){if(i.decoderConfig.codec!=="flac")throw new TypeError('Audio chunk metadata decoder configuration codec string for FLAC must be "flac".');if(!i.decoderConfig.description||i.decoderConfig.description.byteLength<42)throw new TypeError("Audio chunk metadata decoder configuration for FLAC must include a description, which is expected to adhere to the format described in https://www.w3.org/TR/webcodecs-flac-codec-registration/.")}else if((i.decoderConfig.codec.startsWith("pcm")||i.decoderConfig.codec.startsWith("ulaw")||i.decoderConfig.codec.startsWith("alaw"))&&!U.includes(i.decoderConfig.codec))throw new TypeError(`Audio chunk metadata decoder configuration codec string for PCM must be one of the supported PCM codecs (${U.join(", ")}).`)},Dr=i=>{if(!i)throw new TypeError("Subtitle metadata must be provided.");if(typeof i!="object")throw new TypeError("Subtitle metadata must be an object.");if(!i.config)throw new TypeError("Subtitle metadata must include a config object.");if(typeof i.config!="object")throw new TypeError("Subtitle metadata config must be an object.");if(typeof i.config.description!="string")throw new TypeError("Subtitle metadata config description must be a string.")};var de=class{constructor(e){this.mutex=new te;this.firstMediaStreamTimestamp=null;this.trackTimestampInfo=new WeakMap;this.output=e}onTrackClose(e){}validateAndNormalizeTimestamp(e,t,r){t+=e.source._timestampOffset;let n=this.trackTimestampInfo.get(e);if(!n){if(!r)throw new Error("First frame must be a key frame.");n={maxTimestamp:t,maxTimestampBeforeLastKeyFrame:t},this.trackTimestampInfo.set(e,n)}if(t<0)throw new Error(`Timestamps must be non-negative (got ${t}s).`);if(r&&(n.maxTimestampBeforeLastKeyFrame=n.maxTimestamp),t<n.maxTimestampBeforeLastKeyFrame)throw new Error(`Timestamps cannot be smaller than the highest timestamp of the previous run (a run begins with a key frame and ends right before the next key frame). Got ${t}s, but highest timestamp is ${n.maxTimestampBeforeLastKeyFrame}s.`);return n.maxTimestamp=Math.max(n.maxTimestamp,t),t}};var Vr=class extends de{constructor(t,r){super(t);this.header=new Uint8Array(7);this.headerBitstream=new N(this.header);this.audioSpecificConfig=null;this.format=r,this.writer=t._writer}async start(){}async getMimeType(){return"audio/aac"}async addEncodedVideoPacket(){throw new Error("ADTS does not support video.")}async addEncodedAudioPacket(t,r,n){let a=await this.mutex.acquire();try{if(this.validateAndNormalizeTimestamp(t,r.timestamp,r.type==="key"),!this.audioSpecificConfig){Se(n);let c=n?.decoderConfig?.description;m(c),this.audioSpecificConfig=$t(K(c));let{objectType:u,frequencyIndex:d,channelConfiguration:l}=this.audioSpecificConfig,f=u-1;this.headerBitstream.writeBits(12,4095),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(2,0),this.headerBitstream.writeBits(1,1),this.headerBitstream.writeBits(2,f),this.headerBitstream.writeBits(4,d),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(3,l),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(1,0),this.headerBitstream.skipBits(13),this.headerBitstream.writeBits(11,2047),this.headerBitstream.writeBits(2,0)}let s=r.data.byteLength+this.header.byteLength;this.headerBitstream.pos=30,this.headerBitstream.writeBits(13,s);let o=this.writer.getPos();if(this.writer.write(this.header),this.writer.write(r.data),this.format._options.onFrame){let c=new Uint8Array(s);c.set(this.header,0),c.set(r.data,this.header.byteLength),this.format._options.onFrame(c,o)}await this.writer.flush()}finally{a()}}async addSubtitleCue(){throw new Error("ADTS does not support subtitles.")}async finalize(){}};var Xt=/(?:(.+?)\n)?((?:\d{2}:)?\d{2}:\d{2}.\d{3})\s+-->\s+((?:\d{2}:)?\d{2}:\d{2}.\d{3})/g,Ms=/^WEBVTT(.|\n)*?\n{2}/,gt=/<(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})>/g,Ur=class{constructor(e){this.preambleText=null;this.preambleEmitted=!1;this.options=e}parse(e){e=e.replaceAll(`\r
`,`
`).replaceAll("\r",`
`),Xt.lastIndex=0;let t;if(!this.preambleText){if(!Ms.test(e))throw new Error("WebVTT preamble incorrect.");t=Xt.exec(e);let r=e.slice(0,t?.index??e.length).trimEnd();if(!r)throw new Error("No WebVTT preamble provided.");this.preambleText=r,t&&(e=e.slice(t.index),Xt.lastIndex=0)}for(;t=Xt.exec(e);){let r=e.slice(0,t.index),n=t[1],a=t.index+t[0].length,s=e.indexOf(`
`,a)+1,o=e.slice(a,s).trim(),c=e.indexOf(`

`,a);c===-1&&(c=e.length);let u=zr(t[2]),l=zr(t[3])-u,f=e.slice(s,c).trim();e=e.slice(c).trimStart(),Xt.lastIndex=0;let h={timestamp:u/1e3,duration:l/1e3,text:f,identifier:n,settings:o,notes:r},p={};this.preambleEmitted||(p.config={description:this.preambleText},this.preambleEmitted=!0),this.options.output(h,p)}}},Bs=/(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})/,zr=i=>{let e=Bs.exec(i);if(!e)throw new Error("Expected match.");return 60*60*1e3*Number(e[1]||"0")+60*1e3*Number(e[2])+1e3*Number(e[3])+Number(e[4])},Nr=i=>{let e=Math.floor(i/36e5),t=Math.floor(i%(60*60*1e3)/(60*1e3)),r=Math.floor(i%(60*1e3)/1e3),n=i%1e3;return e.toString().padStart(2,"0")+":"+t.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")+"."+n.toString().padStart(3,"0")};var Yt=i=>{let e=[],t=0;for(;t<i.length;){let r=-1,n=0;for(let a=t;a<i.length-3;a++){if(i[a]===0&&i[a+1]===0&&i[a+2]===1){r=a,n=3;break}if(a<i.length-4&&i[a]===0&&i[a+1]===0&&i[a+2]===0&&i[a+3]===1){r=a,n=4;break}}if(r===-1)break;if(t>0&&r>t){let a=i.subarray(t,r);a.length>0&&e.push(a)}t=r+n}if(t<i.length){let r=i.subarray(t);r.length>0&&e.push(r)}return e},wn=(i,e)=>{let t=[],r=0,n=new DataView(i.buffer,i.byteOffset,i.byteLength);for(;r+e<=i.length;){let a;e===1?a=n.getUint8(r):e===2?a=n.getUint16(r,!1):e===3?a=(n.getUint16(r,!1)<<8)+n.getUint8(r+2):e===4?a=n.getUint32(r,!1):(ke(e),m(!1)),r+=e;let s=i.subarray(r,r+a);t.push(s),r+=a}return t},ta=i=>{let e=[],t=i.length;for(let r=0;r<t;r++)r+2<t&&i[r]===0&&i[r+1]===0&&i[r+2]===3?(e.push(0,0),r+=2):e.push(i[r]);return new Uint8Array(e)},xn=i=>{let t=Yt(i);if(t.length===0)return null;let r=0;for(let o of t)r+=4+o.byteLength;let n=new Uint8Array(r),a=new DataView(n.buffer),s=0;for(let o of t){let c=o.byteLength;a.setUint32(s,c,!1),s+=4,n.set(o,s),s+=o.byteLength}return n},Lr=i=>i[0]&31,Wr=i=>{try{let e=Yt(i),t=e.filter(f=>Lr(f)===7),r=e.filter(f=>Lr(f)===8),n=e.filter(f=>Lr(f)===13);if(t.length===0||r.length===0)return null;let a=t[0],s=new N(ta(a));if(s.skipBits(1),s.skipBits(2),s.readBits(5)!==7)return console.error("Invalid SPS NAL unit type"),null;let c=s.readAlignedByte(),u=s.readAlignedByte(),d=s.readAlignedByte(),l={configurationVersion:1,avcProfileIndication:c,profileCompatibility:u,avcLevelIndication:d,lengthSizeMinusOne:3,sequenceParameterSets:t,pictureParameterSets:r,chromaFormat:null,bitDepthLumaMinus8:null,bitDepthChromaMinus8:null,sequenceParameterSetExt:null};if(c===100||c===110||c===122||c===144){I(s);let f=I(s);f===3&&s.skipBits(1);let h=I(s),p=I(s);l.chromaFormat=f,l.bitDepthLumaMinus8=h,l.bitDepthChromaMinus8=p,l.sequenceParameterSetExt=n}return l}catch(e){return console.error("Error building AVC Decoder Configuration Record:",e),null}},vn=i=>{let e=[];e.push(i.configurationVersion),e.push(i.avcProfileIndication),e.push(i.profileCompatibility),e.push(i.avcLevelIndication),e.push(252|i.lengthSizeMinusOne&3),e.push(224|i.sequenceParameterSets.length&31);for(let t of i.sequenceParameterSets){let r=t.byteLength;e.push(r>>8),e.push(r&255);for(let n=0;n<r;n++)e.push(t[n])}e.push(i.pictureParameterSets.length);for(let t of i.pictureParameterSets){let r=t.byteLength;e.push(r>>8),e.push(r&255);for(let n=0;n<r;n++)e.push(t[n])}if(i.avcProfileIndication===100||i.avcProfileIndication===110||i.avcProfileIndication===122||i.avcProfileIndication===144){m(i.chromaFormat!==null),m(i.bitDepthLumaMinus8!==null),m(i.bitDepthChromaMinus8!==null),m(i.sequenceParameterSetExt!==null),e.push(252|i.chromaFormat&3),e.push(248|i.bitDepthLumaMinus8&7),e.push(248|i.bitDepthChromaMinus8&7),e.push(i.sequenceParameterSetExt.length);for(let t of i.sequenceParameterSetExt){let r=t.byteLength;e.push(r>>8),e.push(r&255);for(let n=0;n<r;n++)e.push(t[n])}}return new Uint8Array(e)},Tn=32,yn=33,Sn=34,Ds=39,Vs=40,$e=i=>i[0]>>1&63,Hr=i=>{try{let e=Yt(i),t=e.filter(_=>$e(_)===Tn),r=e.filter(_=>$e(_)===yn),n=e.filter(_=>$e(_)===Sn),a=e.filter(_=>$e(_)===Ds||$e(_)===Vs);if(r.length===0||n.length===0)return null;let s=r[0],o=new N(ta(s));o.skipBits(16),o.readBits(4);let c=o.readBits(3),u=o.readBits(1),{general_profile_space:d,general_tier_flag:l,general_profile_idc:f,general_profile_compatibility_flags:h,general_constraint_indicator_flags:p,general_level_idc:k}=Us(o,c);I(o);let g=I(o);g===3&&o.skipBits(1),I(o),I(o),o.readBits(1)&&(I(o),I(o),I(o),I(o));let b=I(o),w=I(o);I(o);let x=o.readBits(1)?0:c;for(let _=x;_<=c;_++)I(o),I(o),I(o);I(o),I(o),I(o),I(o),I(o),I(o),o.readBits(1)&&o.readBits(1)&&zs(o),o.skipBits(1),o.skipBits(1),o.readBits(1)&&(o.skipBits(4),o.skipBits(4),I(o),I(o),o.skipBits(1));let y=I(o);if(Ns(o,y),o.readBits(1)){let _=I(o);for(let A=0;A<_;A++)I(o),o.skipBits(1)}o.skipBits(1),o.skipBits(1);let T=0;o.readBits(1)&&(T=Ws(o,c));let C=0;if(n.length>0){let _=n[0],A=new N(ta(_));A.skipBits(16),I(A),I(A),A.skipBits(1),A.skipBits(1),A.skipBits(3),A.skipBits(1),A.skipBits(1),I(A),I(A),mt(A),A.skipBits(1),A.skipBits(1),A.readBits(1)&&I(A),mt(A),mt(A),A.skipBits(1),A.skipBits(1),A.skipBits(1),A.skipBits(1);let V=A.readBits(1),H=A.readBits(1);!V&&!H?C=0:V&&!H?C=2:!V&&H?C=3:C=0}let P=[...t.length?[{arrayCompleteness:1,nalUnitType:Tn,nalUnits:t}]:[],...r.length?[{arrayCompleteness:1,nalUnitType:yn,nalUnits:r}]:[],...n.length?[{arrayCompleteness:1,nalUnitType:Sn,nalUnits:n}]:[],...a.length?[{arrayCompleteness:1,nalUnitType:$e(a[0]),nalUnits:a}]:[]];return{configurationVersion:1,generalProfileSpace:d,generalTierFlag:l,generalProfileIdc:f,generalProfileCompatibilityFlags:h,generalConstraintIndicatorFlags:p,generalLevelIdc:k,minSpatialSegmentationIdc:T,parallelismType:C,chromaFormatIdc:g,bitDepthLumaMinus8:b,bitDepthChromaMinus8:w,avgFrameRate:0,constantFrameRate:0,numTemporalLayers:c+1,temporalIdNested:u,lengthSizeMinusOne:3,arrays:P}}catch(e){return console.error("Error building HEVC Decoder Configuration Record:",e),null}},Us=(i,e)=>{let t=i.readBits(2),r=i.readBits(1),n=i.readBits(5),a=0;for(let d=0;d<32;d++)a=a<<1|i.readBits(1);let s=new Uint8Array(6);for(let d=0;d<6;d++)s[d]=i.readBits(8);let o=i.readBits(8),c=[],u=[];for(let d=0;d<e;d++)c.push(i.readBits(1)),u.push(i.readBits(1));if(e>0)for(let d=e;d<8;d++)i.skipBits(2);for(let d=0;d<e;d++)c[d]&&i.skipBits(88),u[d]&&i.skipBits(8);return{general_profile_space:t,general_tier_flag:r,general_profile_idc:n,general_profile_compatibility_flags:a,general_constraint_indicator_flags:s,general_level_idc:o}},zs=i=>{for(let e=0;e<4;e++)for(let t=0;t<(e===3?2:6);t++)if(!i.readBits(1))I(i);else{let n=Math.min(64,1<<4+(e<<1));e>1&&mt(i);for(let a=0;a<n;a++)mt(i)}},Ns=(i,e)=>{let t=[];for(let r=0;r<e;r++)t[r]=Ls(i,r,e,t)},Ls=(i,e,t,r)=>{let n=0,a=0,s=0;if(e!==0&&(a=i.readBits(1)),a){if(e===t){let c=I(i);s=e-(c+1)}else s=e-1;i.readBits(1),I(i);let o=r[s]??0;for(let c=0;c<=o;c++)i.readBits(1)||i.readBits(1);n=r[s]}else{let o=I(i),c=I(i);for(let u=0;u<o;u++)I(i),i.readBits(1);for(let u=0;u<c;u++)I(i),i.readBits(1);n=o+c}return n},Ws=(i,e)=>{if(i.readBits(1)&&i.readBits(8)===255&&(i.readBits(16),i.readBits(16)),i.readBits(1)&&i.readBits(1),i.readBits(1)&&(i.readBits(3),i.readBits(1),i.readBits(1)&&(i.readBits(8),i.readBits(8),i.readBits(8))),i.readBits(1)&&(I(i),I(i)),i.readBits(1),i.readBits(1),i.readBits(1),i.readBits(1)&&(I(i),I(i),I(i),I(i)),i.readBits(1)&&(i.readBits(32),i.readBits(32),i.readBits(1)&&I(i),i.readBits(1)&&Hs(i,!0,e)),i.readBits(1)){i.readBits(1),i.readBits(1),i.readBits(1);let t=I(i);return I(i),I(i),I(i),I(i),t}return 0},Hs=(i,e,t)=>{let r=!1,n=!1,a=!1;e&&(r=i.readBits(1)===1,n=i.readBits(1)===1,(r||n)&&(a=i.readBits(1)===1,a&&(i.readBits(8),i.readBits(5),i.readBits(1),i.readBits(5)),i.readBits(4),i.readBits(4),a&&i.readBits(4),i.readBits(5),i.readBits(5),i.readBits(5)));for(let s=0;s<=t;s++){let o=i.readBits(1)===1,c=!0;o||(c=i.readBits(1)===1);let u=!1;c?I(i):u=i.readBits(1)===1;let d=1;u||(d=I(i)+1),r&&Cn(i,d,a),n&&Cn(i,d,a)}},Cn=(i,e,t)=>{for(let r=0;r<e;r++)I(i),I(i),t&&(I(i),I(i)),i.readBits(1)},Pn=i=>{let e=[];e.push(i.configurationVersion),e.push((i.generalProfileSpace&3)<<6|(i.generalTierFlag&1)<<5|i.generalProfileIdc&31),e.push(i.generalProfileCompatibilityFlags>>>24&255),e.push(i.generalProfileCompatibilityFlags>>>16&255),e.push(i.generalProfileCompatibilityFlags>>>8&255),e.push(i.generalProfileCompatibilityFlags&255),e.push(...i.generalConstraintIndicatorFlags),e.push(i.generalLevelIdc&255),e.push(240|i.minSpatialSegmentationIdc>>8&15),e.push(i.minSpatialSegmentationIdc&255),e.push(252|i.parallelismType&3),e.push(252|i.chromaFormatIdc&3),e.push(248|i.bitDepthLumaMinus8&7),e.push(248|i.bitDepthChromaMinus8&7),e.push(i.avgFrameRate>>8&255),e.push(i.avgFrameRate&255),e.push((i.constantFrameRate&3)<<6|(i.numTemporalLayers&7)<<3|(i.temporalIdNested&1)<<2|i.lengthSizeMinusOne&3),e.push(i.arrays.length&255);for(let t of i.arrays){e.push((t.arrayCompleteness&1)<<7|0|t.nalUnitType&63),e.push(t.nalUnits.length>>8&255),e.push(t.nalUnits.length&255);for(let r of t.nalUnits){e.push(r.length>>8&255),e.push(r.length&255);for(let n=0;n<r.length;n++)e.push(r[n])}}return new Uint8Array(e)},Kr=i=>{let e=new N(i);if(e.readBits(2)!==2)return null;let r=e.readBits(1),a=(e.readBits(1)<<1)+r;if(a===3&&e.skipBits(1),e.readBits(1)===1||e.readBits(1)!==0||(e.skipBits(2),e.readBits(24)!==4817730))return null;let u=8;a>=2&&(u=e.readBits(1)?12:10);let d=e.readBits(3),l=0,f=0;if(d!==7)if(f=e.readBits(1),a===1||a===3){let C=e.readBits(1),P=e.readBits(1);l=!C&&!P?3:C&&!P?2:1,e.skipBits(1)}else l=1;else l=3,f=1;let h=e.readBits(16),p=e.readBits(16),k=h+1,g=p+1,b=k*g,w=z(Oe).level;for(let T of Oe)if(b<=T.maxPictureSize){w=T.level;break}return{profile:a,level:w,bitDepth:u,chromaSubsampling:l,videoFullRangeFlag:f,colourPrimaries:d===2?1:d===1?6:2,transferCharacteristics:d===2?1:d===1?6:2,matrixCoefficients:d===7?0:d===2?1:d===1?6:2}};function*En(i){let e=new N(i),t=()=>{let r=0;for(let n=0;n<8;n++){let a=e.readAlignedByte();if(r|=(a&127)<<n*7,!(a&128))break;if(n===7&&a&128)return null}return r>=2**32-1?null:r};for(;e.getBitsLeft()>=8;){e.skipBits(1);let r=e.readBits(4),n=e.readBits(1),a=e.readBits(1);e.skipBits(1),n&&e.skipBits(8);let s;if(a){let o=t();if(o===null)return;s=o}else s=Math.floor(e.getBitsLeft()/8);m(e.pos%8===0),yield{type:r,data:i.subarray(e.pos/8,e.pos/8+s)},e.skipBits(s*8)}}var qr=i=>{for(let{type:e,data:t}of En(i)){if(e!==1)continue;let r=new N(t),n=r.readBits(3),a=r.readBits(1),s=r.readBits(1),o=0,c=0,u=0;if(s)o=r.readBits(5);else{if(r.readBits(1)&&(r.skipBits(32),r.skipBits(32),r.readBits(1)))return null;let b=r.readBits(1);b&&(u=r.readBits(5),r.skipBits(32),r.skipBits(5),r.skipBits(5));let w=r.readBits(5);for(let S=0;S<=w;S++){r.skipBits(12);let x=r.readBits(5);if(S===0&&(o=x),x>7){let T=r.readBits(1);S===0&&(c=T)}if(b&&r.readBits(1)){let C=u+1;r.skipBits(C),r.skipBits(C),r.skipBits(1)}r.readBits(1)&&r.skipBits(4)}}let d=r.readBits(1),l=8;n===2&&d?l=r.readBits(1)?12:10:n<=2&&(l=d?10:8);let f=0;n!==1&&(f=r.readBits(1));let h=1,p=1,k=0;return f||(n===0?(h=1,p=1):n===1?(h=0,p=0):l===12&&(h=r.readBits(1),h&&(p=r.readBits(1))),h&&p&&(k=r.readBits(2))),{profile:n,level:o,tier:c,bitDepth:l,monochrome:f,chromaSubsamplingX:h,chromaSubsamplingY:p,chromaSamplePosition:k}}return null},ze=i=>{let e=re(i),t=e.getUint8(9),r=e.getUint16(10,!0),n=e.getUint32(12,!0),a=e.getInt16(16,!0),s=e.getUint8(18),o=null;return s&&(o=i.subarray(19,21+t)),{outputChannelCount:t,preSkip:r,inputSampleRate:n,outputGain:a,channelMappingFamily:s,channelMappingTable:o}},Ks=[480,960,1920,2880,480,960,1920,2880,480,960,1920,2880,480,960,480,960,120,240,480,960,120,240,480,960,120,240,480,960,120,240,480,960],In=i=>{let e=i[0]>>3;return{durationInSamples:Ks[e]}},Qr=i=>{if(i.length<7)throw new Error("Setup header is too short.");if(i[0]!==5)throw new Error("Wrong packet type in Setup header.");if(String.fromCharCode(...i.slice(1,7))!=="vorbis")throw new Error("Invalid packet signature in Setup header.");let t=i.length,r=new Uint8Array(t);for(let l=0;l<t;l++)r[l]=i[t-1-l];let n=new N(r),a=0;for(;n.getBitsLeft()>97;)if(n.readBits(1)===1){a=n.pos;break}if(a===0)throw new Error("Invalid Setup header: framing bit not found.");let s=0,o=!1,c=0;for(;n.getBitsLeft()>=97;){let l=n.pos,f=n.readBits(8),h=n.readBits(16),p=n.readBits(16);if(f>63||h!==0||p!==0){n.pos=l;break}if(n.skipBits(1),s++,s>64)break;n.clone().readBits(6)+1===s&&(o=!0,c=s)}if(!o)throw new Error("Invalid Setup header: mode header not found.");if(c>63)throw new Error(`Unsupported mode count: ${c}.`);let u=c;n.pos=0,n.skipBits(a);let d=Array(u).fill(0);for(let l=u-1;l>=0;l--)n.skipBits(40),d[l]=n.readBits(1);return{modeBlockflags:d}},_n=async(i,e)=>{switch(m(i.codec),i.codec){case"avc":{let t=await i.getDecoderConfig();m(t);let r;if(t.description){let o=(K(t.description)[4]&3)+1;r=wn(e.data,o)}else r=Yt(e.data);return r.some(a=>Lr(a)===5)?"key":"delta"}case"hevc":{let t=await i.getDecoderConfig();m(t);let r;if(t.description){let o=(K(t.description)[21]&3)+1;r=wn(e.data,o)}else r=Yt(e.data);return r.some(a=>{let s=$e(a);return 16<=s&&s<=23})?"key":"delta"}case"vp8":return(e.data[0]&1)===0?"key":"delta";case"vp9":{let t=new N(e.data);if(t.readBits(2)!==2)return null;let r=t.readBits(1);return(t.readBits(1)<<1)+r===3&&t.skipBits(1),t.readBits(1)?null:t.readBits(1)===0?"key":"delta"}case"av1":{let t=!1;for(let{type:r,data:n}of En(e.data))if(r===1){let a=new N(n);a.skipBits(4),t=!!a.readBits(1)}else if(r===3||r===6||r===7){if(t)return"key";let a=new N(n);return a.readBits(1)?null:a.readBits(2)===0?"key":"delta"}return null}default:ke(i.codec),m(!1)}};var Zt=class{constructor(e){this.writer=e;this.helper=new Uint8Array(8);this.helperView=new DataView(this.helper.buffer);this.offsets=new WeakMap}writeU32(e){this.helperView.setUint32(0,e,!1),this.writer.write(this.helper.subarray(0,4))}writeU64(e){this.helperView.setUint32(0,Math.floor(e/2**32),!1),this.helperView.setUint32(4,e,!1),this.writer.write(this.helper.subarray(0,8))}writeAscii(e){for(let t=0;t<e.length;t++)this.helperView.setUint8(t%8,e.charCodeAt(t)),t%8===7&&this.writer.write(this.helper);e.length%8!==0&&this.writer.write(this.helper.subarray(0,e.length%8))}writeBox(e){if(this.offsets.set(e,this.writer.getPos()),e.contents&&!e.children)this.writeBoxHeader(e,e.size??e.contents.byteLength+8),this.writer.write(e.contents);else{let t=this.writer.getPos();if(this.writeBoxHeader(e,0),e.contents&&this.writer.write(e.contents),e.children)for(let a of e.children)a&&this.writeBox(a);let r=this.writer.getPos(),n=e.size??r-t;this.writer.seek(t),this.writeBoxHeader(e,n),this.writer.seek(r)}}writeBoxHeader(e,t){this.writeU32(e.largeSize?1:t),this.writeAscii(e.type),e.largeSize&&this.writeU64(t)}measureBoxHeader(e){return 8+(e.largeSize?8:0)}patchBox(e){let t=this.offsets.get(e);m(t!==void 0);let r=this.writer.getPos();this.writer.seek(t),this.writeBox(e),this.writer.seek(r)}measureBox(e){if(e.contents&&!e.children)return this.measureBoxHeader(e)+e.contents.byteLength;{let t=this.measureBoxHeader(e);if(e.contents&&(t+=e.contents.byteLength),e.children)for(let r of e.children)r&&(t+=this.measureBox(r));return t}}},O=new Uint8Array(8),xe=new DataView(O.buffer),q=i=>[(i%256+256)%256],R=i=>(xe.setUint16(0,i,!1),[O[0],O[1]]),Rn=i=>(xe.setInt16(0,i,!1),[O[0],O[1]]),Fn=i=>(xe.setUint32(0,i,!1),[O[1],O[2],O[3]]),v=i=>(xe.setUint32(0,i,!1),[O[0],O[1],O[2],O[3]]),Le=i=>(xe.setInt32(0,i,!1),[O[0],O[1],O[2],O[3]]),Ge=i=>(xe.setUint32(0,Math.floor(i/2**32),!1),xe.setUint32(4,i,!1),[O[0],O[1],O[2],O[3],O[4],O[5],O[6],O[7]]),On=i=>(xe.setInt16(0,2**8*i,!1),[O[0],O[1]]),Me=i=>(xe.setInt32(0,2**16*i,!1),[O[0],O[1],O[2],O[3]]),ra=i=>(xe.setInt32(0,2**30*i,!1),[O[0],O[1],O[2],O[3]]),ia=(i,e)=>{let t=[],r=i;do{let n=r&127;r>>=7,t.length>0&&(n|=128),t.push(n),e!==void 0&&e--}while(r>0||e);return t.reverse()},ae=(i,e=!1)=>{let t=Array(i.length).fill(null).map((r,n)=>i.charCodeAt(n));return e&&t.push(0),t},na=i=>{let e=null;for(let t of i)(!e||t.timestamp>e.timestamp)&&(e=t);return e},Mn=i=>{let e=i*(Math.PI/180),t=Math.round(Math.cos(e)),r=Math.round(Math.sin(e));return[t,r,0,-r,t,0,0,0,1]},Bn=Mn(0),Dn=i=>[Me(i[0]),Me(i[1]),ra(i[2]),Me(i[3]),Me(i[4]),ra(i[5]),Me(i[6]),Me(i[7]),ra(i[8])],F=(i,e,t)=>({type:i,contents:e&&new Uint8Array(e.flat(10)),children:t}),D=(i,e,t,r,n)=>F(i,[q(e),Fn(t),r??[]],n),Vn=i=>i.isQuickTime?F("ftyp",[ae("qt  "),v(512),ae("qt  ")]):i.fragmented?F("ftyp",[ae("iso5"),v(512),ae("iso5"),ae("iso6"),ae("mp41")]):F("ftyp",[ae("isom"),v(512),ae("isom"),i.holdsAvc?ae("avc1"):[],ae("mp41")]),$r=i=>({type:"mdat",largeSize:i}),Jt=(i,e,t=!1)=>F("moov",void 0,[qs(e,i),...i.map(r=>Qs(r,e)),t?_o(i):null]),qs=(i,e)=>{let t=Y(Math.max(0,...e.filter(s=>s.samples.length>0).map(s=>{let o=na(s.samples);return o.timestamp+o.duration})),jr),r=Math.max(0,...e.map(s=>s.track.id))+1,n=!je(i)||!je(t),a=n?Ge:v;return D("mvhd",+n,0,[a(i),a(i),v(jr),a(t),Me(1),On(1),Array(10).fill(0),Dn(Bn),Array(24).fill(0),v(r)])},Qs=(i,e)=>{let t=Kn(i);return F("trak",void 0,[js(i,e),$s(i,e),t.name!==void 0?F("udta",void 0,[F("\xA9nam",[...oe.encode(t.name)])]):null])},js=(i,e)=>{let t=na(i.samples),r=Y(t?t.timestamp+t.duration:0,jr),n=!je(e)||!je(r),a=n?Ge:v,s;if(i.type==="video"){let o=i.track.metadata.rotation;s=Mn(o??0)}else s=Bn;return D("tkhd",+n,3,[a(e),a(e),v(i.track.id),v(0),a(r),Array(8).fill(0),R(0),R(i.track.id),On(i.type==="audio"?1:0),R(0),Dn(s),Me(i.type==="video"?i.info.width:0),Me(i.type==="video"?i.info.height:0)])},$s=(i,e)=>F("mdia",void 0,[Gs(i,e),Zs(!0,Xs[i.type],Ys[i.type]),Js(i)]),Gs=(i,e)=>{let t=na(i.samples),r=Y(t?t.timestamp+t.duration:0,i.timescale),n=!je(e)||!je(r),a=n?Ge:v,s=0;for(let o of i.track.metadata.languageCode??Q)s<<=5,s+=o.charCodeAt(0)-96;return D("mdhd",+n,0,[a(e),a(e),v(i.timescale),a(r),R(s),R(0)])},Xs={video:"vide",audio:"soun",subtitle:"text"},Ys={video:"MediabunnyVideoHandler",audio:"MediabunnySoundHandler",subtitle:"MediabunnyTextHandler"},Zs=(i,e,t)=>D("hdlr",0,0,[i?ae("mhlr"):v(0),ae(e),v(0),v(0),v(0),ae(t,!0)]),Js=i=>F("minf",void 0,[io[i.type](),ao(),oo(i)]),eo=()=>D("vmhd",0,1,[R(0),R(0),R(0),R(0)]),to=()=>D("smhd",0,0,[R(0),R(0)]),ro=()=>D("nmhd",0,0),io={video:eo,audio:to,subtitle:ro},ao=()=>F("dinf",void 0,[no()]),no=()=>D("dref",0,0,[v(1)],[so()]),so=()=>D("url ",0,1),oo=i=>{let e=i.compositionTimeOffsetTable.length>1||i.compositionTimeOffsetTable.some(t=>t.sampleCompositionTimeOffset!==0);return F("stbl",void 0,[co(i),So(i),e?Eo(i):null,e?Io(i):null,xo(i),vo(i),Po(i),Co(i)])},co=i=>{let e;if(i.type==="video")e=uo(Uo[i.track.source._codec],i);else if(i.type==="audio"){let t=Hn(i.track.source._codec,i.muxer.isQuickTime);m(t),e=ho(t,i)}else i.type==="subtitle"&&(e=To(Lo[i.track.source._codec],i));return m(e),D("stsd",0,0,[v(1)],[e])},uo=(i,e)=>F(i,[Array(6).fill(0),R(1),R(0),R(0),Array(12).fill(0),R(e.info.width),R(e.info.height),v(4718592),v(4718592),v(0),R(1),Array(32).fill(0),R(24),Rn(65535)],[zo[e.track.source._codec](e),Ir(e.info.decoderConfig.colorSpace)?lo(e):null]),lo=i=>F("colr",[ae("nclx"),R(_e[i.info.decoderConfig.colorSpace.primaries]),R(Ae[i.info.decoderConfig.colorSpace.transfer]),R(Re[i.info.decoderConfig.colorSpace.matrix]),q((i.info.decoderConfig.colorSpace.fullRange?1:0)<<7)]),mo=i=>i.info.decoderConfig&&F("avcC",[...K(i.info.decoderConfig.description)]),fo=i=>i.info.decoderConfig&&F("hvcC",[...K(i.info.decoderConfig.description)]),An=i=>{if(!i.info.decoderConfig)return null;let e=i.info.decoderConfig,t=e.codec.split("."),r=Number(t[1]),n=Number(t[2]),a=Number(t[3]),s=t[4]?Number(t[4]):1,o=t[8]?Number(t[8]):Number(e.colorSpace?.fullRange??0),c=(a<<4)+(s<<1)+o,u=t[5]?Number(t[5]):e.colorSpace?.primaries?_e[e.colorSpace.primaries]:2,d=t[6]?Number(t[6]):e.colorSpace?.transfer?Ae[e.colorSpace.transfer]:2,l=t[7]?Number(t[7]):e.colorSpace?.matrix?Re[e.colorSpace.matrix]:2;return D("vpcC",1,0,[q(r),q(n),q(c),q(u),q(d),q(l),R(0)])},po=i=>F("av1C",Fr(i.info.decoderConfig.codec)),ho=(i,e)=>{let t=0,r,n=16;if(U.includes(e.track.source._codec)){let a=e.track.source._codec,{sampleSize:s}=ee(a);n=8*s,n>16&&(t=1)}return t===0?r=[Array(6).fill(0),R(1),R(t),R(0),v(0),R(e.info.numberOfChannels),R(n),R(0),R(0),R(e.info.sampleRate<2**16?e.info.sampleRate:0),R(0)]:r=[Array(6).fill(0),R(1),R(t),R(0),v(0),R(e.info.numberOfChannels),R(Math.min(n,16)),R(0),R(0),R(e.info.sampleRate<2**16?e.info.sampleRate:0),R(0),v(1),v(n/8),v(e.info.numberOfChannels*n/8),v(2)],F(i,r,[No(e.track.source._codec,e.muxer.isQuickTime)?.(e)??null])},aa=i=>{let e;switch(i.track.source._codec){case"aac":e=64;break;case"mp3":e=107;break;case"vorbis":e=221;break;default:throw new Error(`Unhandled audio codec: ${i.track.source._codec}`)}let t=[...q(e),...q(21),...Fn(0),...v(0),...v(0)];if(i.info.decoderConfig.description){let r=K(i.info.decoderConfig.description);t=[...t,...q(5),...ia(r.byteLength),...r]}return t=[...R(1),...q(0),...q(4),...ia(t.length),...t,...q(6),...q(1),...q(2)],t=[...q(3),...ia(t.length),...t],D("esds",0,0,t)},Ne=i=>F("wave",void 0,[go(i),bo(i),F("\0\0\0\0")]),go=i=>F("frma",[ae(Hn(i.track.source._codec,i.muxer.isQuickTime))]),bo=i=>{let{littleEndian:e}=ee(i.track.source._codec);return F("enda",[R(+e)])},ko=i=>{let e=i.info.numberOfChannels,t=3840,r=i.info.sampleRate,n=0,a=0,s=new Uint8Array(0),o=i.info.decoderConfig?.description;if(o){m(o.byteLength>=18);let c=K(o),u=ze(c);e=u.outputChannelCount,t=u.preSkip,r=u.inputSampleRate,n=u.outputGain,a=u.channelMappingFamily,u.channelMappingTable&&(s=u.channelMappingTable)}return F("dOps",[q(0),q(e),R(t),v(r),Rn(n),q(a),...s])},wo=i=>{let e=i.info.decoderConfig?.description;m(e);let t=K(e);return D("dfLa",0,0,[...t.subarray(4)])},Ce=i=>{let{littleEndian:e,sampleSize:t}=ee(i.track.source._codec),r=+e;return D("pcmC",0,0,[q(r),q(8*t)])},To=(i,e)=>F(i,[Array(6).fill(0),R(1)],[Wo[e.track.source._codec](e)]),yo=i=>F("vttC",[...oe.encode(i.info.config.description)]);var So=i=>D("stts",0,0,[v(i.timeToSampleTable.length),i.timeToSampleTable.map(e=>[v(e.sampleCount),v(e.sampleDelta)])]),Co=i=>{if(i.samples.every(t=>t.type==="key"))return null;let e=[...i.samples.entries()].filter(([,t])=>t.type==="key");return D("stss",0,0,[v(e.length),e.map(([t])=>v(t+1))])},xo=i=>D("stsc",0,0,[v(i.compactlyCodedChunkTable.length),i.compactlyCodedChunkTable.map(e=>[v(e.firstChunk),v(e.samplesPerChunk),v(1)])]),vo=i=>{if(i.type==="audio"&&i.info.requiresPcmTransformation){let{sampleSize:e}=ee(i.track.source._codec);return D("stsz",0,0,[v(e*i.info.numberOfChannels),v(i.samples.reduce((t,r)=>t+Y(r.duration,i.timescale),0))])}return D("stsz",0,0,[v(0),v(i.samples.length),i.samples.map(e=>v(e.size))])},Po=i=>i.finalizedChunks.length>0&&z(i.finalizedChunks).offset>=2**32?D("co64",0,0,[v(i.finalizedChunks.length),i.finalizedChunks.map(e=>Ge(e.offset))]):D("stco",0,0,[v(i.finalizedChunks.length),i.finalizedChunks.map(e=>v(e.offset))]),Eo=i=>D("ctts",1,0,[v(i.compositionTimeOffsetTable.length),i.compositionTimeOffsetTable.map(e=>[v(e.sampleCount),Le(e.sampleCompositionTimeOffset)])]),Io=i=>{let e=1/0,t=-1/0,r=1/0,n=-1/0;m(i.compositionTimeOffsetTable.length>0),m(i.samples.length>0);for(let s=0;s<i.compositionTimeOffsetTable.length;s++){let o=i.compositionTimeOffsetTable[s];e=Math.min(e,o.sampleCompositionTimeOffset),t=Math.max(t,o.sampleCompositionTimeOffset)}for(let s=0;s<i.samples.length;s++){let o=i.samples[s];r=Math.min(r,Y(o.timestamp,i.timescale)),n=Math.max(n,Y(o.timestamp+o.duration,i.timescale))}let a=Math.max(-e,0);return n>=2**31?null:D("cslg",0,0,[Le(a),Le(e),Le(t),Le(r),Le(n)])},_o=i=>F("mvex",void 0,i.map(Ao)),Ao=i=>D("trex",0,0,[v(i.track.id),v(1),v(0),v(0),v(0)]),sa=(i,e)=>F("moof",void 0,[Ro(i),...e.map(Fo)]),Ro=i=>D("mfhd",0,0,[v(i)]),Un=i=>{let e=0,t=0,r=0,n=0,a=i.type==="delta";return t|=+a,a?e|=1:e|=2,e<<24|t<<16|r<<8|n},Fo=i=>F("traf",void 0,[Oo(i),Mo(i),Bo(i)]),Oo=i=>{m(i.currentChunk);let e=0;e|=8,e|=16,e|=32,e|=131072;let t=i.currentChunk.samples[1]??i.currentChunk.samples[0],r={duration:t.timescaleUnitsToNextSample,size:t.size,flags:Un(t)};return D("tfhd",0,e,[v(i.track.id),v(r.duration),v(r.size),v(r.flags)])},Mo=i=>(m(i.currentChunk),D("tfdt",1,0,[Ge(Y(i.currentChunk.startTimestamp,i.timescale))])),Bo=i=>{m(i.currentChunk);let e=i.currentChunk.samples.map(k=>k.timescaleUnitsToNextSample),t=i.currentChunk.samples.map(k=>k.size),r=i.currentChunk.samples.map(Un),n=i.currentChunk.samples.map(k=>Y(k.timestamp-k.decodeTimestamp,i.timescale)),a=new Set(e),s=new Set(t),o=new Set(r),c=new Set(n),u=o.size===2&&r[0]!==r[1],d=a.size>1,l=s.size>1,f=!u&&o.size>1,h=c.size>1||[...c].some(k=>k!==0),p=0;return p|=1,p|=4*+u,p|=256*+d,p|=512*+l,p|=1024*+f,p|=2048*+h,D("trun",1,p,[v(i.currentChunk.samples.length),v(i.currentChunk.offset-i.currentChunk.moofOffset||0),u?v(r[0]):[],i.currentChunk.samples.map((k,g)=>[d?v(e[g]):[],l?v(t[g]):[],f?v(r[g]):[],h?Le(n[g]):[]])])},zn=i=>F("mfra",void 0,[...i.map(Do),Vo()]),Do=(i,e)=>D("tfra",1,0,[v(i.track.id),v(63),v(i.finalizedChunks.length),i.finalizedChunks.map(r=>[Ge(Y(r.samples[0].timestamp,i.timescale)),Ge(r.moofOffset),v(e+1),v(1),v(1)])]),Vo=()=>D("mfro",0,0,[v(0)]),Nn=()=>F("vtte"),Ln=(i,e,t,r,n)=>F("vttc",void 0,[n!==null?F("vsid",[Le(n)]):null,t!==null?F("iden",[...oe.encode(t)]):null,e!==null?F("ctim",[...oe.encode(Nr(e))]):null,r!==null?F("sttg",[...oe.encode(r)]):null,F("payl",[...oe.encode(i)])]),Wn=i=>F("vtta",[...oe.encode(i)]),Uo={avc:"avc1",hevc:"hvc1",vp8:"vp08",vp9:"vp09",av1:"av01"},zo={avc:mo,hevc:fo,vp8:An,vp9:An,av1:po},Hn=(i,e)=>{switch(i){case"aac":return"mp4a";case"mp3":return"mp4a";case"opus":return"Opus";case"vorbis":return"mp4a";case"flac":return"fLaC";case"ulaw":return"ulaw";case"alaw":return"alaw";case"pcm-u8":return"raw ";case"pcm-s8":return"sowt"}if(e)switch(i){case"pcm-s16":return"sowt";case"pcm-s16be":return"twos";case"pcm-s24":return"in24";case"pcm-s24be":return"in24";case"pcm-s32":return"in32";case"pcm-s32be":return"in32";case"pcm-f32":return"fl32";case"pcm-f32be":return"fl32";case"pcm-f64":return"fl64";case"pcm-f64be":return"fl64"}else switch(i){case"pcm-s16":return"ipcm";case"pcm-s16be":return"ipcm";case"pcm-s24":return"ipcm";case"pcm-s24be":return"ipcm";case"pcm-s32":return"ipcm";case"pcm-s32be":return"ipcm";case"pcm-f32":return"fpcm";case"pcm-f32be":return"fpcm";case"pcm-f64":return"fpcm";case"pcm-f64be":return"fpcm"}},No=(i,e)=>{switch(i){case"aac":return aa;case"mp3":return aa;case"opus":return ko;case"vorbis":return aa;case"flac":return wo}if(e)switch(i){case"pcm-s24":return Ne;case"pcm-s24be":return Ne;case"pcm-s32":return Ne;case"pcm-s32be":return Ne;case"pcm-f32":return Ne;case"pcm-f32be":return Ne;case"pcm-f64":return Ne;case"pcm-f64be":return Ne}else switch(i){case"pcm-s16":return Ce;case"pcm-s16be":return Ce;case"pcm-s24":return Ce;case"pcm-s24be":return Ce;case"pcm-s32":return Ce;case"pcm-s32be":return Ce;case"pcm-f32":return Ce;case"pcm-f32be":return Ce;case"pcm-f64":return Ce;case"pcm-f64be":return Ce}return null},Lo={webvtt:"wvtt"},Wo={webvtt:yo};var Gr=class{constructor(){this.ensureMonotonicity=!1;this.trackedWrites=null;this.trackedStart=-1;this.trackedEnd=-1}start(){}maybeTrackWrites(e){if(!this.trackedWrites)return;let t=this.getPos();if(t<this.trackedStart){if(t+e.byteLength<=this.trackedStart)return;e=e.subarray(this.trackedStart-t),t=0}let r=t+e.byteLength-this.trackedStart,n=this.trackedWrites.byteLength;for(;n<r;)n*=2;if(n!==this.trackedWrites.byteLength){let a=new Uint8Array(n);a.set(this.trackedWrites,0),this.trackedWrites=a}this.trackedWrites.set(e,t-this.trackedStart),this.trackedEnd=Math.max(this.trackedEnd,t+e.byteLength)}startTrackingWrites(){this.trackedWrites=new Uint8Array(2**10),this.trackedStart=this.getPos(),this.trackedEnd=this.trackedStart}stopTrackingWrites(){if(!this.trackedWrites)throw new Error("Internal error: Can't get tracked writes since nothing was tracked.");let t={data:this.trackedWrites.subarray(0,this.trackedEnd-this.trackedStart),start:this.trackedStart,end:this.trackedEnd};return this.trackedWrites=null,t}},oa=2**16,ca=2**32,bt=class extends Gr{constructor(t){super();this.pos=0;this.maxPos=0;if(this.target=t,this.supportsResize="resize"in new ArrayBuffer(0),this.supportsResize)try{this.buffer=new ArrayBuffer(oa,{maxByteLength:ca})}catch{this.buffer=new ArrayBuffer(oa),this.supportsResize=!1}else this.buffer=new ArrayBuffer(oa);this.bytes=new Uint8Array(this.buffer)}ensureSize(t){let r=this.buffer.byteLength;for(;r<t;)r*=2;if(r!==this.buffer.byteLength){if(r>ca)throw new Error(`ArrayBuffer exceeded maximum size of ${ca} bytes. Please consider using another target.`);if(this.supportsResize)this.buffer.resize(r);else{let n=new ArrayBuffer(r),a=new Uint8Array(n);a.set(this.bytes,0),this.buffer=n,this.bytes=a}}}write(t){this.maybeTrackWrites(t),this.ensureSize(this.pos+t.byteLength),this.bytes.set(t,this.pos),this.pos+=t.byteLength,this.maxPos=Math.max(this.maxPos,this.pos)}seek(t){this.pos=t}getPos(){return this.pos}async flush(){}async finalize(){this.ensureSize(this.pos),this.target.buffer=this.buffer.slice(0,Math.max(this.maxPos,this.pos))}async close(){}getSlice(t,r){return this.bytes.slice(t,r)}},Ho=2**24,Ko=2,Xr=class extends Gr{constructor(t){super();this.pos=0;this.sections=[];this.lastWriteEnd=0;this.lastFlushEnd=0;this.writer=null;this.chunks=[];this.target=t,this.chunked=t._options.chunked??!1,this.chunkSize=t._options.chunkSize??Ho}start(){this.writer=this.target._writable.getWriter()}write(t){if(this.pos>this.lastWriteEnd){let r=this.pos-this.lastWriteEnd;this.pos=this.lastWriteEnd,this.write(new Uint8Array(r))}this.maybeTrackWrites(t),this.sections.push({data:t.slice(),start:this.pos}),this.pos+=t.byteLength,this.lastWriteEnd=Math.max(this.lastWriteEnd,this.pos)}seek(t){this.pos=t}getPos(){return this.pos}async flush(){if(this.pos>this.lastWriteEnd){let n=this.pos-this.lastWriteEnd;this.pos=this.lastWriteEnd,this.write(new Uint8Array(n))}if(m(this.writer),this.sections.length===0)return;let t=[],r=[...this.sections].sort((n,a)=>n.start-a.start);t.push({start:r[0].start,size:r[0].data.byteLength});for(let n=1;n<r.length;n++){let a=t[t.length-1],s=r[n];s.start<=a.start+a.size?a.size=Math.max(a.size,s.start+s.data.byteLength-a.start):t.push({start:s.start,size:s.data.byteLength})}for(let n of t){n.data=new Uint8Array(n.size);for(let a of this.sections)n.start<=a.start&&a.start<n.start+n.size&&n.data.set(a.data,a.start-n.start);if(this.writer.desiredSize!==null&&this.writer.desiredSize<=0&&await this.writer.ready,this.chunked)this.writeDataIntoChunks(n.data,n.start),this.tryToFlushChunks();else{if(this.ensureMonotonicity&&n.start!==this.lastFlushEnd)throw new Error("Internal error: Monotonicity violation.");this.writer.write({type:"write",data:n.data,position:n.start}),this.lastFlushEnd=n.start+n.data.byteLength}}this.sections.length=0}writeDataIntoChunks(t,r){let n=this.chunks.findIndex(u=>u.start<=r&&r<u.start+this.chunkSize);n===-1&&(n=this.createChunk(r));let a=this.chunks[n],s=r-a.start,o=t.subarray(0,Math.min(this.chunkSize-s,t.byteLength));a.data.set(o,s);let c={start:s,end:s+o.byteLength};if(this.insertSectionIntoChunk(a,c),a.written[0].start===0&&a.written[0].end===this.chunkSize&&(a.shouldFlush=!0),this.chunks.length>Ko){for(let u=0;u<this.chunks.length-1;u++)this.chunks[u].shouldFlush=!0;this.tryToFlushChunks()}o.byteLength<t.byteLength&&this.writeDataIntoChunks(t.subarray(o.byteLength),r+o.byteLength)}insertSectionIntoChunk(t,r){let n=0,a=t.written.length-1,s=-1;for(;n<=a;){let o=Math.floor(n+(a-n+1)/2);t.written[o].start<=r.start?(n=o+1,s=o):a=o-1}for(t.written.splice(s+1,0,r),(s===-1||t.written[s].end<r.start)&&s++;s<t.written.length-1&&t.written[s].end>=t.written[s+1].start;)t.written[s].end=Math.max(t.written[s].end,t.written[s+1].end),t.written.splice(s+1,1)}createChunk(t){let n={start:Math.floor(t/this.chunkSize)*this.chunkSize,data:new Uint8Array(this.chunkSize),written:[],shouldFlush:!1};return this.chunks.push(n),this.chunks.sort((a,s)=>a.start-s.start),this.chunks.indexOf(n)}tryToFlushChunks(t=!1){m(this.writer);for(let r=0;r<this.chunks.length;r++){let n=this.chunks[r];if(!(!n.shouldFlush&&!t)){for(let a of n.written){let s=n.start+a.start;if(this.ensureMonotonicity&&s!==this.lastFlushEnd)throw new Error("Internal error: Monotonicity violation.");this.writer.write({type:"write",data:n.data.subarray(a.start,a.end),position:s}),this.lastFlushEnd=n.start+a.end}this.chunks.splice(r--,1)}}}finalize(){return this.chunked&&this.tryToFlushChunks(!0),m(this.writer),this.writer.close()}async close(){return this.writer?.close()}};var We=class{constructor(){this._output=null}},kt=class extends We{constructor(){super(...arguments);this.buffer=null}_createWriter(){return new bt(this)}},Yr=class extends We{constructor(e,t={}){if(super(),!(e instanceof WritableStream))throw new TypeError("StreamTarget requires a WritableStream instance.");if(t!=null&&typeof t!="object")throw new TypeError("StreamTarget options, when provided, must be an object.");if(t.chunked!==void 0&&typeof t.chunked!="boolean")throw new TypeError("options.chunked, when provided, must be a boolean.");if(t.chunkSize!==void 0&&(!Number.isInteger(t.chunkSize)||t.chunkSize<1024))throw new TypeError("options.chunkSize, when provided, must be an integer and not smaller than 1024.");this._writable=e,this._options=t}_createWriter(){return new Xr(this)}};var Zr=i=>{let t=(i.hasVideo?"video/":i.hasAudio?"audio/":"application/")+(i.isQuickTime?"quicktime":"mp4");if(i.codecStrings.length>0){let r=[...new Set(i.codecStrings)];t+=`; codecs="${r.join(", ")}"`}return t};var Ye=8,Be=16,Xe=class{constructor(e){this.reader=e;this.pos=0}readBytes(e){let{view:t,offset:r}=this.reader.getViewAndOffset(this.pos,this.pos+e);return this.pos+=e,new Uint8Array(t.buffer,r,e)}readU8(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+1);return this.pos++,e.getUint8(t)}readU16(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+2);return this.pos+=2,e.getUint16(t,!1)}readI16(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+2);return this.pos+=2,e.getInt16(t,!1)}readU24(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+3);this.pos+=3;let r=e.getUint16(t,!1),n=e.getUint8(t+2);return r*256+n}readU32(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+4);return this.pos+=4,e.getUint32(t,!1)}readI32(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+4);return this.pos+=4,e.getInt32(t,!1)}readU64(){let e=this.readU32(),t=this.readU32();return e*4294967296+t}readI64(){let e=this.readI32(),t=this.readU32();return e*4294967296+t}readF64(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+8);return this.pos+=8,e.getFloat64(t,!1)}readFixed_16_16(){return this.readI32()/65536}readFixed_2_30(){return this.readI32()/1073741824}readAscii(e){let{view:t,offset:r}=this.reader.getViewAndOffset(this.pos,this.pos+e);this.pos+=e;let n="";for(let a=0;a<e;a++)n+=String.fromCharCode(t.getUint8(r+a));return n}readIsomVariableInteger(){let e=0;for(let t=0;t<4;t++){e<<=7;let r=this.readU8();if(e|=r&127,(r&128)===0)break}return e}readBoxHeader(){let e=this.readU32(),t=this.readAscii(4),r=8;e===1&&(e=this.readU64(),r=16);let a=e-r;return a<0?null:{name:t,totalSize:e,headerSize:r,contentSize:a}}};var jr=1e3,qo=2082844800,Kn=i=>{let e={},t=i.track;return t.metadata.name!==void 0&&(e.name=t.metadata.name),e},Y=(i,e,t=!0)=>{let r=i*e;return t?Math.round(r):r},Jr=class extends de{constructor(t,r){super(t);this.auxTarget=new kt;this.auxWriter=this.auxTarget._createWriter();this.auxBoxWriter=new Zt(this.auxWriter);this.mdat=null;this.trackDatas=[];this.allTracksKnown=L();this.creationTime=Math.floor(Date.now()/1e3)+qo;this.finalizedChunks=[];this.nextFragmentNumber=1;this.maxWrittenTimestamp=-1/0;this.format=r,this.writer=t._writer,this.boxWriter=new Zt(this.writer),this.isQuickTime=r instanceof Ze;let n=this.writer instanceof bt?"in-memory":!1;this.fastStart=r._options.fastStart??n,this.isFragmented=this.fastStart==="fragmented",(this.fastStart==="in-memory"||this.isFragmented)&&(this.writer.ensureMonotonicity=!0),this.minimumFragmentDuration=r._options.minimumFragmentDuration??1}async start(){let t=await this.mutex.acquire(),r=this.output._tracks.some(n=>n.type==="video"&&n.source._codec==="avc");if(this.format._options.onFtyp&&this.writer.startTrackingWrites(),this.boxWriter.writeBox(Vn({isQuickTime:this.isQuickTime,holdsAvc:r,fragmented:this.isFragmented})),this.format._options.onFtyp){let{data:n,start:a}=this.writer.stopTrackingWrites();this.format._options.onFtyp(n,a)}this.fastStart==="in-memory"?this.mdat=$r(!1):this.isFragmented||(this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat=$r(!0),this.boxWriter.writeBox(this.mdat)),await this.writer.flush(),t()}allTracksAreKnown(){for(let t of this.output._tracks)if(!t.source._closed&&!this.trackDatas.some(r=>r.track===t))return!1;return!0}async getMimeType(){await this.allTracksKnown.promise;let t=this.trackDatas.map(r=>r.type==="video"||r.type==="audio"?r.info.decoderConfig.codec:{webvtt:"wvtt"}[r.track.source._codec]);return Zr({isQuickTime:this.isQuickTime,hasVideo:this.trackDatas.some(r=>r.type==="video"),hasAudio:this.trackDatas.some(r=>r.type==="audio"),codecStrings:t})}getVideoTrackData(t,r,n){let a=this.trackDatas.find(d=>d.track===t);if(a)return a;Br(n),m(n),m(n.decoderConfig);let s={...n.decoderConfig};m(s.codedWidth!==void 0),m(s.codedHeight!==void 0);let o=!1;if(t.source._codec==="avc"&&!s.description){let d=Wr(r.data);if(!d)throw new Error("Couldn't extract an AVCDecoderConfigurationRecord from the AVC packet. Make sure the packets are in Annex B format (as specified in ITU-T-REC-H.264) when not providing a description, or provide a description (must be an AVCDecoderConfigurationRecord as specified in ISO 14496-15) and ensure the packets are in AVCC format.");s.description=vn(d),o=!0}else if(t.source._codec==="hevc"&&!s.description){let d=Hr(r.data);if(!d)throw new Error("Couldn't extract an HEVCDecoderConfigurationRecord from the HEVC packet. Make sure the packets are in Annex B format (as specified in ITU-T-REC-H.265) when not providing a description, or provide a description (must be an HEVCDecoderConfigurationRecord as specified in ISO 14496-15) and ensure the packets are in HEVC format.");s.description=Pn(d),o=!0}let c=rn(1/(t.metadata.frameRate??57600),1e6).denominator,u={muxer:this,track:t,type:"video",info:{width:s.codedWidth,height:s.codedHeight,decoderConfig:s,requiresAnnexBTransformation:o},timescale:c,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[]};return this.trackDatas.push(u),this.trackDatas.sort((d,l)=>d.track.id-l.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),u}getAudioTrackData(t,r){let n=this.trackDatas.find(s=>s.track===t);if(n)return n;Se(r),m(r),m(r.decoderConfig);let a={muxer:this,track:t,type:"audio",info:{numberOfChannels:r.decoderConfig.numberOfChannels,sampleRate:r.decoderConfig.sampleRate,decoderConfig:r.decoderConfig,requiresPcmTransformation:!this.isFragmented&&U.includes(t.source._codec)},timescale:r.decoderConfig.sampleRate,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[]};return this.trackDatas.push(a),this.trackDatas.sort((s,o)=>s.track.id-o.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),a}getSubtitleTrackData(t,r){let n=this.trackDatas.find(s=>s.track===t);if(n)return n;Dr(r),m(r),m(r.config);let a={muxer:this,track:t,type:"subtitle",info:{config:r.config},timescale:1e3,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[],lastCueEndTimestamp:0,cueQueue:[],nextSourceId:0,cueToSourceId:new WeakMap};return this.trackDatas.push(a),this.trackDatas.sort((s,o)=>s.track.id-o.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),a}async addEncodedVideoPacket(t,r,n){let a=await this.mutex.acquire();try{let s=this.getVideoTrackData(t,r,n),o=r.data;if(s.info.requiresAnnexBTransformation){let d=xn(o);if(!d)throw new Error("Failed to transform packet data. Make sure all packets are provided in Annex B format, as specified in ITU-T-REC-H.264 and ITU-T-REC-H.265.");o=d}let c=this.validateAndNormalizeTimestamp(s.track,r.timestamp,r.type==="key"),u=this.createSampleForTrack(s,o,c,r.duration,r.type);await this.registerSample(s,u)}finally{a()}}async addEncodedAudioPacket(t,r,n){let a=await this.mutex.acquire();try{let s=this.getAudioTrackData(t,n),o=this.validateAndNormalizeTimestamp(s.track,r.timestamp,r.type==="key"),c=this.createSampleForTrack(s,r.data,o,r.duration,r.type);s.info.requiresPcmTransformation&&await this.maybePadWithSilence(s,o),await this.registerSample(s,c)}finally{a()}}async maybePadWithSilence(t,r){let n=z(t.samples),a=n?n.timestamp+n.duration:0,s=r-a,o=Y(s,t.timescale);if(o>0){let{sampleSize:c,silentValue:u}=ee(t.info.decoderConfig.codec),d=o*t.info.numberOfChannels,l=new Uint8Array(c*d).fill(u),f=this.createSampleForTrack(t,new Uint8Array(l.buffer),a,s,"key");await this.registerSample(t,f)}}async addSubtitleCue(t,r,n){let a=await this.mutex.acquire();try{let s=this.getSubtitleTrackData(t,n);this.validateAndNormalizeTimestamp(s.track,r.timestamp,!0),t.source._codec==="webvtt"&&(s.cueQueue.push(r),await this.processWebVTTCues(s,r.timestamp))}finally{a()}}async processWebVTTCues(t,r){for(;t.cueQueue.length>0;){let n=new Set([]);for(let d of t.cueQueue)m(d.timestamp<=r),m(t.lastCueEndTimestamp<=d.timestamp+d.duration),n.add(Math.max(d.timestamp,t.lastCueEndTimestamp)),n.add(d.timestamp+d.duration);let a=[...n].sort((d,l)=>d-l),s=a[0],o=a[1]??s;if(r<o)break;if(t.lastCueEndTimestamp<s){this.auxWriter.seek(0);let d=Nn();this.auxBoxWriter.writeBox(d);let l=this.auxWriter.getSlice(0,this.auxWriter.getPos()),f=this.createSampleForTrack(t,l,t.lastCueEndTimestamp,s-t.lastCueEndTimestamp,"key");await this.registerSample(t,f),t.lastCueEndTimestamp=s}this.auxWriter.seek(0);for(let d=0;d<t.cueQueue.length;d++){let l=t.cueQueue[d];if(l.timestamp>=o)break;gt.lastIndex=0;let f=gt.test(l.text),h=l.timestamp+l.duration,p=t.cueToSourceId.get(l);if(p===void 0&&o<h&&(p=t.nextSourceId++,t.cueToSourceId.set(l,p)),l.notes){let g=Wn(l.notes);this.auxBoxWriter.writeBox(g)}let k=Ln(l.text,f?s:null,l.identifier??null,l.settings??null,p??null);this.auxBoxWriter.writeBox(k),h===o&&t.cueQueue.splice(d--,1)}let c=this.auxWriter.getSlice(0,this.auxWriter.getPos()),u=this.createSampleForTrack(t,c,s,o-s,"key");await this.registerSample(t,u),t.lastCueEndTimestamp=o}}createSampleForTrack(t,r,n,a,s){return{timestamp:n,decodeTimestamp:n,duration:a,data:r,size:r.byteLength,type:s,timescaleUnitsToNextSample:Y(a,t.timescale)}}processTimestamps(t,r){if(t.timestampProcessingQueue.length===0)return;if(t.type==="audio"&&t.info.requiresPcmTransformation){let a=0;for(let s=0;s<t.timestampProcessingQueue.length;s++){let o=t.timestampProcessingQueue[s],c=Y(o.duration,t.timescale);a+=c}if(t.timeToSampleTable.length===0)t.timeToSampleTable.push({sampleCount:a,sampleDelta:1});else{let s=z(t.timeToSampleTable);s.sampleCount+=a}t.timestampProcessingQueue.length=0;return}let n=t.timestampProcessingQueue.map(a=>a.timestamp).sort((a,s)=>a-s);for(let a=0;a<t.timestampProcessingQueue.length;a++){let s=t.timestampProcessingQueue[a];s.decodeTimestamp=n[a],!this.isFragmented&&t.lastTimescaleUnits===null&&(s.decodeTimestamp=0);let o=Y(s.timestamp-s.decodeTimestamp,t.timescale),c=Y(s.duration,t.timescale);if(t.lastTimescaleUnits!==null){m(t.lastSample);let u=Y(s.decodeTimestamp,t.timescale,!1),d=Math.round(u-t.lastTimescaleUnits);if(m(d>=0),t.lastTimescaleUnits+=d,t.lastSample.timescaleUnitsToNextSample=d,!this.isFragmented){let l=z(t.timeToSampleTable);if(m(l),l.sampleCount===1){l.sampleDelta=d;let h=t.timeToSampleTable[t.timeToSampleTable.length-2];h&&h.sampleDelta===d&&(h.sampleCount++,t.timeToSampleTable.pop(),l=h)}else l.sampleDelta!==d&&(l.sampleCount--,t.timeToSampleTable.push(l={sampleCount:1,sampleDelta:d}));l.sampleDelta===c?l.sampleCount++:t.timeToSampleTable.push({sampleCount:1,sampleDelta:c});let f=z(t.compositionTimeOffsetTable);m(f),f.sampleCompositionTimeOffset===o?f.sampleCount++:t.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:o})}}else t.lastTimescaleUnits=Y(s.decodeTimestamp,t.timescale,!1),this.isFragmented||(t.timeToSampleTable.push({sampleCount:1,sampleDelta:c}),t.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:o}));t.lastSample=s}if(t.timestampProcessingQueue.length=0,m(t.lastSample),m(t.lastTimescaleUnits!==null),r!==void 0&&t.lastSample.timescaleUnitsToNextSample===0){m(r.type==="key");let a=Y(r.timestamp,t.timescale,!1),s=Math.round(a-t.lastTimescaleUnits);t.lastSample.timescaleUnitsToNextSample=s}}async registerSample(t,r){r.type==="key"&&this.processTimestamps(t,r),t.timestampProcessingQueue.push(r),this.isFragmented?(t.sampleQueue.push(r),await this.interleaveSamples()):await this.addSampleToTrack(t,r)}async addSampleToTrack(t,r){this.isFragmented||t.samples.push(r);let n=!1;if(!t.currentChunk)n=!0;else{t.currentChunk.startTimestamp=Math.min(t.currentChunk.startTimestamp,r.timestamp);let a=r.timestamp-t.currentChunk.startTimestamp;if(this.isFragmented){let s=this.trackDatas.every(o=>{if(t===o)return r.type==="key";let c=o.sampleQueue[0];return c?c.type==="key":o.track.source._closed});a>=this.minimumFragmentDuration&&s&&r.timestamp>this.maxWrittenTimestamp&&(n=!0,await this.finalizeFragment())}else n=a>=.5}n&&(t.currentChunk&&await this.finalizeCurrentChunk(t),t.currentChunk={startTimestamp:r.timestamp,samples:[],offset:null,moofOffset:null}),m(t.currentChunk),t.currentChunk.samples.push(r),this.isFragmented&&(this.maxWrittenTimestamp=Math.max(this.maxWrittenTimestamp,r.timestamp))}async finalizeCurrentChunk(t){if(m(!this.isFragmented),!t.currentChunk)return;t.finalizedChunks.push(t.currentChunk),this.finalizedChunks.push(t.currentChunk);let r=t.currentChunk.samples.length;if(t.type==="audio"&&t.info.requiresPcmTransformation&&(r=t.currentChunk.samples.reduce((n,a)=>n+Y(a.duration,t.timescale),0)),(t.compactlyCodedChunkTable.length===0||z(t.compactlyCodedChunkTable).samplesPerChunk!==r)&&t.compactlyCodedChunkTable.push({firstChunk:t.finalizedChunks.length,samplesPerChunk:r}),this.fastStart==="in-memory"){t.currentChunk.offset=0;return}t.currentChunk.offset=this.writer.getPos();for(let n of t.currentChunk.samples)m(n.data),this.writer.write(n.data),n.data=null;await this.writer.flush()}async interleaveSamples(t=!1){if(m(this.isFragmented),!(!t&&!this.allTracksAreKnown()))e:for(;;){let r=null,n=1/0;for(let s of this.trackDatas){if(!t&&s.sampleQueue.length===0&&!s.track.source._closed)break e;s.sampleQueue.length>0&&s.sampleQueue[0].timestamp<n&&(r=s,n=s.sampleQueue[0].timestamp)}if(!r)break;let a=r.sampleQueue.shift();await this.addSampleToTrack(r,a)}}async finalizeFragment(t=!0){m(this.isFragmented);let r=this.nextFragmentNumber++;if(r===1){this.format._options.onMoov&&this.writer.startTrackingWrites();let p=Jt(this.trackDatas,this.creationTime,!0);if(this.boxWriter.writeBox(p),this.format._options.onMoov){let{data:k,start:g}=this.writer.stopTrackingWrites();this.format._options.onMoov(k,g)}}let n=this.trackDatas.filter(p=>p.currentChunk),a=sa(r,n),s=this.writer.getPos(),o=s+this.boxWriter.measureBox(a),c=o+Ye,u=1/0;for(let p of n){p.currentChunk.offset=c,p.currentChunk.moofOffset=s;for(let k of p.currentChunk.samples)c+=k.size;u=Math.min(u,p.currentChunk.startTimestamp)}let d=c-o,l=d>=2**32;if(l)for(let p of n)p.currentChunk.offset+=Be-Ye;this.format._options.onMoof&&this.writer.startTrackingWrites();let f=sa(r,n);if(this.boxWriter.writeBox(f),this.format._options.onMoof){let{data:p,start:k}=this.writer.stopTrackingWrites();this.format._options.onMoof(p,k,u)}m(this.writer.getPos()===o),this.format._options.onMdat&&this.writer.startTrackingWrites();let h=$r(l);h.size=d,this.boxWriter.writeBox(h),this.writer.seek(o+(l?Be:Ye));for(let p of n)for(let k of p.currentChunk.samples)this.writer.write(k.data),k.data=null;if(this.format._options.onMdat){let{data:p,start:k}=this.writer.stopTrackingWrites();this.format._options.onMdat(p,k)}for(let p of n)p.finalizedChunks.push(p.currentChunk),this.finalizedChunks.push(p.currentChunk),p.currentChunk=null;t&&await this.writer.flush()}async onTrackClose(t){let r=await this.mutex.acquire();if(t.type==="subtitle"&&t.source._codec==="webvtt"){let n=this.trackDatas.find(a=>a.track===t);n&&await this.processWebVTTCues(n,1/0)}this.allTracksAreKnown()&&this.allTracksKnown.resolve(),this.isFragmented&&await this.interleaveSamples(),r()}async finalize(){let t=await this.mutex.acquire();this.allTracksKnown.resolve();for(let r of this.trackDatas)r.type==="subtitle"&&r.track.source._codec==="webvtt"&&await this.processWebVTTCues(r,1/0);if(this.isFragmented){await this.interleaveSamples(!0);for(let r of this.trackDatas)this.processTimestamps(r);await this.finalizeFragment(!1)}else for(let r of this.trackDatas)this.processTimestamps(r),await this.finalizeCurrentChunk(r);if(this.fastStart==="in-memory"){m(this.mdat);let r;for(let a=0;a<2;a++){let s=Jt(this.trackDatas,this.creationTime),o=this.boxWriter.measureBox(s);r=this.boxWriter.measureBox(this.mdat);let c=this.writer.getPos()+o+r;for(let u of this.finalizedChunks){u.offset=c;for(let{data:d}of u.samples)m(d),c+=d.byteLength,r+=d.byteLength}if(c<2**32)break;r>=2**32&&(this.mdat.largeSize=!0)}this.format._options.onMoov&&this.writer.startTrackingWrites();let n=Jt(this.trackDatas,this.creationTime);if(this.boxWriter.writeBox(n),this.format._options.onMoov){let{data:a,start:s}=this.writer.stopTrackingWrites();this.format._options.onMoov(a,s)}this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat.size=r,this.boxWriter.writeBox(this.mdat);for(let a of this.finalizedChunks)for(let s of a.samples)m(s.data),this.writer.write(s.data),s.data=null;if(this.format._options.onMdat){let{data:a,start:s}=this.writer.stopTrackingWrites();this.format._options.onMdat(a,s)}}else if(this.isFragmented){let r=this.writer.getPos(),n=zn(this.trackDatas);this.boxWriter.writeBox(n);let a=this.writer.getPos()-r;this.writer.seek(this.writer.getPos()-4),this.boxWriter.writeU32(a)}else{m(this.mdat);let r=this.boxWriter.offsets.get(this.mdat);m(r!==void 0);let n=this.writer.getPos()-r;if(this.mdat.size=n,this.mdat.largeSize=n>=2**32,this.boxWriter.patchBox(this.mdat),this.format._options.onMdat){let{data:s,start:o}=this.writer.stopTrackingWrites();this.format._options.onMdat(s,o)}this.format._options.onMoov&&this.writer.startTrackingWrites();let a=Jt(this.trackDatas,this.creationTime);if(this.boxWriter.writeBox(a),this.format._options.onMoov){let{data:s,start:o}=this.writer.stopTrackingWrites();this.format._options.onMoov(s,o)}}t()}};var wt=class{constructor(e){this.value=e}},Tt=class{constructor(e){this.value=e}},er=class{constructor(e){this.value=e}},tr=class{constructor(e){this.value=e}};var Qo=[440786851,408125543],yt=[290298740,357149030,524531317,374648427,475249515,423732329,272869232,307544935],ti=[...Qo,...yt],qn=i=>i<256?1:i<65536?2:i<1<<24?3:i<2**32?4:i<2**40?5:6,Qn=i=>i>=-64&&i<64?1:i>=-8192&&i<8192?2:i>=-(1<<20)&&i<1<<20?3:i>=-(1<<27)&&i<1<<27?4:i>=-(2**34)&&i<2**34?5:6,jo=i=>{if(i<127)return 1;if(i<16383)return 2;if(i<(1<<21)-1)return 3;if(i<(1<<28)-1)return 4;if(i<2**35-1)return 5;if(i<2**42-1)return 6;throw new Error("EBML varint size not supported "+i)},ei=class{constructor(e){this.writer=e;this.helper=new Uint8Array(8);this.helperView=new DataView(this.helper.buffer);this.offsets=new WeakMap;this.dataOffsets=new WeakMap}writeByte(e){this.helperView.setUint8(0,e),this.writer.write(this.helper.subarray(0,1))}writeFloat32(e){this.helperView.setFloat32(0,e,!1),this.writer.write(this.helper.subarray(0,4))}writeFloat64(e){this.helperView.setFloat64(0,e,!1),this.writer.write(this.helper)}writeUnsignedInt(e,t=qn(e)){let r=0;switch(t){case 6:this.helperView.setUint8(r++,e/2**40|0);case 5:this.helperView.setUint8(r++,e/2**32|0);case 4:this.helperView.setUint8(r++,e>>24);case 3:this.helperView.setUint8(r++,e>>16);case 2:this.helperView.setUint8(r++,e>>8);case 1:this.helperView.setUint8(r++,e);break;default:throw new Error("Bad unsigned int size "+t)}this.writer.write(this.helper.subarray(0,r))}writeSignedInt(e,t=Qn(e)){e<0&&(e+=2**(t*8)),this.writeUnsignedInt(e,t)}writeVarInt(e,t=jo(e)){let r=0;switch(t){case 1:this.helperView.setUint8(r++,128|e);break;case 2:this.helperView.setUint8(r++,64|e>>8),this.helperView.setUint8(r++,e);break;case 3:this.helperView.setUint8(r++,32|e>>16),this.helperView.setUint8(r++,e>>8),this.helperView.setUint8(r++,e);break;case 4:this.helperView.setUint8(r++,16|e>>24),this.helperView.setUint8(r++,e>>16),this.helperView.setUint8(r++,e>>8),this.helperView.setUint8(r++,e);break;case 5:this.helperView.setUint8(r++,8|e/2**32&7),this.helperView.setUint8(r++,e>>24),this.helperView.setUint8(r++,e>>16),this.helperView.setUint8(r++,e>>8),this.helperView.setUint8(r++,e);break;case 6:this.helperView.setUint8(r++,4|e/2**40&3),this.helperView.setUint8(r++,e/2**32|0),this.helperView.setUint8(r++,e>>24),this.helperView.setUint8(r++,e>>16),this.helperView.setUint8(r++,e>>8),this.helperView.setUint8(r++,e);break;default:throw new Error("Bad EBML varint size "+t)}this.writer.write(this.helper.subarray(0,r))}writeAsciiString(e){this.writer.write(new Uint8Array(e.split("").map(t=>t.charCodeAt(0))))}writeEBML(e){if(e!==null)if(e instanceof Uint8Array)this.writer.write(e);else if(Array.isArray(e))for(let t of e)this.writeEBML(t);else if(this.offsets.set(e,this.writer.getPos()),this.writeUnsignedInt(e.id),Array.isArray(e.data)){let t=this.writer.getPos(),r=e.size===-1?1:e.size??4;e.size===-1?this.writeByte(255):this.writer.seek(this.writer.getPos()+r);let n=this.writer.getPos();if(this.dataOffsets.set(e,n),this.writeEBML(e.data),e.size!==-1){let a=this.writer.getPos()-n,s=this.writer.getPos();this.writer.seek(t),this.writeVarInt(a,r),this.writer.seek(s)}}else if(typeof e.data=="number"){let t=e.size??qn(e.data);this.writeVarInt(t),this.writeUnsignedInt(e.data,t)}else if(typeof e.data=="string")this.writeVarInt(e.data.length),this.writeAsciiString(e.data);else if(e.data instanceof Uint8Array)this.writeVarInt(e.data.byteLength,e.size),this.writer.write(e.data);else if(e.data instanceof wt)this.writeVarInt(4),this.writeFloat32(e.data.value);else if(e.data instanceof Tt)this.writeVarInt(8),this.writeFloat64(e.data.value);else if(e.data instanceof er){let t=e.size??Qn(e.data.value);this.writeVarInt(t),this.writeSignedInt(e.data.value,t)}else if(e.data instanceof tr){let t=oe.encode(e.data.value);this.writeVarInt(t.length),this.writer.write(t)}else ke(e.data)}},$o=8,ve=2,Je=2*$o,et=class{constructor(e){this.reader=e;this.pos=0}readBytes(e){let{view:t,offset:r}=this.reader.getViewAndOffset(this.pos,this.pos+e);return this.pos+=e,new Uint8Array(t.buffer,r,e)}readU8(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+1);return this.pos++,e.getUint8(t)}readS16(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+2);return this.pos+=2,e.getInt16(t,!1)}readVarIntSize(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+1),r=e.getUint8(t);if(r===0)return null;let n=1,a=128;for(;(r&a)===0;)n++,a>>=1;return n}readVarInt(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+1),r=e.getUint8(t);if(r===0)return null;let n=1,a=128;for(;(r&a)===0;)n++,a>>=1;let{view:s,offset:o}=this.reader.getViewAndOffset(this.pos,this.pos+n),c=r&a-1;for(let u=1;u<n;u++)c*=256,c+=s.getUint8(o+u);return this.pos+=n,c}readUnsignedInt(e){if(e<1||e>8)throw new Error("Bad unsigned int size "+e);let{view:t,offset:r}=this.reader.getViewAndOffset(this.pos,this.pos+e),n=0;for(let a=0;a<e;a++)n*=256,n+=t.getUint8(r+a);return this.pos+=e,n}readSignedInt(e){let t=this.readUnsignedInt(e);return t&1<<e*8-1&&(t-=2**(e*8)),t}readFloat(e){if(e===0)return 0;if(e!==4&&e!==8)throw new Error("Bad float size "+e);let{view:t,offset:r}=this.reader.getViewAndOffset(this.pos,this.pos+e),n=e===4?t.getFloat32(r,!1):t.getFloat64(r,!1);return this.pos+=e,n}readAsciiString(e){let{view:t,offset:r}=this.reader.getViewAndOffset(this.pos,this.pos+e);this.pos+=e;let n=0;for(;n<e&&t.getUint8(r+n)!==0;)n+=1;return String.fromCharCode(...new Uint8Array(t.buffer,r,n))}readUnicodeString(e){let{view:t,offset:r}=this.reader.getViewAndOffset(this.pos,this.pos+e);this.pos+=e;let n=0;for(;n<e&&t.getUint8(r+n)!==0;)n+=1;return xr.decode(new Uint8Array(t.buffer,r,n))}readElementId(){let e=this.readVarIntSize();return e===null?null:this.readUnsignedInt(e)}readElementSize(){let e=this.readU8();return e===255?e=null:(this.pos--,e=this.readVarInt(),e===72057594037927940&&(e=null)),e}readElementHeader(){let e=this.readElementId();if(e===null)return null;let t=this.readElementSize();return{id:e,size:t}}async searchForNextElementId(e,t){let n=new Set(e);for(;this.pos<=t-ve;){this.reader.rangeIsLoaded(this.pos,Math.min(this.pos+Je,t))||await this.reader.loadRange(this.pos,Math.min(this.pos+1048576,t));let a=this.pos,s=this.readElementHeader();if(!s)break;if(n.has(s.id))return a;tt(s.size),this.pos+=s.size}return null}async resync(e,t){let n=new Set(e);for(;this.pos<=t-ve;){this.reader.rangeIsLoaded(this.pos,Math.min(this.pos+Je,t))||await this.reader.loadRange(this.pos,Math.min(this.pos+1048576,t));let a=this.pos,s=this.readElementId();if(s!==null&&n.has(s))return a;this.pos=a+1}return null}},le={avc:"V_MPEG4/ISO/AVC",hevc:"V_MPEGH/ISO/HEVC",vp8:"V_VP8",vp9:"V_VP9",av1:"V_AV1",aac:"A_AAC",mp3:"A_MPEG/L3",opus:"A_OPUS",vorbis:"A_VORBIS",flac:"A_FLAC","pcm-u8":"A_PCM/INT/LIT","pcm-s16":"A_PCM/INT/LIT","pcm-s16be":"A_PCM/INT/BIG","pcm-s24":"A_PCM/INT/LIT","pcm-s24be":"A_PCM/INT/BIG","pcm-s32":"A_PCM/INT/LIT","pcm-s32be":"A_PCM/INT/BIG","pcm-f32":"A_PCM/FLOAT/IEEE","pcm-f64":"A_PCM/FLOAT/IEEE",webvtt:"S_TEXT/WEBVTT"},da=(i,e)=>{if(e>=i.length)throw new Error("Offset out of bounds.");let t=i[e],r=1,n=128;for(;(t&n)===0&&r<8;)r++,n>>=1;if(e+r>i.length)throw new Error("VarInt extends beyond data bounds.");let a=t&n-1;for(let s=1;s<r;s++)a*=256,a+=i[e+s];return{value:a,width:r}};function tt(i){if(i===null)throw new Error("Undefined element size is used in a place where it is not supported.")}var ri=i=>{let t=(i.hasVideo?"video/":i.hasAudio?"audio/":"application/")+(i.isWebM?"webm":"x-matroska");if(i.codecStrings.length>0){let r=[...new Set(i.codecStrings.filter(Boolean))];t+=`; codecs="${r.join(", ")}"`}return t};var Go=-(2**15),Xo=2**15-1,jn="https://github.com/Vanilagy/mediabunny",$n=6,Gn=5,Yo={video:1,audio:2,subtitle:17},ii=class extends de{constructor(t,r){super(t);this.trackDatas=[];this.allTracksKnown=L();this.segment=null;this.segmentInfo=null;this.seekHead=null;this.tracksElement=null;this.segmentDuration=null;this.cues=null;this.currentCluster=null;this.currentClusterStartMsTimestamp=null;this.currentClusterMaxMsTimestamp=null;this.trackDatasInCurrentCluster=new Map;this.duration=0;this.writer=t._writer,this.format=r,this.ebmlWriter=new ei(this.writer),this.format._options.appendOnly&&(this.writer.ensureMonotonicity=!0)}async start(){let t=await this.mutex.acquire();this.writeEBMLHeader(),this.format._options.appendOnly||this.createSeekHead(),this.createSegmentInfo(),this.createCues(),await this.writer.flush(),t()}writeEBMLHeader(){this.format._options.onEbmlHeader&&this.writer.startTrackingWrites();let t={id:440786851,data:[{id:17030,data:1},{id:17143,data:1},{id:17138,data:4},{id:17139,data:8},{id:17026,data:this.format instanceof rt?"webm":"matroska"},{id:17031,data:2},{id:17029,data:2}]};if(this.ebmlWriter.writeEBML(t),this.format._options.onEbmlHeader){let{data:r,start:n}=this.writer.stopTrackingWrites();this.format._options.onEbmlHeader(r,n)}}createSeekHead(){let t=new Uint8Array([28,83,187,107]),r=new Uint8Array([21,73,169,102]),n=new Uint8Array([22,84,174,107]),a={id:290298740,data:[{id:19899,data:[{id:21419,data:t},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:r},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:n},{id:21420,size:5,data:0}]}]};this.seekHead=a}createSegmentInfo(){let t={id:17545,data:new Tt(0)};this.segmentDuration=t;let r={id:357149030,data:[{id:2807729,data:1e6},{id:19840,data:jn},{id:22337,data:jn},this.format._options.appendOnly?null:t]};this.segmentInfo=r}createTracks(){let t={id:374648427,data:[]};this.tracksElement=t;for(let r of this.trackDatas){let n=le[r.track.source._codec];m(n);let a=0;if(r.type==="audio"&&r.track.source._codec==="opus"){a=1e6*80;let s=r.info.decoderConfig.description;if(s){let o=K(s),c=ze(o);a=Math.round(1e9*(c.preSkip/ht))}}t.data.push({id:174,data:[{id:215,data:r.track.id},{id:29637,data:r.track.id},{id:131,data:Yo[r.type]},{id:156,data:0},{id:2274716,data:r.track.metadata.languageCode??Q},{id:134,data:n},{id:22186,data:0},{id:22203,data:a},r.track.metadata.name!==void 0?{id:21358,data:new tr(r.track.metadata.name)}:null,r.type==="video"?this.videoSpecificTrackInfo(r):null,r.type==="audio"?this.audioSpecificTrackInfo(r):null,r.type==="subtitle"?this.subtitleSpecificTrackInfo(r):null]})}}videoSpecificTrackInfo(t){let{frameRate:r,rotation:n}=t.track.metadata,a=[t.info.decoderConfig.description?{id:25506,data:K(t.info.decoderConfig.description)}:null,r?{id:2352003,data:1e9/r}:null],s=n?Ue(-n):0,o=t.info.decoderConfig.colorSpace,c={id:224,data:[{id:176,data:t.info.width},{id:186,data:t.info.height},Ir(o)?{id:21936,data:[{id:21937,data:Re[o.matrix]},{id:21946,data:Ae[o.transfer]},{id:21947,data:_e[o.primaries]},{id:21945,data:o.fullRange?2:1}]}:null,s?{id:30320,data:[{id:30321,data:0},{id:30325,data:new wt((s+180)%360-180)}]}:null]};return a.push(c),a}audioSpecificTrackInfo(t){let r=U.includes(t.track.source._codec)?ee(t.track.source._codec):null;return[t.info.decoderConfig.description?{id:25506,data:K(t.info.decoderConfig.description)}:null,{id:225,data:[{id:181,data:new wt(t.info.sampleRate)},{id:159,data:t.info.numberOfChannels},r?{id:25188,data:8*r.sampleSize}:null]}]}subtitleSpecificTrackInfo(t){return[{id:25506,data:oe.encode(t.info.config.description)}]}createSegment(){let t={id:408125543,size:this.format._options.appendOnly?-1:$n,data:[this.format._options.appendOnly?null:this.seekHead,this.segmentInfo,this.tracksElement]};if(this.segment=t,this.format._options.onSegmentHeader&&this.writer.startTrackingWrites(),this.ebmlWriter.writeEBML(t),this.format._options.onSegmentHeader){let{data:r,start:n}=this.writer.stopTrackingWrites();this.format._options.onSegmentHeader(r,n)}}createCues(){this.cues={id:475249515,data:[]}}get segmentDataOffset(){return m(this.segment),this.ebmlWriter.dataOffsets.get(this.segment)}allTracksAreKnown(){for(let t of this.output._tracks)if(!t.source._closed&&!this.trackDatas.some(r=>r.track===t))return!1;return!0}async getMimeType(){await this.allTracksKnown.promise;let t=this.trackDatas.map(r=>r.type==="video"||r.type==="audio"?r.info.decoderConfig.codec:{webvtt:"wvtt"}[r.track.source._codec]);return ri({isWebM:this.format instanceof rt,hasVideo:this.trackDatas.some(r=>r.type==="video"),hasAudio:this.trackDatas.some(r=>r.type==="audio"),codecStrings:t})}getVideoTrackData(t,r){let n=this.trackDatas.find(s=>s.track===t);if(n)return n;Br(r),m(r),m(r.decoderConfig),m(r.decoderConfig.codedWidth!==void 0),m(r.decoderConfig.codedHeight!==void 0);let a={track:t,type:"video",info:{width:r.decoderConfig.codedWidth,height:r.decoderConfig.codedHeight,decoderConfig:r.decoderConfig},chunkQueue:[],lastWrittenMsTimestamp:null};return t.source._codec==="vp9"?a.info.decoderConfig={...a.info.decoderConfig,description:new Uint8Array(un(a.info.decoderConfig.codec))}:t.source._codec==="av1"&&(a.info.decoderConfig={...a.info.decoderConfig,description:new Uint8Array(Fr(a.info.decoderConfig.codec))}),this.trackDatas.push(a),this.trackDatas.sort((s,o)=>s.track.id-o.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),a}getAudioTrackData(t,r){let n=this.trackDatas.find(s=>s.track===t);if(n)return n;Se(r),m(r),m(r.decoderConfig);let a={track:t,type:"audio",info:{numberOfChannels:r.decoderConfig.numberOfChannels,sampleRate:r.decoderConfig.sampleRate,decoderConfig:r.decoderConfig},chunkQueue:[],lastWrittenMsTimestamp:null};return this.trackDatas.push(a),this.trackDatas.sort((s,o)=>s.track.id-o.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),a}getSubtitleTrackData(t,r){let n=this.trackDatas.find(s=>s.track===t);if(n)return n;Dr(r),m(r),m(r.config);let a={track:t,type:"subtitle",info:{config:r.config},chunkQueue:[],lastWrittenMsTimestamp:null};return this.trackDatas.push(a),this.trackDatas.sort((s,o)=>s.track.id-o.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),a}async addEncodedVideoPacket(t,r,n){let a=await this.mutex.acquire();try{let s=this.getVideoTrackData(t,n),o=r.type==="key",c=this.validateAndNormalizeTimestamp(s.track,r.timestamp,o),u=r.duration;t.metadata.frameRate!==void 0&&(c=qt(c,1/t.metadata.frameRate),u=qt(u,1/t.metadata.frameRate));let d=this.createInternalChunk(r.data,c,u,r.type);t.source._codec==="vp9"&&this.fixVP9ColorSpace(s,d),s.chunkQueue.push(d),await this.interleaveChunks()}finally{a()}}async addEncodedAudioPacket(t,r,n){let a=await this.mutex.acquire();try{let s=this.getAudioTrackData(t,n),o=r.type==="key",c=this.validateAndNormalizeTimestamp(s.track,r.timestamp,o),u=this.createInternalChunk(r.data,c,r.duration,r.type);s.chunkQueue.push(u),await this.interleaveChunks()}finally{a()}}async addSubtitleCue(t,r,n){let a=await this.mutex.acquire();try{let s=this.getSubtitleTrackData(t,n),o=this.validateAndNormalizeTimestamp(s.track,r.timestamp,!0),c=r.text,u=Math.round(o*1e3);gt.lastIndex=0,c=c.replace(gt,h=>{let k=zr(h.slice(1,-1))-u;return`<${Nr(k)}>`});let d=oe.encode(c),l=`${r.settings??""}
${r.identifier??""}
${r.notes??""}`,f=this.createInternalChunk(d,o,r.duration,"key",l.trim()?oe.encode(l):null);s.chunkQueue.push(f),await this.interleaveChunks()}finally{a()}}async interleaveChunks(t=!1){if(!(!t&&!this.allTracksAreKnown())){e:for(;;){let r=null,n=1/0;for(let s of this.trackDatas){if(!t&&s.chunkQueue.length===0&&!s.track.source._closed)break e;s.chunkQueue.length>0&&s.chunkQueue[0].timestamp<n&&(r=s,n=s.chunkQueue[0].timestamp)}if(!r)break;let a=r.chunkQueue.shift();this.writeBlock(r,a)}t||await this.writer.flush()}}fixVP9ColorSpace(t,r){if(r.type!=="key"||!t.info.decoderConfig.colorSpace||!t.info.decoderConfig.colorSpace.matrix)return;let n=new N(r.data);n.skipBits(2);let a=n.readBits(1),o=(n.readBits(1)<<1)+a;if(o===3&&n.skipBits(1),n.readBits(1)||n.readBits(1)!==0||(n.skipBits(2),n.readBits(24)!==4817730))return;o>=2&&n.skipBits(1);let l={rgb:7,bt709:2,bt470bg:1,smpte170m:3}[t.info.decoderConfig.colorSpace.matrix];$a(r.data,n.pos,n.pos+3,l)}createInternalChunk(t,r,n,a,s=null){return{data:t,type:a,timestamp:r,duration:n,additions:s}}writeBlock(t,r){this.segment||(this.createTracks(),this.createSegment());let n=Math.round(1e3*r.timestamp),a=this.trackDatas.every(l=>{if(t===l)return r.type==="key";let f=l.chunkQueue[0];return f?f.type==="key":l.track.source._closed}),s=!1;if(!this.currentCluster)s=!0;else{m(this.currentClusterStartMsTimestamp!==null),m(this.currentClusterMaxMsTimestamp!==null);let l=n-this.currentClusterStartMsTimestamp;s=a&&n>this.currentClusterMaxMsTimestamp&&l>=1e3*(this.format._options.minimumClusterDuration??1)||l>Xo}s&&this.createNewCluster(n);let o=n-this.currentClusterStartMsTimestamp;if(o<Go)return;let c=new Uint8Array(4),u=new DataView(c.buffer);u.setUint8(0,128|t.track.id),u.setInt16(1,o,!1);let d=Math.round(1e3*r.duration);if(r.additions){let l={id:160,data:[{id:161,data:[c,r.data]},r.type==="delta"?{id:251,data:new er(t.lastWrittenMsTimestamp-n)}:null,r.additions?{id:30113,data:[{id:166,data:[{id:165,data:r.additions},{id:238,data:1}]}]}:null,d>0?{id:155,data:d}:null]};this.ebmlWriter.writeEBML(l)}else{u.setUint8(3,+(r.type==="key")<<7);let l={id:163,data:[c,r.data]};this.ebmlWriter.writeEBML(l)}this.duration=Math.max(this.duration,n+d),t.lastWrittenMsTimestamp=n,this.trackDatasInCurrentCluster.has(t)||this.trackDatasInCurrentCluster.set(t,{firstMsTimestamp:n}),this.currentClusterMaxMsTimestamp=Math.max(this.currentClusterMaxMsTimestamp,n)}createNewCluster(t){this.currentCluster&&this.finalizeCurrentCluster(),this.format._options.onCluster&&this.writer.startTrackingWrites(),this.currentCluster={id:524531317,size:this.format._options.appendOnly?-1:Gn,data:[{id:231,data:t}]},this.ebmlWriter.writeEBML(this.currentCluster),this.currentClusterStartMsTimestamp=t,this.currentClusterMaxMsTimestamp=t,this.trackDatasInCurrentCluster.clear()}finalizeCurrentCluster(){if(m(this.currentCluster),!this.format._options.appendOnly){let a=this.writer.getPos()-this.ebmlWriter.dataOffsets.get(this.currentCluster),s=this.writer.getPos();this.writer.seek(this.ebmlWriter.offsets.get(this.currentCluster)+4),this.ebmlWriter.writeVarInt(a,Gn),this.writer.seek(s)}if(this.format._options.onCluster){m(this.currentClusterStartMsTimestamp!==null);let{data:a,start:s}=this.writer.stopTrackingWrites();this.format._options.onCluster(a,s,this.currentClusterStartMsTimestamp/1e3)}let t=this.ebmlWriter.offsets.get(this.currentCluster)-this.segmentDataOffset,r=new Map;for(let[a,{firstMsTimestamp:s}]of this.trackDatasInCurrentCluster)r.has(s)||r.set(s,[]),r.get(s).push(a);let n=[...r.entries()].sort((a,s)=>a[0]-s[0]);for(let[a,s]of n)m(this.cues),this.cues.data.push({id:187,data:[{id:179,data:a},...s.map(o=>({id:183,data:[{id:247,data:o.track.id},{id:241,data:t}]}))]})}async onTrackClose(){let t=await this.mutex.acquire();this.allTracksAreKnown()&&this.allTracksKnown.resolve(),await this.interleaveChunks(),t()}async finalize(){let t=await this.mutex.acquire();if(this.allTracksKnown.resolve(),this.segment||(this.createTracks(),this.createSegment()),await this.interleaveChunks(!0),this.currentCluster&&this.finalizeCurrentCluster(),m(this.cues),this.ebmlWriter.writeEBML(this.cues),!this.format._options.appendOnly){let r=this.writer.getPos(),n=this.writer.getPos()-this.segmentDataOffset;this.writer.seek(this.ebmlWriter.offsets.get(this.segment)+4),this.ebmlWriter.writeVarInt(n,$n),this.segmentDuration.data=new Tt(this.duration),this.writer.seek(this.ebmlWriter.offsets.get(this.segmentDuration)),this.ebmlWriter.writeEBML(this.segmentDuration),this.seekHead.data[0].data[1].data=this.ebmlWriter.offsets.get(this.cues)-this.segmentDataOffset,this.seekHead.data[1].data[1].data=this.ebmlWriter.offsets.get(this.segmentInfo)-this.segmentDataOffset,this.seekHead.data[2].data[1].data=this.ebmlWriter.offsets.get(this.tracksElement)-this.segmentDataOffset,this.writer.seek(this.ebmlWriter.offsets.get(this.seekHead)),this.ebmlWriter.writeEBML(this.seekHead),this.writer.seek(r)}t()}};var ua={1:[-1,32,40,48,56,64,80,96,112,128,160,192,224,256,320,-1],2:[-1,32,48,56,64,80,96,112,128,160,192,224,256,320,384,-1],3:[-1,32,64,96,128,160,192,224,256,288,320,352,384,416,448,-1]},la={1:[-1,32,48,56,64,80,96,112,128,144,160,176,192,224,256,-1],2:[-1,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1],3:[-1,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1]},ma={0:[11025,12e3,8e3,-1],2:[22050,24e3,16e3,-1],3:[44100,48e3,32e3,-1]},St=1483304551,ai=1231971951,ni=(i,e,t,r)=>Math.floor(i===3?(12*e/t+r)*4:144*e/t+r),Ct=(i,e)=>i===3?e===3?21:36:e===3?13:21,si=(i,e)=>{let t=e.pos,r=i>>>24,n=i>>>16&255,a=i>>>8&255,s=i&255;if(r!==255&&n!==255&&a!==255&&s!==255)return e.pos+=4,null;if(e.pos+=1,r!==255||(n&224)!==224)return null;let o=n>>3&3,c=n>>1&3,u=a>>4&15,d=a>>2&3,l=a>>1&1,f=s>>6&3,h=s>>4&3,p=s>>3&1,k=s>>2&1,g=s&3,b=o===3?ua[c]?.[u]:la[c]?.[u];if(!b||b===-1)return null;let w=b*1e3,S=ma[o]?.[d];if(!S||S===-1)return null;let x=ni(c,w,S,l);if(e.fileSize!==null&&e.fileSize-t<x)return null;let y;return o===3?y=c===3?384:1152:c===3?y=384:c===2?y=1152:y=576,{startPos:t,totalSize:x,mpegVersionId:o,layer:c,bitrate:w,frequencyIndex:d,sampleRate:S,channel:f,modeExtension:h,copyright:p,original:k,emphasis:g,audioSamplesInFrame:y}};var oi=class{constructor(e){this.writer=e;this.helper=new Uint8Array(8);this.helperView=new DataView(this.helper.buffer)}writeU32(e){this.helperView.setUint32(0,e,!1),this.writer.write(this.helper.subarray(0,4))}writeXingFrame(e){let t=this.writer.getPos(),r=255,n=224|e.mpegVersionId<<3|e.layer<<1,s=(e.mpegVersionId===3?ua:la)?.[e.layer];if(!s)throw new Error("Invalid MPEG version and layer combination.");let o=ma[e.mpegVersionId]?.[e.frequencyIndex];if(!o||o===-1)throw new Error("Invalid MPEG version and frequency index combination.");let c=0,u=155,d=s.findIndex(g=>ni(e.layer,1e3*g,o,c)>=u);if(d===-1)throw new Error("No suitable bitrate found.");let l=d<<4|e.frequencyIndex<<2|c<<1,f=e.channel<<6|e.modeExtension<<4|e.copyright<<3|e.original<<2|e.emphasis;this.helper[0]=r,this.helper[1]=n,this.helper[2]=l,this.helper[3]=f,this.writer.write(this.helper.subarray(0,4));let h=Ct(e.mpegVersionId,e.channel);this.writer.seek(t+h),this.writeU32(St);let p=0;e.frameCount!==null&&(p|=1),e.fileSize!==null&&(p|=2),e.toc!==null&&(p|=4),this.writeU32(p),this.writeU32(e.frameCount??0),this.writeU32(e.fileSize??0),this.writer.write(e.toc??new Uint8Array(100));let k=ni(e.layer,1e3*s[d],o,c);this.writer.seek(t+k)}};var ci=class extends de{constructor(t,r){super(t);this.xingFrameData=null;this.frameCount=0;this.framePositions=[];this.format=r,this.writer=t._writer,this.mp3Writer=new oi(t._writer)}async start(){}async getMimeType(){return"audio/mpeg"}async addEncodedVideoPacket(){throw new Error("MP3 does not support video.")}async addEncodedAudioPacket(t,r){let n=await this.mutex.acquire();try{let a=this.format._options.xingHeader!==!1;if(!this.xingFrameData&&a){let s=re(r.data);if(s.byteLength<4)throw new Error("Invalid MP3 header in sample.");let o=s.getUint32(0,!1),c=si(o,{pos:0,fileSize:null});if(!c)throw new Error("Invalid MP3 header in sample.");let u=Ct(c.mpegVersionId,c.channel);if(s.byteLength>=u+4){let d=s.getUint32(u,!1);if(d===St||d===ai)return}this.xingFrameData={mpegVersionId:c.mpegVersionId,layer:c.layer,frequencyIndex:c.frequencyIndex,channel:c.channel,modeExtension:c.modeExtension,copyright:c.copyright,original:c.original,emphasis:c.emphasis,frameCount:null,fileSize:null,toc:null},this.mp3Writer.writeXingFrame(this.xingFrameData),this.frameCount++}this.validateAndNormalizeTimestamp(t,r.timestamp,r.type==="key"),this.writer.write(r.data),this.frameCount++,await this.writer.flush(),a&&this.framePositions.push(this.writer.getPos())}finally{n()}}async addSubtitleCue(){throw new Error("MP3 does not support subtitles.")}async finalize(){if(!this.xingFrameData)return;let t=await this.mutex.acquire(),r=this.writer.getPos();this.writer.seek(0);let n=new Uint8Array(100);for(let a=0;a<100;a++){let s=Math.floor(this.framePositions.length*(a/100));m(s!==-1&&s<this.framePositions.length);let o=this.framePositions[s];n[a]=256*(o/r)}if(this.xingFrameData.frameCount=this.frameCount,this.xingFrameData.fileSize=r,this.xingFrameData.toc=n,this.format._options.onXingFrame&&this.writer.startTrackingWrites(),this.mp3Writer.writeXingFrame(this.xingFrameData),this.format._options.onXingFrame){let{data:a,start:s}=this.writer.stopTrackingWrites();this.format._options.onXingFrame(a,s)}this.writer.seek(r),t()}};var rr=1399285583,Zo=79764919,Yn=new Uint32Array(256);for(let i=0;i<256;i++){let e=i<<24;for(let t=0;t<8;t++)e=e&2147483648?e<<1^Zo:e<<1;Yn[i]=e>>>0&4294967295}var di=i=>{let e=re(i),t=e.getUint32(22,!0);e.setUint32(22,0,!0);let r=0;for(let n=0;n<i.length;n++){let a=i[n];r=(r<<8^Yn[r>>>24^a])>>>0}return e.setUint32(22,t,!0),r},ui=(i,e,t)=>{let r=0,n=null;if(i.length>0)if(e.codec==="vorbis"){m(e.vorbisInfo);let a=e.vorbisInfo.modeBlockflags.length,o=(1<<tn(a-1))-1<<1,c=(i[0]&o)>>1;if(c>=e.vorbisInfo.modeBlockflags.length)throw new Error("Invalid mode number.");let u=t,d=e.vorbisInfo.modeBlockflags[c];if(n=e.vorbisInfo.blocksizes[d],d===1){let l=(o|1)+1,f=i[0]&l?1:0;u=e.vorbisInfo.blocksizes[f]}r=u!==null?u+n>>2:0}else e.codec==="opus"&&(r=In(i).durationInSamples);return{durationInSamples:r,vorbisBlockSize:n}},li=i=>{let e="audio/ogg";if(i.codecStrings){let t=[...new Set(i.codecStrings)];e+=`; codecs="${t.join(", ")}"`}return e};var vt=27,it=282,mi=it+255*255,xt=class{constructor(e){this.reader=e;this.pos=0}readBytes(e){let{view:t,offset:r}=this.reader.getViewAndOffset(this.pos,this.pos+e);return this.pos+=e,new Uint8Array(t.buffer,r,e)}readU8(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+1);return this.pos+=1,e.getUint8(t)}readU32(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+4);return this.pos+=4,e.getUint32(t,!0)}readI32(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+4);return this.pos+=4,e.getInt32(t,!0)}readI64(){let e=this.readU32();return this.readI32()*4294967296+e}readAscii(e){let{view:t,offset:r}=this.reader.getViewAndOffset(this.pos,this.pos+e);this.pos+=e;let n="";for(let a=0;a<e;a++)n+=String.fromCharCode(t.getUint8(r+a));return n}readPageHeader(){let e=this.pos;if(this.readU32()!==rr)return null;this.pos+=1;let r=this.readU8(),n=this.readI64(),a=this.readU32(),s=this.readU32(),o=this.readU32(),c=this.readU8(),u=new Uint8Array(c);for(let h=0;h<c;h++)u[h]=this.readU8();let d=27+c,l=u.reduce((h,p)=>h+p,0),f=d+l;return{headerStartPos:e,totalSize:f,dataStartPos:e+d,dataSize:l,headerType:r,granulePosition:n,serialNumber:a,sequenceNumber:s,checksum:o,lacingValues:u}}findNextPageHeader(e){for(;this.pos<e-3;){let t=this.readU32(),r=t&255,n=t>>>8&255,a=t>>>16&255,s=t>>>24&255,o=79;if(!(r!==o&&n!==o&&a!==o&&s!==o)){if(this.pos-=4,t===rr)return!0;this.pos+=1}}return!1}};var Jo=8192,fi=class extends de{constructor(t,r){super(t);this.trackDatas=[];this.bosPagesWritten=!1;this.allTracksKnown=L();this.pageBytes=new Uint8Array(mi);this.pageView=new DataView(this.pageBytes.buffer);this.format=r,this.writer=t._writer,this.writer.ensureMonotonicity=!0}async start(){}async getMimeType(){return await this.allTracksKnown.promise,li({codecStrings:this.trackDatas.map(t=>t.codecInfo.codec)})}addEncodedVideoPacket(){throw new Error("Video tracks are not supported.")}getTrackData(t,r){let n=this.trackDatas.find(o=>o.track===t);if(n)return n;let a;do a=Math.floor(2**32*Math.random());while(this.trackDatas.some(o=>o.serialNumber===a));m(t.source._codec==="vorbis"||t.source._codec==="opus"),Se(r),m(r),m(r.decoderConfig);let s={track:t,serialNumber:a,internalSampleRate:t.source._codec==="opus"?ht:r.decoderConfig.sampleRate,codecInfo:{codec:t.source._codec,vorbisInfo:null,opusInfo:null},vorbisLastBlocksize:null,packetQueue:[],currentTimestampInSamples:0,pagesWritten:0,currentGranulePosition:0,currentLacingValues:[],currentPageData:[],currentPageSize:27,currentPageStartsWithFreshPacket:!0};return this.queueHeaderPackets(s,r),this.trackDatas.push(s),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),s}queueHeaderPackets(t,r){if(m(r.decoderConfig),t.track.source._codec==="vorbis"){m(r.decoderConfig.description);let n=K(r.decoderConfig.description);if(n[0]!==2)throw new TypeError("First byte of Vorbis decoder description must be 2.");let a=1,s=()=>{let k=0;for(;;){let g=n[a++];if(g===void 0)throw new TypeError("Vorbis decoder description is too short.");if(k+=g,g<255)return k}},o=s(),c=s();if(n.length-a<=0)throw new TypeError("Vorbis decoder description is too short.");let d=n.subarray(a,a+=o),l=n.subarray(a,a+=c),f=n.subarray(a);t.packetQueue.push({data:d,endGranulePosition:0,timestamp:0,forcePageFlush:!0},{data:l,endGranulePosition:0,timestamp:0,forcePageFlush:!1},{data:f,endGranulePosition:0,timestamp:0,forcePageFlush:!0});let p=re(d).getUint8(28);t.codecInfo.vorbisInfo={blocksizes:[1<<(p&15),1<<(p>>4)],modeBlockflags:Qr(f).modeBlockflags}}else if(t.track.source._codec==="opus"){if(!r.decoderConfig.description)throw new TypeError("For Ogg, Opus decoder description is required.");let n=K(r.decoderConfig.description),a=new Uint8Array(16),s=new DataView(a.buffer);s.setUint32(0,1332770163,!1),s.setUint32(4,1415669619,!1),s.setUint32(8,0,!0),s.setUint32(12,0,!0),t.packetQueue.push({data:n,endGranulePosition:0,timestamp:0,forcePageFlush:!0},{data:a,endGranulePosition:0,timestamp:0,forcePageFlush:!0}),t.codecInfo.opusInfo={preSkip:ze(n).preSkip}}}async addEncodedAudioPacket(t,r,n){let a=await this.mutex.acquire();try{let s=this.getTrackData(t,n);this.validateAndNormalizeTimestamp(s.track,r.timestamp,r.type==="key");let o=s.currentTimestampInSamples,{durationInSamples:c,vorbisBlockSize:u}=ui(r.data,s.codecInfo,s.vorbisLastBlocksize);s.currentTimestampInSamples+=c,s.vorbisLastBlocksize=u,s.packetQueue.push({data:r.data,endGranulePosition:s.currentTimestampInSamples,timestamp:o/s.internalSampleRate,forcePageFlush:!1}),await this.interleavePages()}finally{a()}}addSubtitleCue(){throw new Error("Subtitle tracks are not supported.")}allTracksAreKnown(){for(let t of this.output._tracks)if(!t.source._closed&&!this.trackDatas.some(r=>r.track===t))return!1;return!0}async interleavePages(t=!1){if(!this.bosPagesWritten){if(!this.allTracksAreKnown())return;for(let r of this.trackDatas)for(;r.packetQueue.length>0;){let n=r.packetQueue.shift();if(this.writePacket(r,n,!1),n.forcePageFlush)break}this.bosPagesWritten=!0}e:for(;;){let r=null,n=1/0;for(let o of this.trackDatas){if(!t&&o.packetQueue.length<=1&&!o.track.source._closed)break e;o.packetQueue.length>0&&o.packetQueue[0].timestamp<n&&(r=o,n=o.packetQueue[0].timestamp)}if(!r)break;let a=r.packetQueue.shift(),s=r.packetQueue.length===0;this.writePacket(r,a,s)}t||await this.writer.flush()}writePacket(t,r,n){let a=r.data.length,s=0,o=0;for(;;){t.currentLacingValues.length===0&&s>0&&(t.currentPageStartsWithFreshPacket=!1);let u=Math.min(255,a);t.currentLacingValues.push(u),t.currentPageSize++,o+=u;let d=a<255;if(t.currentLacingValues.length===255){let l=r.data.subarray(s,o);if(s=o,t.currentPageData.push(l),t.currentPageSize+=l.length,this.writePage(t,n&&d),d)return}if(d)break;a-=255}let c=r.data.subarray(s);t.currentPageData.push(c),t.currentPageSize+=c.length,t.currentGranulePosition=r.endGranulePosition,(t.currentPageSize>=Jo||r.forcePageFlush)&&this.writePage(t,n)}writePage(t,r){this.pageView.setUint32(0,rr,!0),this.pageView.setUint8(4,0);let n=0;t.currentPageStartsWithFreshPacket||(n|=1),t.pagesWritten===0&&(n|=2),r&&(n|=4),this.pageView.setUint8(5,n);let a=t.currentLacingValues.every(u=>u===255)?-1:t.currentGranulePosition;en(this.pageView,6,a,!0),this.pageView.setUint32(14,t.serialNumber,!0),this.pageView.setUint32(18,t.pagesWritten,!0),this.pageView.setUint32(22,0,!0),this.pageView.setUint8(26,t.currentLacingValues.length),this.pageBytes.set(t.currentLacingValues,27);let s=27+t.currentLacingValues.length;for(let u of t.currentPageData)this.pageBytes.set(u,s),s+=u.length;let o=this.pageBytes.subarray(0,s),c=di(o);if(this.pageView.setUint32(22,c,!0),t.pagesWritten++,t.currentLacingValues.length=0,t.currentPageData.length=0,t.currentPageSize=27,t.currentPageStartsWithFreshPacket=!0,this.format._options.onPage&&this.writer.startTrackingWrites(),this.writer.write(o),this.format._options.onPage){let{data:u,start:d}=this.writer.stopTrackingWrites();this.format._options.onPage(u,d,t.track.source)}}async onTrackClose(){let t=await this.mutex.acquire();this.allTracksAreKnown()&&this.allTracksKnown.resolve(),await this.interleavePages(),t()}async finalize(){let t=await this.mutex.acquire();this.allTracksKnown.resolve(),await this.interleavePages(!0);for(let r of this.trackDatas)r.currentLacingValues.length>0&&this.writePage(r,!0);t()}};var ue=class{constructor(e){this.input=e}};var ir=class{static supports(e,t){return!1}},ar=class{static supports(e,t){return!1}},nr=class{static supports(e,t){return!1}},sr=class{static supports(e,t){return!1}},Pt=[],Et=[],at=[],nt=[],Zn=i=>{if(i.prototype instanceof ir){let e=i;if(Pt.includes(e)){console.warn("Video decoder already registered.");return}Pt.push(e)}else if(i.prototype instanceof ar){let e=i;if(Et.includes(e)){console.warn("Audio decoder already registered.");return}Et.push(e)}else throw new TypeError("Decoder must be a CustomVideoDecoder or CustomAudioDecoder.")},Jn=i=>{if(i.prototype instanceof nr){let e=i;if(at.includes(e)){console.warn("Video encoder already registered.");return}at.push(e)}else if(i.prototype instanceof sr){let e=i;if(nt.includes(e)){console.warn("Audio encoder already registered.");return}nt.push(e)}else throw new TypeError("Encoder must be a CustomVideoEncoder or CustomAudioEncoder.")};var ie=new Uint8Array(0),M=class i{constructor(e,t,r,n,a=-1,s){this.data=e;this.type=t;this.timestamp=r;this.duration=n;this.sequenceNumber=a;if(e===ie&&s===void 0)throw new Error("Internal error: byteLength must be explicitly provided when constructing metadata-only packets.");if(s===void 0&&(s=e.byteLength),!(e instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if(t!=="key"&&t!=="delta")throw new TypeError('type must be either "key" or "delta".');if(!Number.isFinite(r))throw new TypeError("timestamp must be a number.");if(!Number.isFinite(n)||n<0)throw new TypeError("duration must be a non-negative number.");if(!Number.isFinite(a))throw new TypeError("sequenceNumber must be a number.");if(!Number.isInteger(s)||s<0)throw new TypeError("byteLength must be a non-negative integer.");this.byteLength=s}get isMetadataOnly(){return this.data===ie}get microsecondTimestamp(){return Math.trunc(Te*this.timestamp)}get microsecondDuration(){return Math.trunc(Te*this.duration)}toEncodedVideoChunk(){if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to a video chunk.");if(typeof EncodedVideoChunk>"u")throw new Error("Your browser does not support EncodedVideoChunk.");return new EncodedVideoChunk({data:this.data,type:this.type,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}toEncodedAudioChunk(){if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to an audio chunk.");if(typeof EncodedAudioChunk>"u")throw new Error("Your browser does not support EncodedAudioChunk.");return new EncodedAudioChunk({data:this.data,type:this.type,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}static fromEncodedChunk(e){if(!(e instanceof EncodedVideoChunk||e instanceof EncodedAudioChunk))throw new TypeError("chunk must be an EncodedVideoChunk or EncodedAudioChunk.");let t=new Uint8Array(e.byteLength);return e.copyTo(t),new i(t,e.type,e.timestamp/1e6,(e.duration??0)/1e6)}clone(e){if(e!==void 0&&(typeof e!="object"||e===null))throw new TypeError("options, when provided, must be an object.");if(e?.timestamp!==void 0&&!Number.isFinite(e.timestamp))throw new TypeError("options.timestamp, when provided, must be a number.");if(e?.duration!==void 0&&!Number.isFinite(e.duration))throw new TypeError("options.duration, when provided, must be a number.");return new i(this.data,this.type,e?.timestamp??this.timestamp,e?.duration??this.duration,this.sequenceNumber,this.byteLength)}};var es=i=>{let r=i,n=4096,a=0,s=12,o=0;for(r<0&&(r=-r,a=128),r+=33,r>8191&&(r=8191);(r&n)!==n&&s>=5;)n>>=1,s--;return o=r>>s-4&15,~(a|s-5<<4|o)&255},ts=i=>{let t=0,r=0,n=~i;n&128&&(n&=-129,t=-1),r=((n&240)>>4)+5;let a=(1<<r|(n&15)<<r-4|1<<r-5)-33;return t===0?a:-a},rs=i=>{let t=2048,r=0,n=11,a=0,s=i;for(s<0&&(s=-s,r=128),s>4095&&(s=4095);(s&t)!==t&&n>=5;)t>>=1,n--;return a=s>>(n===4?1:n-4)&15,(r|n-4<<4|a)^85},is=i=>{let e=0,t=0,r=i^85;r&128&&(r&=-129,e=-1),t=((r&240)>>4)+4;let n=0;return t!==4?n=1<<t|(r&15)<<t-4|1<<t-5:n=r<<1|1,e===0?n:-n};var ne=class i{constructor(e,t){this._closed=!1;if(e instanceof ArrayBuffer||ArrayBuffer.isView(e)){if(!t||typeof t!="object")throw new TypeError("init must be an object.");if(!("format"in t)||typeof t.format!="string")throw new TypeError("init.format must be a string.");if(!Number.isInteger(t.codedWidth)||t.codedWidth<=0)throw new TypeError("init.codedWidth must be a positive integer.");if(!Number.isInteger(t.codedHeight)||t.codedHeight<=0)throw new TypeError("init.codedHeight must be a positive integer.");if(t.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(!Number.isFinite(t.timestamp))throw new TypeError("init.timestamp must be a number.");if(t.duration!==void 0&&(!Number.isFinite(t.duration)||t.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");this._data=K(e).slice(),this.format=t.format,this.codedWidth=t.codedWidth,this.codedHeight=t.codedHeight,this.rotation=t.rotation??0,this.timestamp=t.timestamp,this.duration=t.duration??0,this.colorSpace=new VideoColorSpace(t.colorSpace)}else if(typeof VideoFrame<"u"&&e instanceof VideoFrame){if(t?.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(t?.timestamp!==void 0&&!Number.isFinite(t?.timestamp))throw new TypeError("init.timestamp, when provided, must be a number.");if(t?.duration!==void 0&&(!Number.isFinite(t.duration)||t.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");this._data=e,this.format=e.format,this.codedWidth=e.codedWidth,this.codedHeight=e.codedHeight,this.rotation=t?.rotation??0,this.timestamp=t?.timestamp??e.timestamp/1e6,this.duration=t?.duration??(e.duration??0)/1e6,this.colorSpace=e.colorSpace}else if(typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement||typeof SVGImageElement<"u"&&e instanceof SVGImageElement||typeof ImageBitmap<"u"&&e instanceof ImageBitmap||typeof HTMLVideoElement<"u"&&e instanceof HTMLVideoElement||typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&e instanceof OffscreenCanvas){if(!t||typeof t!="object")throw new TypeError("init must be an object.");if(t.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(!Number.isFinite(t.timestamp))throw new TypeError("init.timestamp must be a number.");if(t.duration!==void 0&&(!Number.isFinite(t.duration)||t.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");if(typeof VideoFrame<"u")return new i(new VideoFrame(e,{timestamp:Math.trunc(t.timestamp*Te),duration:Math.trunc((t.duration??0)*Te)}),t);let r=0,n=0;if("naturalWidth"in e?(r=e.naturalWidth,n=e.naturalHeight):"videoWidth"in e?(r=e.videoWidth,n=e.videoHeight):"width"in e&&(r=Number(e.width),n=Number(e.height)),!r||!n)throw new TypeError("Could not determine dimensions.");let a=new OffscreenCanvas(r,n),s=a.getContext("2d",{alpha:!1,willReadFrequently:!0});m(s),s.drawImage(e,0,0),this._data=a,this.format="RGBX",this.codedWidth=r,this.codedHeight=n,this.rotation=t.rotation??0,this.timestamp=t.timestamp,this.duration=t.duration??0,this.colorSpace=new VideoColorSpace({matrix:"rgb",primaries:"bt709",transfer:"iec61966-2-1",fullRange:!0})}else throw new TypeError("Invalid data type: Must be a BufferSource or CanvasImageSource.")}get displayWidth(){return this.rotation%180===0?this.codedWidth:this.codedHeight}get displayHeight(){return this.rotation%180===0?this.codedHeight:this.codedWidth}get microsecondTimestamp(){return Math.trunc(Te*this.timestamp)}get microsecondDuration(){return Math.trunc(Te*this.duration)}clone(){if(this._closed)throw new Error("VideoSample is closed.");return m(this._data!==null),or(this._data)?new i(this._data.clone(),{timestamp:this.timestamp,duration:this.duration,rotation:this.rotation}):this._data instanceof Uint8Array?new i(this._data.slice(),{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.timestamp,duration:this.duration,colorSpace:this.colorSpace,rotation:this.rotation}):new i(this._data,{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.timestamp,duration:this.duration,colorSpace:this.colorSpace,rotation:this.rotation})}close(){this._closed||(or(this._data)?this._data.close():this._data=null,this._closed=!0)}allocationSize(){if(this._closed)throw new Error("VideoSample is closed.");return m(this._data!==null),or(this._data)?this._data.allocationSize():this._data instanceof Uint8Array?this._data.byteLength:this.codedWidth*this.codedHeight*4}async copyTo(e){if(!ft(e))throw new TypeError("destination must be an ArrayBuffer or an ArrayBuffer view.");if(this._closed)throw new Error("VideoSample is closed.");if(m(this._data!==null),or(this._data))await this._data.copyTo(e);else if(this._data instanceof Uint8Array)K(e).set(this._data);else{let r=this._data.getContext("2d",{alpha:!1});m(r);let n=r.getImageData(0,0,this.codedWidth,this.codedHeight);K(e).set(n.data)}}toVideoFrame(){if(this._closed)throw new Error("VideoSample is closed.");return m(this._data!==null),or(this._data)?new VideoFrame(this._data,{timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0}):this._data instanceof Uint8Array?new VideoFrame(this._data,{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration,colorSpace:this.colorSpace}):new VideoFrame(this._data,{timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}draw(e,t,r,n,a,s,o,c,u){let d=0,l=0,f=this.displayWidth,h=this.displayHeight,p=0,k=0,g=this.displayWidth,b=this.displayHeight;if(s!==void 0?(d=t,l=r,f=n,h=a,p=s,k=o,c!==void 0?(g=c,b=u):(g=f,b=h)):(p=t,k=r,n!==void 0&&(g=n,b=a)),!(typeof CanvasRenderingContext2D<"u"&&e instanceof CanvasRenderingContext2D||typeof OffscreenCanvasRenderingContext2D<"u"&&e instanceof OffscreenCanvasRenderingContext2D))throw new TypeError("context must be a CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D.");if(!Number.isFinite(d))throw new TypeError("sx must be a number.");if(!Number.isFinite(l))throw new TypeError("sy must be a number.");if(!Number.isFinite(f)||f<0)throw new TypeError("sWidth must be a non-negative number.");if(!Number.isFinite(h)||h<0)throw new TypeError("sHeight must be a non-negative number.");if(!Number.isFinite(p))throw new TypeError("dx must be a number.");if(!Number.isFinite(k))throw new TypeError("dy must be a number.");if(!Number.isFinite(g)||g<0)throw new TypeError("dWidth must be a non-negative number.");if(!Number.isFinite(b)||b<0)throw new TypeError("dHeight must be a non-negative number.");if(this._closed)throw new Error("VideoSample is closed.");this.rotation===90?[d,l,f,h]=[l,this.codedHeight-d-f,h,f]:this.rotation===180?[d,l]=[this.codedWidth-d-f,this.codedHeight-l-h]:this.rotation===270&&([d,l,f,h]=[this.codedWidth-l-h,d,h,f]);let w=this.toCanvasImageSource();e.save();let S=p+g/2,x=k+b/2;e.translate(S,x),e.rotate(this.rotation*Math.PI/180);let y=this.rotation%180===0?1:g/b;e.scale(1/y,y),e.drawImage(w,d,l,f,h,-g/2,-b/2,g,b),e.restore()}drawWithFit(e,t){let r=e.canvas.width,n=e.canvas.height,a=t.rotation??this.rotation,s,o,c,u;if(t.fit==="fill")s=0,o=0,c=r,u=n;else{let[l,f]=a%180===0?[this.codedWidth,this.codedHeight]:[this.codedHeight,this.codedWidth],h=t.fit==="contain"?Math.min(r/l,n/f):Math.max(r/l,n/f);c=l*h,u=f*h,s=(r-c)/2,o=(n-u)/2}let d=a%180===0?1:c/u;e.translate(r/2,n/2),e.rotate(a*Math.PI/180),e.scale(1/d,d),e.translate(-r/2,-n/2),e.drawImage(this.toCanvasImageSource(),s,o,c,u)}toCanvasImageSource(){if(this._closed)throw new Error("VideoSample is closed.");if(m(this._data!==null),this._data instanceof Uint8Array){let e=this.toVideoFrame();return queueMicrotask(()=>e.close()),e}else return this._data}setRotation(e){if(![0,90,180,270].includes(e))throw new TypeError("newRotation must be 0, 90, 180, or 270.");this.rotation=e}setTimestamp(e){if(!Number.isFinite(e))throw new TypeError("newTimestamp must be a number.");this.timestamp=e}setDuration(e){if(!Number.isFinite(e)||e<0)throw new TypeError("newDuration must be a non-negative number.");this.duration=e}},or=i=>typeof VideoFrame<"u"&&i instanceof VideoFrame,fa=new Set(["f32","f32-planar","s16","s16-planar","s32","s32-planar","u8","u8-planar"]),se=class i{constructor(e){this._closed=!1;if(dr(e)){if(e.format===null)throw new TypeError("AudioData with null format is not supported.");this._data=e,this.format=e.format,this.sampleRate=e.sampleRate,this.numberOfFrames=e.numberOfFrames,this.numberOfChannels=e.numberOfChannels,this.timestamp=e.timestamp/1e6,this.duration=e.numberOfFrames/e.sampleRate}else{if(!e||typeof e!="object")throw new TypeError("Invalid AudioDataInit: must be an object.");if(!fa.has(e.format))throw new TypeError("Invalid AudioDataInit: invalid format.");if(!Number.isFinite(e.sampleRate)||e.sampleRate<=0)throw new TypeError("Invalid AudioDataInit: sampleRate must be > 0.");if(!Number.isInteger(e.numberOfChannels)||e.numberOfChannels===0)throw new TypeError("Invalid AudioDataInit: numberOfChannels must be an integer > 0.");if(!Number.isFinite(e?.timestamp))throw new TypeError("init.timestamp must be a number.");let t=e.data.byteLength/(cr(e.format)*e.numberOfChannels);if(!Number.isInteger(t))throw new TypeError("Invalid AudioDataInit: data size is not a multiple of frame size.");this.format=e.format,this.sampleRate=e.sampleRate,this.numberOfFrames=t,this.numberOfChannels=e.numberOfChannels,this.timestamp=e.timestamp,this.duration=t/e.sampleRate;let r;if(e.data instanceof ArrayBuffer)r=new Uint8Array(e.data);else if(ArrayBuffer.isView(e.data))r=new Uint8Array(e.data.buffer,e.data.byteOffset,e.data.byteLength);else throw new TypeError("Invalid AudioDataInit: data is not a BufferSource.");let n=this.numberOfFrames*this.numberOfChannels*cr(this.format);if(r.byteLength<n)throw new TypeError("Invalid AudioDataInit: insufficient data size.");this._data=r}}get microsecondTimestamp(){return Math.trunc(Te*this.timestamp)}get microsecondDuration(){return Math.trunc(Te*this.duration)}allocationSize(e){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(!Number.isInteger(e.planeIndex)||e.planeIndex<0)throw new TypeError("planeIndex must be a non-negative integer.");if(e.format!==void 0&&!fa.has(e.format))throw new TypeError("Invalid format.");if(e.frameOffset!==void 0&&(!Number.isInteger(e.frameOffset)||e.frameOffset<0))throw new TypeError("frameOffset must be a non-negative integer.");if(e.frameCount!==void 0&&(!Number.isInteger(e.frameCount)||e.frameCount<0))throw new TypeError("frameCount must be a non-negative integer.");if(this._closed)throw new Error("AudioSample is closed.");let t=e.format??this.format,r=e.frameOffset??0;if(r>=this.numberOfFrames)throw new RangeError("frameOffset out of range");let n=e.frameCount!==void 0?e.frameCount:this.numberOfFrames-r;if(n>this.numberOfFrames-r)throw new RangeError("frameCount out of range");let a=cr(t),s=pi(t);if(s&&e.planeIndex>=this.numberOfChannels)throw new RangeError("planeIndex out of range");if(!s&&e.planeIndex!==0)throw new RangeError("planeIndex out of range");return(s?n:n*this.numberOfChannels)*a}copyTo(e,t){if(!ft(e))throw new TypeError("destination must be an ArrayBuffer or an ArrayBuffer view.");if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(!Number.isInteger(t.planeIndex)||t.planeIndex<0)throw new TypeError("planeIndex must be a non-negative integer.");if(t.format!==void 0&&!fa.has(t.format))throw new TypeError("Invalid format.");if(t.frameOffset!==void 0&&(!Number.isInteger(t.frameOffset)||t.frameOffset<0))throw new TypeError("frameOffset must be a non-negative integer.");if(t.frameCount!==void 0&&(!Number.isInteger(t.frameCount)||t.frameCount<0))throw new TypeError("frameCount must be a non-negative integer.");if(this._closed)throw new Error("AudioSample is closed.");let{planeIndex:r,format:n,frameCount:a,frameOffset:s}=t,o=n??this.format;if(!o)throw new Error("Destination format not determined");let c=this.numberOfFrames,u=this.numberOfChannels,d=s??0;if(d>=c)throw new RangeError("frameOffset out of range");let l=a!==void 0?a:c-d;if(l>c-d)throw new RangeError("frameCount out of range");let f=cr(o),h=pi(o);if(h&&r>=u)throw new RangeError("planeIndex out of range");if(!h&&r!==0)throw new RangeError("planeIndex out of range");let k=(h?l:l*u)*f;if(e.byteLength<k)throw new RangeError("Destination buffer is too small");let g=re(e),b=tc(o);if(dr(this._data))if(h)if(o==="f32-planar")this._data.copyTo(e,{planeIndex:r,frameOffset:d,frameCount:l,format:"f32-planar"});else{let w=new ArrayBuffer(l*4),S=new Float32Array(w);this._data.copyTo(S,{planeIndex:r,frameOffset:d,frameCount:l,format:"f32-planar"});let x=new DataView(w);for(let y=0;y<l;y++){let T=y*f,C=x.getFloat32(y*4,!0);b(g,T,C)}}else{let w=u,S=new Float32Array(l);for(let x=0;x<w;x++){this._data.copyTo(S,{planeIndex:x,frameOffset:d,frameCount:l,format:"f32-planar"});for(let y=0;y<l;y++){let C=(y*w+x)*f;b(g,C,S[y])}}}else{let w=this._data,S=new DataView(w.buffer,w.byteOffset,w.byteLength),x=this.format,y=ec(x),T=cr(x),C=pi(x);for(let P=0;P<l;P++)if(h){let E=P*f,_;C?_=(r*c+(P+d))*T:_=((P+d)*u+r)*T;let A=y(S,_);b(g,E,A)}else for(let E=0;E<u;E++){let A=(P*u+E)*f,V;C?V=(E*c+(P+d))*T:V=((P+d)*u+E)*T;let H=y(S,V);b(g,A,H)}}}clone(){if(this._closed)throw new Error("AudioSample is closed.");if(dr(this._data)){let e=new i(this._data.clone());return e.setTimestamp(this.timestamp),e}else return new i({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.timestamp,data:this._data})}close(){this._closed||(dr(this._data)?this._data.close():this._data=new Uint8Array(0),this._closed=!0)}toAudioData(){if(this._closed)throw new Error("AudioSample is closed.");if(dr(this._data)){if(this._data.timestamp===this.microsecondTimestamp)return this._data.clone();if(pi(this.format)){let e=this.allocationSize({planeIndex:0,format:this.format}),t=new ArrayBuffer(e*this.numberOfChannels);for(let r=0;r<this.numberOfChannels;r++)this.copyTo(new Uint8Array(t,r*e,e),{planeIndex:r,format:this.format});return new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:t})}else{let e=new ArrayBuffer(this.allocationSize({planeIndex:0,format:this.format}));return this.copyTo(e,{planeIndex:0,format:this.format}),new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:e})}}else return new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:this._data})}toAudioBuffer(){if(this._closed)throw new Error("AudioSample is closed.");let e=new AudioBuffer({numberOfChannels:this.numberOfChannels,length:this.numberOfFrames,sampleRate:this.sampleRate}),t=new Float32Array(this.allocationSize({planeIndex:0,format:"f32-planar"})/4);for(let r=0;r<this.numberOfChannels;r++)this.copyTo(t,{planeIndex:r,format:"f32-planar"}),e.copyToChannel(t,r);return e}setTimestamp(e){if(!Number.isFinite(e))throw new TypeError("newTimestamp must be a number.");this.timestamp=e}static*_fromAudioBuffer(e,t){if(!(e instanceof AudioBuffer))throw new TypeError("audioBuffer must be an AudioBuffer.");let r=48e3*5,n=e.numberOfChannels,a=e.sampleRate,s=e.length,o=Math.floor(r/n),c=0,u=s;for(;u>0;){let d=Math.min(o,u),l=new Float32Array(n*d);for(let f=0;f<n;f++)e.copyFromChannel(l.subarray(f*d,(f+1)*d),f,c);yield new i({format:"f32-planar",sampleRate:a,numberOfFrames:d,numberOfChannels:n,timestamp:t+c/a,data:l}),c+=d,u-=d}}static fromAudioBuffer(e,t){if(!(e instanceof AudioBuffer))throw new TypeError("audioBuffer must be an AudioBuffer.");let r=48e3*5,n=e.numberOfChannels,a=e.sampleRate,s=e.length,o=Math.floor(r/n),c=0,u=s,d=[];for(;u>0;){let l=Math.min(o,u),f=new Float32Array(n*l);for(let p=0;p<n;p++)e.copyFromChannel(f.subarray(p*l,(p+1)*l),p,c);let h=new i({format:"f32-planar",sampleRate:a,numberOfFrames:l,numberOfChannels:n,timestamp:t+c/a,data:f});d.push(h),c+=l,u-=l}return d}},cr=i=>{switch(i){case"u8":case"u8-planar":return 1;case"s16":case"s16-planar":return 2;case"s32":case"s32-planar":return 4;case"f32":case"f32-planar":return 4;default:throw new Error("Unknown AudioSampleFormat")}},pi=i=>{switch(i){case"u8-planar":case"s16-planar":case"s32-planar":case"f32-planar":return!0;default:return!1}},ec=i=>{switch(i){case"u8":case"u8-planar":return(e,t)=>(e.getUint8(t)-128)/128;case"s16":case"s16-planar":return(e,t)=>e.getInt16(t,!0)/32768;case"s32":case"s32-planar":return(e,t)=>e.getInt32(t,!0)/2147483648;case"f32":case"f32-planar":return(e,t)=>e.getFloat32(t,!0)}},tc=i=>{switch(i){case"u8":case"u8-planar":return(e,t,r)=>e.setUint8(t,J((r+1)*127.5,0,255));case"s16":case"s16-planar":return(e,t,r)=>e.setInt16(t,J(Math.round(r*32767),-32768,32767),!0);case"s32":case"s32-planar":return(e,t,r)=>e.setInt32(t,J(Math.round(r*2147483647),-2147483648,2147483647),!0);case"f32":case"f32-planar":return(e,t,r)=>e.setFloat32(t,r,!0)}},dr=i=>typeof AudioData<"u"&&i instanceof AudioData;var It=i=>{if(!i||typeof i!="object")throw new TypeError("options must be an object.");if(i.metadataOnly!==void 0&&typeof i.metadataOnly!="boolean")throw new TypeError("options.metadataOnly, when defined, must be a boolean.");if(i.verifyKeyPackets!==void 0&&typeof i.verifyKeyPackets!="boolean")throw new TypeError("options.verifyKeyPackets, when defined, must be a boolean.");if(i.verifyKeyPackets&&i.metadataOnly)throw new TypeError("options.verifyKeyPackets and options.metadataOnly cannot be enabled together.")},De=i=>{if(typeof i!="number"||Number.isNaN(i))throw new TypeError("timestamp must be a number.")},pa=(i,e,t)=>t.verifyKeyPackets?e.then(async r=>{if(!r||r.type==="delta")return r;let n=await i.determinePacketType(r);return n&&(r.type=n),r}):e,we=class{constructor(e){if(!(e instanceof Ke))throw new TypeError("track must be an InputTrack.");this._track=e}getFirstPacket(e={}){return It(e),pa(this._track,this._track._backing.getFirstPacket(e),e)}getPacket(e,t={}){return De(e),It(t),pa(this._track,this._track._backing.getPacket(e,t),t)}getNextPacket(e,t={}){if(!(e instanceof M))throw new TypeError("packet must be an EncodedPacket.");return It(t),pa(this._track,this._track._backing.getNextPacket(e,t),t)}async getKeyPacket(e,t={}){if(De(e),It(t),!t.verifyKeyPackets)return this._track._backing.getKeyPacket(e,t);let r=await this._track._backing.getKeyPacket(e,t);return!r||r.type==="delta"?r:await this._track.determinePacketType(r)==="delta"?this.getKeyPacket(r.timestamp-1/this._track.timeResolution,t):r}async getNextKeyPacket(e,t={}){if(!(e instanceof M))throw new TypeError("packet must be an EncodedPacket.");if(It(t),!t.verifyKeyPackets)return this._track._backing.getNextKeyPacket(e,t);let r=await this._track._backing.getNextKeyPacket(e,t);return!r||r.type==="delta"?r:await this._track.determinePacketType(r)==="delta"?this.getNextKeyPacket(r,t):r}packets(e,t,r={}){if(e!==void 0&&!(e instanceof M))throw new TypeError("startPacket must be an EncodedPacket.");if(e!==void 0&&e.isMetadataOnly&&!r?.metadataOnly)throw new TypeError("startPacket can only be metadata-only if options.metadataOnly is enabled.");if(t!==void 0&&!(t instanceof M))throw new TypeError("endPacket must be an EncodedPacket.");It(r);let n=[],{promise:a,resolve:s}=L(),{promise:o,resolve:c}=L(),u=!1,d=!1,l=null,f=[],h=()=>Math.max(2,f.length);return(async()=>{let p=e??await this.getFirstPacket(r);for(;p&&!d&&!(t&&p.sequenceNumber>=t?.sequenceNumber);){if(n.length>h()){({promise:o,resolve:c}=L()),await o;continue}n.push(p),s(),{promise:a,resolve:s}=L(),p=await this.getNextPacket(p,r)}u=!0,s()})().catch(p=>{l||(l=p,s())}),{async next(){for(;;){if(d)return{value:void 0,done:!0};if(l)throw l;if(n.length>0){let p=n.shift(),k=performance.now();for(f.push(k);f.length>0&&k-f[0]>=1e3;)f.shift();return c(),{value:p,done:!1}}else{if(u)return{value:void 0,done:!0};await a}}},async return(){return d=!0,c(),s(),{value:void 0,done:!0}},async throw(p){throw p},[Symbol.asyncIterator](){return this}}}},ur=class{constructor(e,t){this.onSample=e;this.onError=t}},_t=class{mediaSamplesInRange(e=0,t=1/0){De(e),De(t);let r=[],n=!1,a=null,{promise:s,resolve:o}=L(),{promise:c,resolve:u}=L(),d=!1,l=!1,f=!1,h=null;return(async()=>{let p=new Error,k=await this._createDecoder(y=>{if(u(),y.timestamp>=t&&(l=!0),l){y.close();return}a&&(y.timestamp>e?(r.push(a),n=!0):a.close()),y.timestamp>=e&&(r.push(y),n=!0),a=n?null:y,r.length>0&&(o(),{promise:s,resolve:o}=L())},y=>{h||(y.stack=p.stack,h=y,o())}),g=this._createPacketSink(),b=await g.getKeyPacket(e,{verifyKeyPackets:!0})??await g.getFirstPacket();if(!b)return;let w=b,S;if(t<1/0){let y=await g.getPacket(t),T=y?y.type==="key"&&y.timestamp===t?y:await g.getNextKeyPacket(y,{verifyKeyPackets:!0}):null;T&&(S=T)}let x=g.packets(b,S);for(await x.next();w&&!l;){let y=as(r.length);if(r.length+k.getDecodeQueueSize()>y){({promise:c,resolve:u}=L()),await c;continue}k.decode(w);let T=await x.next();if(T.done)break;w=T.value}await x.return(),f||await k.flush(),k.close(),!n&&a&&r.push(a),d=!0,o()})().catch(p=>{h||(h=p,o())}),{async next(){for(;;){if(f)return{value:void 0,done:!0};if(h)throw h;if(r.length>0){let p=r.shift();return u(),{value:p,done:!1}}else if(!d)await s;else return{value:void 0,done:!0}}},async return(){f=!0,l=!0,u(),o(),a?.close();for(let p of r)p.close();return{value:void 0,done:!0}},async throw(p){throw p},[Symbol.asyncIterator](){return this}}}mediaSamplesAtTimestamps(e){Ya(e);let t=Xa(e),r=[],n=[],{promise:a,resolve:s}=L(),{promise:o,resolve:c}=L(),u=!1,d=!1,l=null,f=h=>{n.push(h),s(),{promise:a,resolve:s}=L()};return(async()=>{let h=new Error,p=await this._createDecoder(y=>{if(c(),d){y.close();return}let T=0;for(;r.length>0&&y.timestamp-r[0]>-1e-10;)T++,r.shift();if(T>0)for(let C=0;C<T;C++)f(C<T-1?y.clone():y);else y.close()},y=>{l||(y.stack=h.stack,l=y,s())}),k=this._createPacketSink(),g=null,b=null,w=-1,S=async()=>{m(b);let y=b;for(p.decode(y);y.sequenceNumber<w;){let T=as(n.length);for(;n.length+p.getDecodeQueueSize()>T&&!d;)({promise:o,resolve:c}=L()),await o;if(d)break;let C=await k.getNextPacket(y);m(C),y=C,p.decode(C)}w=-1},x=async()=>{await p.flush();for(let y=0;y<r.length;y++)f(null);r.length=0};for await(let y of t){if(De(y),d)break;let T=await k.getPacket(y),C=T&&await k.getKeyPacket(y,{verifyKeyPackets:!0});if(!C){w!==-1&&(await S(),await x()),f(null),g=null;continue}g&&(C.sequenceNumber!==b.sequenceNumber||T.timestamp<g.timestamp)&&(await S(),await x()),r.push(T.timestamp),w=Math.max(T.sequenceNumber,w),g=T,b=C}d||(w!==-1&&await S(),await x()),p.close(),u=!0,s()})().catch(h=>{l||(l=h,s())}),{async next(){for(;;){if(d)return{value:void 0,done:!0};if(l)throw l;if(n.length>0){let h=n.shift();return m(h!==void 0),c(),{value:h,done:!1}}else if(!u)await a;else return{value:void 0,done:!0}}},async return(){d=!0,c(),s();for(let h of n)h?.close();return{value:void 0,done:!0}},async throw(h){throw h},[Symbol.asyncIterator](){return this}}}},as=i=>i===0?40:8,ha=class extends ur{constructor(t,r,n,a,s,o){super(t,r);this.rotation=s;this.timeResolution=o;this.decoder=null;this.customDecoder=null;this.customDecoderCallSerializer=new Ve;this.customDecoderQueueSize=0;this.inputTimestamps=[];this.sampleQueue=[];let c=Pt.find(u=>u.supports(n,a));if(c)this.customDecoder=new c,this.customDecoder.codec=n,this.customDecoder.config=a,this.customDecoder.onSample=u=>{if(!(u instanceof ne))throw new TypeError("The argument passed to onSample must be a VideoSample.");this.finalizeAndEmitSample(u)},this.customDecoderCallSerializer.call(()=>this.customDecoder.init());else{let u=d=>{if(Rr()){if(this.sampleQueue.length>0&&d.timestamp>=z(this.sampleQueue).timestamp){for(let l of this.sampleQueue)this.finalizeAndEmitSample(l);this.sampleQueue.length=0}be(this.sampleQueue,d,l=>l.timestamp)}else{let l=this.inputTimestamps.shift();m(l!==void 0),d.setTimestamp(l),this.finalizeAndEmitSample(d)}};this.decoder=new VideoDecoder({output:d=>u(new ne(d)),error:r}),this.decoder.configure(a)}}finalizeAndEmitSample(t){t.setTimestamp(Math.round(t.timestamp*this.timeResolution)/this.timeResolution),t.setDuration(Math.round(t.duration*this.timeResolution)/this.timeResolution),t.setRotation(this.rotation),this.onSample(t)}getDecodeQueueSize(){return this.customDecoder?this.customDecoderQueueSize:(m(this.decoder),this.decoder.decodeQueueSize)}decode(t){this.customDecoder?(this.customDecoderQueueSize++,this.customDecoderCallSerializer.call(()=>this.customDecoder.decode(t)).then(()=>this.customDecoderQueueSize--)):(m(this.decoder),Rr()||be(this.inputTimestamps,t.timestamp,r=>r),this.decoder.decode(t.toEncodedVideoChunk()))}async flush(){if(this.customDecoder?await this.customDecoderCallSerializer.call(()=>this.customDecoder.flush()):(m(this.decoder),await this.decoder.flush()),Rr()){for(let t of this.sampleQueue)this.finalizeAndEmitSample(t);this.sampleQueue.length=0}}close(){this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.close()):(m(this.decoder),this.decoder.close());for(let t of this.sampleQueue)t.close();this.sampleQueue.length=0}},st=class extends _t{constructor(e){if(!(e instanceof me))throw new TypeError("videoTrack must be an InputVideoTrack.");super(),this._videoTrack=e}async _createDecoder(e,t){if(!await this._videoTrack.canDecode())throw new Error("This video track cannot be decoded by this browser. Make sure to check decodability before using a track.");let r=this._videoTrack.codec,n=this._videoTrack.rotation,a=await this._videoTrack.getDecoderConfig(),s=this._videoTrack.timeResolution;return m(r&&a),new ha(e,t,r,a,n,s)}_createPacketSink(){return new we(this._videoTrack)}async getSample(e){De(e);for await(let t of this.mediaSamplesAtTimestamps([e]))return t;throw new Error("Internal error: Iterator returned nothing.")}samples(e=0,t=1/0){return this.mediaSamplesInRange(e,t)}samplesAtTimestamps(e){return this.mediaSamplesAtTimestamps(e)}},At=class{constructor(e,t={}){this._nextCanvasIndex=0;if(!(e instanceof me))throw new TypeError("videoTrack must be an InputVideoTrack.");if(t&&typeof t!="object")throw new TypeError("options must be an object.");if(t.width!==void 0&&(!Number.isInteger(t.width)||t.width<=0))throw new TypeError("options.width, when defined, must be a positive integer.");if(t.height!==void 0&&(!Number.isInteger(t.height)||t.height<=0))throw new TypeError("options.height, when defined, must be a positive integer.");if(t.fit!==void 0&&!["fill","contain","cover"].includes(t.fit))throw new TypeError('options.fit, when provided, must be one of "fill", "contain", or "cover".');if(t.width!==void 0&&t.height!==void 0&&t.fit===void 0)throw new TypeError("When both options.width and options.height are provided, options.fit must also be provided.");if(t.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("options.rotation, when provided, must be 0, 90, 180 or 270.");if(t.poolSize!==void 0&&(typeof t.poolSize!="number"||!Number.isInteger(t.poolSize)||t.poolSize<0))throw new TypeError("poolSize must be a non-negative integer.");let r=t.rotation??e.rotation,[n,a]=r%180===0?[e.codedWidth,e.codedHeight]:[e.codedHeight,e.codedWidth],s=n/a;t.width!==void 0&&t.height===void 0?(n=t.width,a=Math.round(n/s)):t.width===void 0&&t.height!==void 0?(a=t.height,n=Math.round(a*s)):t.width!==void 0&&t.height!==void 0&&(n=t.width,a=t.height),this._videoTrack=e,this._width=n,this._height=a,this._rotation=r,this._fit=t.fit??"fill",this._videoSampleSink=new st(e),this._canvasPool=Array.from({length:t.poolSize??0},()=>null)}_videoSampleToWrappedCanvas(e){let t=this._canvasPool[this._nextCanvasIndex],r=!1;t||(typeof document<"u"?(t=document.createElement("canvas"),t.width=this._width,t.height=this._height):t=new OffscreenCanvas(this._width,this._height),this._canvasPool.length>0&&(this._canvasPool[this._nextCanvasIndex]=t),r=!0),this._canvasPool.length>0&&(this._nextCanvasIndex=(this._nextCanvasIndex+1)%this._canvasPool.length);let n=t.getContext("2d",{alpha:!1});m(n),n.resetTransform(),r||n.clearRect(0,0,this._width,this._height),e.drawWithFit(n,{fit:this._fit,rotation:this._rotation});let a={canvas:t,timestamp:e.timestamp,duration:e.duration};return e.close(),a}async getCanvas(e){De(e);let t=await this._videoSampleSink.getSample(e);return t&&this._videoSampleToWrappedCanvas(t)}canvases(e=0,t=1/0){return Kt(this._videoSampleSink.samples(e,t),r=>this._videoSampleToWrappedCanvas(r))}canvasesAtTimestamps(e){return Kt(this._videoSampleSink.samplesAtTimestamps(e),t=>t&&this._videoSampleToWrappedCanvas(t))}},ga=class extends ur{constructor(t,r,n,a){super(t,r);this.decoder=null;this.customDecoder=null;this.customDecoderCallSerializer=new Ve;this.customDecoderQueueSize=0;let s=c=>{if(c.numberOfFrames===0){c.close();return}let u=a.sampleRate;c.setTimestamp(Math.round(c.timestamp*u)/u),t(c)},o=Et.find(c=>c.supports(n,a));o?(this.customDecoder=new o,this.customDecoder.codec=n,this.customDecoder.config=a,this.customDecoder.onSample=c=>{if(!(c instanceof se))throw new TypeError("The argument passed to onSample must be an AudioSample.");s(c)},this.customDecoderCallSerializer.call(()=>this.customDecoder.init())):(this.decoder=new AudioDecoder({output:c=>s(new se(c)),error:r}),this.decoder.configure(a))}getDecodeQueueSize(){return this.customDecoder?this.customDecoderQueueSize:(m(this.decoder),this.decoder.decodeQueueSize)}decode(t){this.customDecoder?(this.customDecoderQueueSize++,this.customDecoderCallSerializer.call(()=>this.customDecoder.decode(t)).then(()=>this.customDecoderQueueSize--)):(m(this.decoder),this.decoder.decode(t.toEncodedAudioChunk()))}flush(){return this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.flush()):(m(this.decoder),this.decoder.flush())}close(){this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.close()):(m(this.decoder),this.decoder.close())}},ba=class extends ur{constructor(t,r,n){super(t,r);this.decoderConfig=n;this.currentTimestamp=null;m(U.includes(n.codec)),this.codec=n.codec;let{dataType:a,sampleSize:s,littleEndian:o}=ee(this.codec);switch(this.inputSampleSize=s,s){case 1:a==="unsigned"?this.readInputValue=(c,u)=>c.getUint8(u)-2**7:a==="signed"?this.readInputValue=(c,u)=>c.getInt8(u):a==="ulaw"?this.readInputValue=(c,u)=>ts(c.getUint8(u)):a==="alaw"?this.readInputValue=(c,u)=>is(c.getUint8(u)):m(!1);break;case 2:a==="unsigned"?this.readInputValue=(c,u)=>c.getUint16(u,o)-2**15:a==="signed"?this.readInputValue=(c,u)=>c.getInt16(u,o):m(!1);break;case 3:a==="unsigned"?this.readInputValue=(c,u)=>Yi(c,u,o)-2**23:a==="signed"?this.readInputValue=(c,u)=>Za(c,u,o):m(!1);break;case 4:a==="unsigned"?this.readInputValue=(c,u)=>c.getUint32(u,o)-2**31:a==="signed"?this.readInputValue=(c,u)=>c.getInt32(u,o):a==="float"?this.readInputValue=(c,u)=>c.getFloat32(u,o):m(!1);break;case 8:a==="float"?this.readInputValue=(c,u)=>c.getFloat64(u,o):m(!1);break;default:ke(s),m(!1)}switch(s){case 1:a==="ulaw"||a==="alaw"?(this.outputSampleSize=2,this.outputFormat="s16",this.writeOutputValue=(c,u,d)=>c.setInt16(u,d,!0)):(this.outputSampleSize=1,this.outputFormat="u8",this.writeOutputValue=(c,u,d)=>c.setUint8(u,d+2**7));break;case 2:this.outputSampleSize=2,this.outputFormat="s16",this.writeOutputValue=(c,u,d)=>c.setInt16(u,d,!0);break;case 3:this.outputSampleSize=4,this.outputFormat="s32",this.writeOutputValue=(c,u,d)=>c.setInt32(u,d<<8,!0);break;case 4:this.outputSampleSize=4,a==="float"?(this.outputFormat="f32",this.writeOutputValue=(c,u,d)=>c.setFloat32(u,d,!0)):(this.outputFormat="s32",this.writeOutputValue=(c,u,d)=>c.setInt32(u,d,!0));break;case 8:this.outputSampleSize=4,this.outputFormat="f32",this.writeOutputValue=(c,u,d)=>c.setFloat32(u,d,!0);break;default:ke(s),m(!1)}}getDecodeQueueSize(){return 0}decode(t){let r=re(t.data),n=t.byteLength/this.decoderConfig.numberOfChannels/this.inputSampleSize,a=n*this.decoderConfig.numberOfChannels*this.outputSampleSize,s=new ArrayBuffer(a),o=new DataView(s);for(let l=0;l<n*this.decoderConfig.numberOfChannels;l++){let f=l*this.inputSampleSize,h=l*this.outputSampleSize,p=this.readInputValue(r,f);this.writeOutputValue(o,h,p)}let c=n/this.decoderConfig.sampleRate;(this.currentTimestamp===null||Math.abs(t.timestamp-this.currentTimestamp)>=c)&&(this.currentTimestamp=t.timestamp);let u=this.currentTimestamp;this.currentTimestamp+=c;let d=new se({format:this.outputFormat,data:s,numberOfChannels:this.decoderConfig.numberOfChannels,sampleRate:this.decoderConfig.sampleRate,numberOfFrames:n,timestamp:u});this.onSample(d)}async flush(){}close(){}},He=class extends _t{constructor(e){if(!(e instanceof $))throw new TypeError("audioTrack must be an InputAudioTrack.");super(),this._audioTrack=e}async _createDecoder(e,t){if(!await this._audioTrack.canDecode())throw new Error("This audio track cannot be decoded by this browser. Make sure to check decodability before using a track.");let r=this._audioTrack.codec,n=await this._audioTrack.getDecoderConfig();return m(r&&n),U.includes(n.codec)?new ba(e,t,n):new ga(e,t,r,n)}_createPacketSink(){return new we(this._audioTrack)}async getSample(e){De(e);for await(let t of this.mediaSamplesAtTimestamps([e]))return t;throw new Error("Internal error: Iterator returned nothing.")}samples(e=0,t=1/0){return this.mediaSamplesInRange(e,t)}samplesAtTimestamps(e){return this.mediaSamplesAtTimestamps(e)}},hi=class{constructor(e){if(!(e instanceof $))throw new TypeError("audioTrack must be an InputAudioTrack.");this._audioSampleSink=new He(e)}_audioSampleToWrappedArrayBuffer(e){return{buffer:e.toAudioBuffer(),timestamp:e.timestamp,duration:e.duration}}async getBuffer(e){De(e);let t=await this._audioSampleSink.getSample(e);return t&&this._audioSampleToWrappedArrayBuffer(t)}buffers(e=0,t=1/0){return Kt(this._audioSampleSink.samples(e,t),r=>this._audioSampleToWrappedArrayBuffer(r))}buffersAtTimestamps(e){return Kt(this._audioSampleSink.samplesAtTimestamps(e),t=>t&&this._audioSampleToWrappedArrayBuffer(t))}};var Ke=class{constructor(e){this._backing=e}isVideoTrack(){return this instanceof me}isAudioTrack(){return this instanceof $}get id(){return this._backing.getId()}get internalCodecId(){return this._backing.getInternalCodecId()}get languageCode(){return this._backing.getLanguageCode()}get name(){return this._backing.getName()}get timeResolution(){return this._backing.getTimeResolution()}getFirstTimestamp(){return this._backing.getFirstTimestamp()}computeDuration(){return this._backing.computeDuration()}async computePacketStats(e=1/0){let t=new we(this),r=1/0,n=-1/0,a=0,s=0;for await(let o of t.packets(void 0,void 0,{metadataOnly:!0})){if(a>=e&&o.timestamp>=n)break;r=Math.min(r,o.timestamp),n=Math.max(n,o.timestamp+o.duration),a++,s+=o.byteLength}return{packetCount:a,averagePacketRate:a?Number((a/(n-r)).toPrecision(16)):0,averageBitrate:a?Number((8*s/(n-r)).toPrecision(16)):0}}},me=class extends Ke{constructor(e){super(e),this._backing=e}get type(){return"video"}get codec(){return this._backing.getCodec()}get codedWidth(){return this._backing.getCodedWidth()}get codedHeight(){return this._backing.getCodedHeight()}get rotation(){return this._backing.getRotation()}get displayWidth(){return this._backing.getRotation()%180===0?this._backing.getCodedWidth():this._backing.getCodedHeight()}get displayHeight(){return this._backing.getRotation()%180===0?this._backing.getCodedHeight():this._backing.getCodedWidth()}getColorSpace(){return this._backing.getColorSpace()}async hasHighDynamicRange(){let e=await this._backing.getColorSpace();return e.primaries==="bt2020"||e.primaries==="smpte432"||e.transfer==="pg"||e.transfer==="hlg"||e.matrix==="bt2020-ncl"}getDecoderConfig(){return this._backing.getDecoderConfig()}async getCodecParameterString(){return(await this._backing.getDecoderConfig())?.codec??null}async canDecode(){try{let e=await this._backing.getDecoderConfig();if(!e)return!1;let t=this._backing.getCodec();return m(t!==null),Pt.some(n=>n.supports(t,e))?!0:typeof VideoDecoder>"u"?!1:(await VideoDecoder.isConfigSupported(e)).supported===!0}catch(e){return console.error("Error during decodability check:",e),!1}}async determinePacketType(e){if(!(e instanceof M))throw new TypeError("packet must be an EncodedPacket.");if(e.isMetadataOnly)throw new TypeError("packet must not be metadata-only to determine its type.");return this.codec===null?null:_n(this,e)}},$=class extends Ke{constructor(e){super(e),this._backing=e}get type(){return"audio"}get codec(){return this._backing.getCodec()}get numberOfChannels(){return this._backing.getNumberOfChannels()}get sampleRate(){return this._backing.getSampleRate()}getDecoderConfig(){return this._backing.getDecoderConfig()}async getCodecParameterString(){return(await this._backing.getDecoderConfig())?.codec??null}async canDecode(){try{let e=await this._backing.getDecoderConfig();if(!e)return!1;let t=this._backing.getCodec();return m(t!==null),Et.some(r=>r.supports(t,e))||e.codec.startsWith("pcm-")?!0:typeof AudioDecoder>"u"?!1:(await AudioDecoder.isConfigSupported(e)).supported===!0}catch(e){return console.error("Error during decodability check:",e),!1}}async determinePacketType(e){if(!(e instanceof M))throw new TypeError("packet must be an EncodedPacket.");return this.codec===null?null:"key"}};var fe=class{constructor(e,t=1/0){this.source=e;this.maxStorableBytes=t;this.loadedSegments=[];this.loadingSegments=[];this.sourceSizePromise=null;this.nextAge=0;this.totalStoredBytes=0}async loadRange(e,t){if(t=Math.min(t,await this.source.getSize()),e>=t)return;let r=this.loadingSegments.find(c=>c.start<=e&&c.end>=t);if(r){await r.promise;return}let n=B(this.loadedSegments,e,c=>c.start);if(n!==-1)for(let c=n;c<this.loadedSegments.length;c++){let u=this.loadedSegments[c];if(u.start>e)break;if(u.end>=t)return}this.source.onread?.(e,t);let a=this.source._read(e,t),s={start:e,end:t,promise:a};this.loadingSegments.push(s);let o=await a;Ga(this.loadingSegments,s),this.insertIntoLoadedSegments(e,o)}rangeIsLoaded(e,t){if(t<=e)return!0;let r=B(this.loadedSegments,e,n=>n.start);if(r===-1)return!1;for(let n=r;n<this.loadedSegments.length;n++){let a=this.loadedSegments[n];if(a.start>e)break;if(a.end>=t)return!0}return!1}insertIntoLoadedSegments(e,t){let r={start:e,end:e+t.byteLength,bytes:t,view:new DataView(t.buffer),age:this.nextAge++},n=B(this.loadedSegments,e,a=>a.start);(n===-1||this.loadedSegments[n].start<r.start)&&n++,this.loadedSegments.splice(n,0,r),this.totalStoredBytes+=t.byteLength;for(let a=n+1;a<this.loadedSegments.length;a++){let s=this.loadedSegments[a];if(s.start>=r.end)break;r.start<=s.start&&s.end<=r.end&&(this.loadedSegments.splice(a,1),a--)}for(;this.totalStoredBytes>this.maxStorableBytes&&this.loadedSegments.length>1;){let a=null,s=-1;for(let o=0;o<this.loadedSegments.length;o++){let c=this.loadedSegments[o];(!a||c.age<a.age)&&(a=c,s=o)}m(a),this.totalStoredBytes-=a.bytes.byteLength,this.loadedSegments.splice(s,1)}}getViewAndOffset(e,t){let r=B(this.loadedSegments,e,a=>a.start),n=null;if(r!==-1)for(let a=r;a<this.loadedSegments.length;a++){let s=this.loadedSegments[a];if(s.start>e)break;if(t<=s.end){n=s;break}}if(!n)throw new Error(`No segment loaded for range [${e}, ${t}).`);return n.age=this.nextAge++,{view:n.view,offset:n.bytes.byteOffset+e-n.start}}forgetRange(e,t){if(t<=e)return;let r=B(this.loadedSegments,e,a=>a.start);if(r===-1)return;let n=this.loadedSegments[r];n.start!==e||n.end!==t||(this.loadedSegments.splice(r,1),this.totalStoredBytes-=n.bytes.byteLength)}};var ot=class{constructor(e){this.reader=e;this.pos=0;this.littleEndian=!0}readBytes(e){let{view:t,offset:r}=this.reader.getViewAndOffset(this.pos,this.pos+e);return this.pos+=e,new Uint8Array(t.buffer,r,e)}readU16(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+2);return this.pos+=2,e.getUint16(t,this.littleEndian)}readU32(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+4);return this.pos+=4,e.getUint32(t,this.littleEndian)}readU64(){let e,t;return this.littleEndian?(e=this.readU32(),t=this.readU32()):(t=this.readU32(),e=this.readU32()),t*4294967296+e}readAscii(e){let{view:t,offset:r}=this.reader.getViewAndOffset(this.pos,this.pos+e);this.pos+=e;let n="";for(let a=0;a<e;a++)n+=String.fromCharCode(t.getUint8(r+a));return n}};var gi=class extends ue{constructor(t){super(t);this.metadataPromise=null;this.dataStart=-1;this.dataSize=-1;this.audioInfo=null;this.tracks=[];this.metadataReader=new ot(t._mainReader),this.chunkReader=new ot(new fe(t.source,64*2**20))}async readMetadata(){return this.metadataPromise??=(async()=>{let t=await this.metadataReader.reader.source.getSize(),r=this.metadataReader.readAscii(4);this.metadataReader.littleEndian=r!=="RIFX";let n=r==="RF64",a=this.metadataReader.readU32(),s=n?t:Math.min(a+8,t);if(this.metadataReader.readAscii(4)!=="WAVE")throw new Error("Invalid WAVE file - wrong format");this.metadataReader.pos=12;let c=0,u=null;for(;this.metadataReader.pos<s;){await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+8);let l=this.metadataReader.readAscii(4),f=this.metadataReader.readU32(),h=this.metadataReader.pos;if(n&&c===0&&l!=="ds64")throw new Error('Invalid RF64 file: First chunk must be "ds64".');if(l==="fmt ")await this.parseFmtChunk(f);else if(l==="data")u??=f,this.dataStart=this.metadataReader.pos,this.dataSize=Math.min(u,s-this.dataStart);else if(l==="ds64"){let p=this.metadataReader.readU64();u=this.metadataReader.readU64(),s=Math.min(p+8,t)}this.metadataReader.pos=h+f+(f&1),c++}if(!this.audioInfo)throw new Error('Invalid WAVE file - missing "fmt " chunk');if(this.dataStart===-1)throw new Error('Invalid WAVE file - missing "data" chunk');let d=this.audioInfo.blockSizeInBytes;this.dataSize=Math.floor(this.dataSize/d)*d,this.tracks.push(new $(new ka(this)))})()}async parseFmtChunk(t){await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+t);let r=this.metadataReader.readU16(),n=this.metadataReader.readU16(),a=this.metadataReader.readU32();this.metadataReader.pos+=4;let s=this.metadataReader.readU16(),o;if(t===14?o=8:o=this.metadataReader.readU16(),t>=18&&r!==357){let c=this.metadataReader.readU16(),u=t-18;if(Math.min(u,c)>=22&&r===65534){this.metadataReader.pos+=6;let l=this.metadataReader.readBytes(16);r=l[0]|l[1]<<8}}(r===7||r===6)&&(o=8),this.audioInfo={format:r,numberOfChannels:n,sampleRate:a,sampleSizeInBytes:Math.ceil(o/8),blockSizeInBytes:s}}getCodec(){if(m(this.audioInfo),this.audioInfo.format===7)return"ulaw";if(this.audioInfo.format===6)return"alaw";if(this.audioInfo.format===1){if(this.audioInfo.sampleSizeInBytes===1)return"pcm-u8";if(this.audioInfo.sampleSizeInBytes===2)return"pcm-s16";if(this.audioInfo.sampleSizeInBytes===3)return"pcm-s24";if(this.audioInfo.sampleSizeInBytes===4)return"pcm-s32"}return this.audioInfo.format===3&&this.audioInfo.sampleSizeInBytes===4?"pcm-f32":null}async getMimeType(){return"audio/wav"}async computeDuration(){return await this.readMetadata(),m(this.audioInfo),this.dataSize/this.audioInfo.blockSizeInBytes/this.audioInfo.sampleRate}async getTracks(){return await this.readMetadata(),this.tracks}},Rt=2048,ka=class{constructor(e){this.demuxer=e}getId(){return 1}getCodec(){return this.demuxer.getCodec()}getInternalCodecId(){return m(this.demuxer.audioInfo),this.demuxer.audioInfo.format}async getDecoderConfig(){let e=this.demuxer.getCodec();return e?(m(this.demuxer.audioInfo),{codec:e,numberOfChannels:this.demuxer.audioInfo.numberOfChannels,sampleRate:this.demuxer.audioInfo.sampleRate}):null}computeDuration(){return this.demuxer.computeDuration()}getNumberOfChannels(){return m(this.demuxer.audioInfo),this.demuxer.audioInfo.numberOfChannels}getSampleRate(){return m(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getTimeResolution(){return m(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getName(){return null}getLanguageCode(){return Q}async getFirstTimestamp(){return 0}async getPacketAtIndex(e,t){m(this.demuxer.audioInfo);let r=e*Rt*this.demuxer.audioInfo.blockSizeInBytes;if(r>=this.demuxer.dataSize)return null;let n=Math.min(Rt*this.demuxer.audioInfo.blockSizeInBytes,this.demuxer.dataSize-r),a;if(t.metadataOnly)a=ie;else{let c=Rt*this.demuxer.audioInfo.blockSizeInBytes,u=Math.ceil(2**19/c)*c,d=Math.floor(r/u)*u,l=d+u;await this.demuxer.chunkReader.reader.loadRange(this.demuxer.dataStart+d,this.demuxer.dataStart+l),this.demuxer.chunkReader.pos=this.demuxer.dataStart+r,a=this.demuxer.chunkReader.readBytes(n)}let s=e*Rt/this.demuxer.audioInfo.sampleRate,o=n/this.demuxer.audioInfo.blockSizeInBytes/this.demuxer.audioInfo.sampleRate;return new M(a,"key",s,o,e,n)}getFirstPacket(e){return this.getPacketAtIndex(0,e)}getPacket(e,t){m(this.demuxer.audioInfo);let r=Math.floor(e*this.demuxer.audioInfo.sampleRate/Rt);return this.getPacketAtIndex(r,t)}getNextPacket(e,t){m(this.demuxer.audioInfo);let r=Math.round(e.timestamp*this.demuxer.audioInfo.sampleRate/Rt);return this.getPacketAtIndex(r+1,t)}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}};var bi=class{constructor(e){this.writer=e;this.helper=new Uint8Array(8);this.helperView=new DataView(this.helper.buffer)}writeU16(e){this.helperView.setUint16(0,e,!0),this.writer.write(this.helper.subarray(0,2))}writeU32(e){this.helperView.setUint32(0,e,!0),this.writer.write(this.helper.subarray(0,4))}writeU64(e){this.helperView.setUint32(0,e,!0),this.helperView.setUint32(4,Math.floor(e/2**32),!0),this.writer.write(this.helper)}writeAscii(e){this.writer.write(new TextEncoder().encode(e))}};var ki=class extends de{constructor(t,r){super(t);this.headerWritten=!1;this.dataSize=0;this.sampleRate=null;this.sampleCount=0;this.format=r,this.writer=t._writer,this.riffWriter=new bi(t._writer),this.isRf64=!!r._options.large}async start(){}async getMimeType(){return"audio/wav"}async addEncodedVideoPacket(){throw new Error("WAVE does not support video.")}async addEncodedAudioPacket(t,r,n){let a=await this.mutex.acquire();try{if(this.headerWritten||(Se(n),m(n),m(n.decoderConfig),this.writeHeader(t,n.decoderConfig),this.sampleRate=n.decoderConfig.sampleRate,this.headerWritten=!0),this.validateAndNormalizeTimestamp(t,r.timestamp,r.type==="key"),!this.isRf64&&this.writer.getPos()+r.data.byteLength>=2**32)throw new Error("Adding more audio data would exceed the maximum RIFF size of 4 GiB. To write larger files, use RF64 by setting `large: true` in the WavOutputFormatOptions.");this.writer.write(r.data),this.dataSize+=r.data.byteLength,this.sampleCount+=Math.round(r.duration*this.sampleRate),await this.writer.flush()}finally{a()}}async addSubtitleCue(){throw new Error("WAVE does not support subtitles.")}writeHeader(t,r){this.format._options.onHeader&&this.writer.startTrackingWrites();let n,a=t.source._codec,s=ee(a);s.dataType==="ulaw"?n=7:s.dataType==="alaw"?n=6:s.dataType==="float"?n=3:n=1;let o=r.numberOfChannels,c=r.sampleRate,u=s.sampleSize*o;if(this.riffWriter.writeAscii(this.isRf64?"RF64":"RIFF"),this.isRf64?this.riffWriter.writeU32(4294967295):this.riffWriter.writeU32(0),this.riffWriter.writeAscii("WAVE"),this.isRf64&&(this.riffWriter.writeAscii("ds64"),this.riffWriter.writeU32(28),this.riffWriter.writeU64(0),this.riffWriter.writeU64(0),this.riffWriter.writeU64(0),this.riffWriter.writeU32(0)),this.riffWriter.writeAscii("fmt "),this.riffWriter.writeU32(16),this.riffWriter.writeU16(n),this.riffWriter.writeU16(o),this.riffWriter.writeU32(c),this.riffWriter.writeU32(c*u),this.riffWriter.writeU16(u),this.riffWriter.writeU16(8*s.sampleSize),this.riffWriter.writeAscii("data"),this.isRf64?this.riffWriter.writeU32(4294967295):this.riffWriter.writeU32(0),this.format._options.onHeader){let{data:d,start:l}=this.writer.stopTrackingWrites();this.format._options.onHeader(d,l)}}async finalize(){let t=await this.mutex.acquire(),r=this.writer.getPos();this.isRf64?(this.writer.seek(20),this.riffWriter.writeU64(r-8),this.writer.seek(28),this.riffWriter.writeU64(this.dataSize),this.writer.seek(36),this.riffWriter.writeU64(this.sampleCount)):(this.writer.seek(4),this.riffWriter.writeU32(r-8),this.writer.seek(40),this.riffWriter.writeU32(this.dataSize)),this.writer.seek(r),t()}};var pe=class{getSupportedVideoCodecs(){return this.getSupportedCodecs().filter(e=>j.includes(e))}getSupportedAudioCodecs(){return this.getSupportedCodecs().filter(e=>X.includes(e))}getSupportedSubtitleCodecs(){return this.getSupportedCodecs().filter(e=>ce.includes(e))}_codecUnsupportedHint(e){return""}},Ft=class extends pe{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.fastStart!==void 0&&![!1,"in-memory","fragmented"].includes(e.fastStart))throw new TypeError('options.fastStart, when provided, must be false, "in-memory", or "fragmented".');if(e.minimumFragmentDuration!==void 0&&(!Number.isFinite(e.minimumFragmentDuration)||e.minimumFragmentDuration<0))throw new TypeError("options.minimumFragmentDuration, when provided, must be a non-negative number.");if(e.onFtyp!==void 0&&typeof e.onFtyp!="function")throw new TypeError("options.onFtyp, when provided, must be a function.");if(e.onMoov!==void 0&&typeof e.onMoov!="function")throw new TypeError("options.onMoov, when provided, must be a function.");if(e.onMdat!==void 0&&typeof e.onMdat!="function")throw new TypeError("options.onMdat, when provided, must be a function.");if(e.onMoof!==void 0&&typeof e.onMoof!="function")throw new TypeError("options.onMoof, when provided, must be a function.");super(),this._options=e}getSupportedTrackCounts(){return{video:{min:0,max:1/0},audio:{min:0,max:1/0},subtitle:{min:0,max:1/0},total:{min:1,max:2**32-1}}}get supportsVideoRotationMetadata(){return!0}_createMuxer(e){return new Jr(e,this)}},lr=class extends Ft{get _name(){return"MP4"}get fileExtension(){return".mp4"}get mimeType(){return"video/mp4"}getSupportedCodecs(){return[...j,...ye,"pcm-s16","pcm-s16be","pcm-s24","pcm-s24be","pcm-s32","pcm-s32be","pcm-f32","pcm-f32be","pcm-f64","pcm-f64be",...ce]}_codecUnsupportedHint(e){return new Ze().getSupportedCodecs().includes(e)?" Switching to MOV will grant support for this codec.":""}},Ze=class extends Ft{get _name(){return"MOV"}get fileExtension(){return".mov"}get mimeType(){return"video/quicktime"}getSupportedCodecs(){return[...j,...X]}_codecUnsupportedHint(e){return new lr().getSupportedCodecs().includes(e)?" Switching to MP4 will grant support for this codec.":""}},Ot=class extends pe{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.appendOnly!==void 0&&typeof e.appendOnly!="boolean")throw new TypeError("options.appendOnly, when provided, must be a boolean.");if(e.minimumClusterDuration!==void 0&&(!Number.isFinite(e.minimumClusterDuration)||e.minimumClusterDuration<0))throw new TypeError("options.minimumClusterDuration, when provided, must be a non-negative number.");if(e.onEbmlHeader!==void 0&&typeof e.onEbmlHeader!="function")throw new TypeError("options.onEbmlHeader, when provided, must be a function.");if(e.onSegmentHeader!==void 0&&typeof e.onSegmentHeader!="function")throw new TypeError("options.onHeader, when provided, must be a function.");if(e.onCluster!==void 0&&typeof e.onCluster!="function")throw new TypeError("options.onCluster, when provided, must be a function.");super(),this._options=e}_createMuxer(e){return new ii(e,this)}get _name(){return"Matroska"}getSupportedTrackCounts(){return{video:{min:0,max:1/0},audio:{min:0,max:1/0},subtitle:{min:0,max:1/0},total:{min:1,max:127}}}get fileExtension(){return".mkv"}get mimeType(){return"video/x-matroska"}getSupportedCodecs(){return[...j,...ye,...U.filter(e=>!["pcm-s8","pcm-f32be","pcm-f64be","ulaw","alaw"].includes(e)),...ce]}get supportsVideoRotationMetadata(){return!1}},rt=class extends Ot{getSupportedCodecs(){return[...j.filter(e=>["vp8","vp9","av1"].includes(e)),...X.filter(e=>["opus","vorbis"].includes(e)),...ce]}get _name(){return"WebM"}get fileExtension(){return".webm"}get mimeType(){return"video/webm"}_codecUnsupportedHint(e){return new Ot().getSupportedCodecs().includes(e)?" Switching to MKV will grant support for this codec.":""}},wi=class extends pe{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.xingHeader!==void 0&&typeof e.xingHeader!="boolean")throw new TypeError("options.xingHeader, when provided, must be a boolean.");if(e.onXingFrame!==void 0&&typeof e.onXingFrame!="function")throw new TypeError("options.onXingFrame, when provided, must be a function.");super(),this._options=e}_createMuxer(e){return new ci(e,this)}get _name(){return"MP3"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:1,max:1},subtitle:{min:0,max:0},total:{min:1,max:1}}}get fileExtension(){return".mp3"}get mimeType(){return"audio/mpeg"}getSupportedCodecs(){return["mp3"]}get supportsVideoRotationMetadata(){return!1}},Ti=class extends pe{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.large!==void 0&&typeof e.large!="boolean")throw new TypeError("options.large, when provided, must be a boolean.");if(e.onHeader!==void 0&&typeof e.onHeader!="function")throw new TypeError("options.onHeader, when provided, must be a function.");super(),this._options=e}_createMuxer(e){return new ki(e,this)}get _name(){return"WAVE"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:1,max:1},subtitle:{min:0,max:0},total:{min:1,max:1}}}get fileExtension(){return".wav"}get mimeType(){return"audio/wav"}getSupportedCodecs(){return[...U.filter(e=>["pcm-s16","pcm-s24","pcm-s32","pcm-f32","pcm-u8","ulaw","alaw"].includes(e))]}get supportsVideoRotationMetadata(){return!1}},yi=class extends pe{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.onPage!==void 0&&typeof e.onPage!="function")throw new TypeError("options.onPage, when provided, must be a function.");super(),this._options=e}_createMuxer(e){return new fi(e,this)}get _name(){return"Ogg"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:0,max:1/0},subtitle:{min:0,max:0},total:{min:1,max:2**32}}}get fileExtension(){return".ogg"}get mimeType(){return"application/ogg"}getSupportedCodecs(){return[...X.filter(e=>["vorbis","opus"].includes(e))]}get supportsVideoRotationMetadata(){return!1}},Si=class extends pe{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.onFrame!==void 0&&typeof e.onFrame!="function")throw new TypeError("options.onFrame, when provided, must be a function.");super(),this._options=e}_createMuxer(e){return new Vr(e,this)}get _name(){return"ADTS"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:1,max:1},subtitle:{min:0,max:0},total:{min:1,max:1}}}get fileExtension(){return".aac"}get mimeType(){return"audio/aac"}getSupportedCodecs(){return["aac"]}get supportsVideoRotationMetadata(){return!1}};var vi=i=>{if(!i||typeof i!="object")throw new TypeError("Encoding config must be an object.");if(!j.includes(i.codec))throw new TypeError(`Invalid video codec '${i.codec}'. Must be one of: ${j.join(", ")}.`);if(!(i.bitrate instanceof G)&&(!Number.isInteger(i.bitrate)||i.bitrate<=0))throw new TypeError("config.bitrate must be a positive integer or a quality.");if(i.keyFrameInterval!==void 0&&(!Number.isFinite(i.keyFrameInterval)||i.keyFrameInterval<0))throw new TypeError("config.keyFrameInterval, when provided, must be a non-negative number.");if(i.onEncodedPacket!==void 0&&typeof i.onEncodedPacket!="function")throw new TypeError("config.onEncodedChunk, when provided, must be a function.");if(i.onEncoderConfig!==void 0&&typeof i.onEncoderConfig!="function")throw new TypeError("config.onEncoderConfig, when provided, must be a function.");ns(i.codec,i)},ns=(i,e)=>{if(!e||typeof e!="object")throw new TypeError("Encoding options must be an object.");if(e.bitrateMode!==void 0&&!["constant","variable"].includes(e.bitrateMode))throw new TypeError("bitrateMode, when provided, must be 'constant' or 'variable'.");if(e.latencyMode!==void 0&&!["quality","realtime"].includes(e.latencyMode))throw new TypeError("latencyMode, when provided, must be 'quality' or 'realtime'.");if(e.fullCodecString!==void 0&&typeof e.fullCodecString!="string")throw new TypeError("fullCodecString, when provided, must be a string.");if(e.fullCodecString!==void 0&&ea(e.fullCodecString)!==i)throw new TypeError(`fullCodecString, when provided, must be a string that matches the specified codec (${i}).`);if(e.hardwareAcceleration!==void 0&&!["no-preference","prefer-hardware","prefer-software"].includes(e.hardwareAcceleration))throw new TypeError("hardwareAcceleration, when provided, must be 'no-preference', 'prefer-hardware' or 'prefer-software'.");if(e.scalabilityMode!==void 0&&typeof e.scalabilityMode!="string")throw new TypeError("scalabilityMode, when provided, must be a string.");if(e.contentHint!==void 0&&typeof e.contentHint!="string")throw new TypeError("contentHint, when provided, must be a string.")},Ci=i=>{let e=i.bitrate instanceof G?i.bitrate._toVideoBitrate(i.codec,i.width,i.height):i.bitrate;return{codec:i.fullCodecString??dn(i.codec,i.width,i.height,e),width:i.width,height:i.height,bitrate:e,bitrateMode:i.bitrateMode,framerate:i.framerate,latencyMode:i.latencyMode,hardwareAcceleration:i.hardwareAcceleration,scalabilityMode:i.scalabilityMode,contentHint:i.contentHint,...fn(i.codec)}},Pi=i=>{if(!i||typeof i!="object")throw new TypeError("Encoding config must be an object.");if(!X.includes(i.codec))throw new TypeError(`Invalid audio codec '${i.codec}'. Must be one of: ${X.join(", ")}.`);if(i.bitrate===void 0&&(!U.includes(i.codec)||i.codec==="flac"))throw new TypeError("config.bitrate must be provided for compressed audio codecs.");if(i.bitrate!==void 0&&!(i.bitrate instanceof G)&&(!Number.isInteger(i.bitrate)||i.bitrate<=0))throw new TypeError("config.bitrate, when provided, must be a positive integer or a quality.");if(i.onEncodedPacket!==void 0&&typeof i.onEncodedPacket!="function")throw new TypeError("config.onEncodedChunk, when provided, must be a function.");if(i.onEncoderConfig!==void 0&&typeof i.onEncoderConfig!="function")throw new TypeError("config.onEncoderConfig, when provided, must be a function.");ss(i.codec,i)},ss=(i,e)=>{if(!e||typeof e!="object")throw new TypeError("Encoding options must be an object.");if(e.bitrateMode!==void 0&&!["constant","variable"].includes(e.bitrateMode))throw new TypeError("bitrateMode, when provided, must be 'constant' or 'variable'.");if(e.fullCodecString!==void 0&&typeof e.fullCodecString!="string")throw new TypeError("fullCodecString, when provided, must be a string.");if(e.fullCodecString!==void 0&&ea(e.fullCodecString)!==i)throw new TypeError(`fullCodecString, when provided, must be a string that matches the specified codec (${i}).`)},xi=i=>{let e=i.bitrate instanceof G?i.bitrate._toAudioBitrate(i.codec):i.bitrate;return{codec:i.fullCodecString??ln(i.codec,i.numberOfChannels,i.sampleRate),numberOfChannels:i.numberOfChannels,sampleRate:i.sampleRate,bitrate:e,bitrateMode:i.bitrateMode,...pn(i.codec)}},os=i=>{if(j.includes(i))return mr(i);if(X.includes(i))return fr(i);if(ce.includes(i))return pr(i);throw new TypeError(`Unknown codec '${i}'.`)},mr=async(i,{width:e=1280,height:t=720,bitrate:r=1e6,...n}={})=>{if(!j.includes(i))return!1;if(!Number.isInteger(e)||e<=0)throw new TypeError("width must be a positive integer.");if(!Number.isInteger(t)||t<=0)throw new TypeError("height must be a positive integer.");if(!(r instanceof G)&&(!Number.isInteger(r)||r<=0))throw new TypeError("bitrate must be a positive integer or a quality.");ns(i,n);let a=null;return at.length>0&&(a??=Ci({codec:i,width:e,height:t,bitrate:r,framerate:void 0,...n}),at.some(o=>o.supports(i,a)))?!0:typeof VideoEncoder>"u"?!1:(a??=Ci({codec:i,width:e,height:t,bitrate:r,framerate:void 0,...n}),(await VideoEncoder.isConfigSupported(a)).supported===!0)},fr=async(i,{numberOfChannels:e=2,sampleRate:t=48e3,bitrate:r=128e3,...n}={})=>{if(!X.includes(i))return!1;if(!Number.isInteger(e)||e<=0)throw new TypeError("numberOfChannels must be a positive integer.");if(!Number.isInteger(t)||t<=0)throw new TypeError("sampleRate must be a positive integer.");if(!(r instanceof G)&&(!Number.isInteger(r)||r<=0))throw new TypeError("bitrate must be a positive integer.");ss(i,n);let a=null;return nt.length>0&&(a??=xi({codec:i,numberOfChannels:e,sampleRate:t,bitrate:r,...n}),nt.some(o=>o.supports(i,a)))||U.includes(i)?!0:typeof AudioEncoder>"u"?!1:(a??=xi({codec:i,numberOfChannels:e,sampleRate:t,bitrate:r,...n}),(await AudioEncoder.isConfigSupported(a)).supported===!0)},pr=async i=>!!ce.includes(i),cs=async()=>{let[i,e,t]=await Promise.all([wa(),Mt(),Ta()]);return[...i,...e,...t]},wa=async(i=j,e)=>{let t=await Promise.all(i.map(r=>mr(r,e)));return i.filter((r,n)=>t[n])},Mt=async(i=X,e)=>{let t=await Promise.all(i.map(r=>fr(r,e)));return i.filter((r,n)=>t[n])},Ta=async(i=ce)=>{let e=await Promise.all(i.map(pr));return i.filter((t,r)=>e[r])},Ei=async(i,e)=>{for(let t of i)if(await mr(t,e))return t;return null},ds=async(i,e)=>{for(let t of i)if(await fr(t,e))return t;return null},us=async i=>{for(let e of i)if(await pr(e))return e;return null};var ct=class{constructor(){this._connectedTrack=null;this._closingPromise=null;this._closed=!1;this._timestampOffset=0}_ensureValidAdd(){if(!this._connectedTrack)throw new Error("Source is not connected to an output track.");if(this._connectedTrack.output.state==="canceled")throw new Error("Output has been canceled.");if(this._connectedTrack.output.state==="finalizing"||this._connectedTrack.output.state==="finalized")throw new Error("Output has been finalized.");if(this._connectedTrack.output.state==="pending")throw new Error("Output has not started.");if(this._closed)throw new Error("Source is closed.")}async _start(){}async _flushAndClose(e){}close(){if(this._closingPromise)return;let e=this._connectedTrack;if(!e)throw new Error("Cannot call close without connecting the source to an output track.");if(e.output.state==="pending")throw new Error("Cannot call close before output has been started.");this._closingPromise=(async()=>{await this._flushAndClose(!1),this._closed=!0,!(e.output.state==="finalizing"||e.output.state==="finalized")&&e.output._muxer.onTrackClose(e)})()}async _flushOrWaitForOngoingClose(e){return this._closingPromise?this._closingPromise:this._flushAndClose(e)}},Pe=class extends ct{constructor(t){super();this._connectedTrack=null;if(!j.includes(t))throw new TypeError(`Invalid video codec '${t}'. Must be one of: ${j.join(", ")}.`);this._codec=t}},Bt=class extends Pe{constructor(e){super(e)}add(e,t){if(!(e instanceof M))throw new TypeError("packet must be an EncodedPacket.");if(e.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be added.");if(t!==void 0&&(!t||typeof t!="object"))throw new TypeError("meta, when provided, must be an object.");return this._ensureValidAdd(),this._connectedTrack.output._muxer.addEncodedVideoPacket(this._connectedTrack,e,t)}},hr=class{constructor(e,t){this.source=e;this.encodingConfig=t;this.ensureEncoderPromise=null;this.encoderInitialized=!1;this.encoder=null;this.muxer=null;this.lastMultipleOfKeyFrameInterval=-1;this.codedWidth=null;this.codedHeight=null;this.resizeCanvas=null;this.customEncoder=null;this.customEncoderCallSerializer=new Ve;this.customEncoderQueueSize=0;this.encoderError=null}async add(e,t,r){try{if(this.checkForEncoderError(),this.source._ensureValidAdd(),this.codedWidth!==null&&this.codedHeight!==null){if(e.codedWidth!==this.codedWidth||e.codedHeight!==this.codedHeight){let o=this.encodingConfig.sizeChangeBehavior??"deny";if(o!=="passThrough"){if(o==="deny")throw new Error(`Video sample size must remain constant. Expected ${this.codedWidth}x${this.codedHeight}, got ${e.codedWidth}x${e.codedHeight}. To allow the sample size to change over time, set \`sizeChangeBehavior\` to a value other than 'strict' in the encoding options.`);{let c=!1;this.resizeCanvas||(typeof document<"u"?(this.resizeCanvas=document.createElement("canvas"),this.resizeCanvas.width=this.codedWidth,this.resizeCanvas.height=this.codedHeight):this.resizeCanvas=new OffscreenCanvas(this.codedWidth,this.codedHeight),c=!0);let u=this.resizeCanvas.getContext("2d",{alpha:!1});m(u),c||u.clearRect(0,0,this.codedWidth,this.codedHeight),e.drawWithFit(u,{fit:o}),t&&e.close(),e=new ne(this.resizeCanvas,{timestamp:e.timestamp,duration:e.duration,rotation:e.rotation}),t=!0}}}}else this.codedWidth=e.codedWidth,this.codedHeight=e.codedHeight;this.encoderInitialized||(this.ensureEncoderPromise||this.ensureEncoder(e),this.encoderInitialized||await this.ensureEncoderPromise),m(this.encoderInitialized);let n=this.encodingConfig.keyFrameInterval??5,a=Math.floor(e.timestamp/n),s={...r,keyFrame:r?.keyFrame||n===0||a!==this.lastMultipleOfKeyFrameInterval};if(this.lastMultipleOfKeyFrameInterval=a,this.customEncoder){this.customEncoderQueueSize++;let o=e.clone(),c=this.customEncoderCallSerializer.call(()=>this.customEncoder.encode(o,s)).then(()=>this.customEncoderQueueSize--).catch(u=>this.encoderError??=u).finally(()=>{o.close()});this.customEncoderQueueSize>=4&&await c}else{m(this.encoder);let o=e.toVideoFrame();this.encoder.encode(o,s),o.close(),t&&e.close(),this.encoder.encodeQueueSize>=4&&await new Promise(c=>this.encoder.addEventListener("dequeue",c,{once:!0}))}await this.muxer.mutex.currentPromise}finally{t&&e.close()}}async ensureEncoder(e){if(!this.encoder)return this.ensureEncoderPromise=(async()=>{let t=Ci({width:e.codedWidth,height:e.codedHeight,...this.encodingConfig,framerate:this.source._connectedTrack?.metadata.frameRate});this.encodingConfig.onEncoderConfig?.(t);let r=at.find(n=>n.supports(this.encodingConfig.codec,t));if(r)this.customEncoder=new r,this.customEncoder.codec=this.encodingConfig.codec,this.customEncoder.config=t,this.customEncoder.onPacket=(n,a)=>{if(!(n instanceof M))throw new TypeError("The first argument passed to onPacket must be an EncodedPacket.");if(a!==void 0&&(!a||typeof a!="object"))throw new TypeError("The second argument passed to onPacket must be an object or undefined.");this.encodingConfig.onEncodedPacket?.(n,a),this.muxer.addEncodedVideoPacket(this.source._connectedTrack,n,a)},await this.customEncoder.init();else{if(typeof VideoEncoder>"u")throw new Error("VideoEncoder is not supported by this browser.");if(!(await VideoEncoder.isConfigSupported(t)).supported)throw new Error(`This specific encoder configuration (${t.codec}, ${t.bitrate} bps, ${t.width}x${t.height}, hardware acceleration: ${t.hardwareAcceleration??"no-preference"}) is not supported by this browser. Consider using another codec or changing your video parameters.`);this.encoder=new VideoEncoder({output:(a,s)=>{let o=M.fromEncodedChunk(a);this.encodingConfig.onEncodedPacket?.(o,s),this.muxer.addEncodedVideoPacket(this.source._connectedTrack,o,s)},error:a=>{a.stack=new Error().stack,this.encoderError??=a}}),this.encoder.configure(t)}m(this.source._connectedTrack),this.muxer=this.source._connectedTrack.output._muxer,this.encoderInitialized=!0})()}async flushAndClose(e){this.checkForEncoderError(),this.customEncoder?(e||this.customEncoderCallSerializer.call(()=>this.customEncoder.flush()),await this.customEncoderCallSerializer.call(()=>this.customEncoder.close())):this.encoder&&(e||await this.encoder.flush(),this.encoder.close()),this.checkForEncoderError()}getQueueSize(){return this.customEncoder?this.customEncoderQueueSize:this.encoder?.encodeQueueSize??0}checkForEncoderError(){if(this.encoderError)throw this.encoderError}},Dt=class extends Pe{constructor(e){vi(e),super(e.codec),this._encoder=new hr(this,e)}add(e,t){if(!(e instanceof ne))throw new TypeError("videoSample must be a VideoSample.");return this._encoder.add(e,!1,t)}_flushAndClose(e){return this._encoder.flushAndClose(e)}},Ii=class extends Pe{constructor(e,t){if(!(typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement)&&!(typeof OffscreenCanvas<"u"&&e instanceof OffscreenCanvas))throw new TypeError("canvas must be an HTMLCanvasElement or OffscreenCanvas.");vi(t),super(t.codec),this._encoder=new hr(this,t),this._canvas=e}add(e,t=0,r){if(!Number.isFinite(e)||e<0)throw new TypeError("timestamp must be a non-negative number.");if(!Number.isFinite(t)||t<0)throw new TypeError("duration must be a non-negative number.");let n=new ne(this._canvas,{timestamp:e,duration:t});return this._encoder.add(n,!0,r)}_flushAndClose(e){return this._encoder.flushAndClose(e)}},_i=class extends Pe{constructor(t,r){if(!(t instanceof MediaStreamTrack)||t.kind!=="video")throw new TypeError("track must be a video MediaStreamTrack.");vi(r),r={...r,latencyMode:"realtime"};super(r.codec);this._abortController=null;this._workerTrackId=null;this._workerListener=null;this._promiseWithResolvers=L();this._errorPromiseAccessed=!1;this._encoder=new hr(this,r),this._track=t}get errorPromise(){return this._errorPromiseAccessed=!0,this._promiseWithResolvers.promise}async _start(){this._errorPromiseAccessed||console.warn("Make sure not to ignore the `errorPromise` field on MediaStreamVideoTrackSource, so that any internal errors get bubbled up properly."),this._abortController=new AbortController;let t=null,r=!1,n=a=>{if(r){a.close();return}if(t===null){t=a.timestamp/1e6;let s=this._connectedTrack.output._muxer;s.firstMediaStreamTimestamp===null?(s.firstMediaStreamTimestamp=performance.now()/1e3,this._timestampOffset=-t):this._timestampOffset=performance.now()/1e3-s.firstMediaStreamTimestamp-t}if(this._encoder.getQueueSize()>=4){a.close();return}this._encoder.add(new ne(a),!0).catch(s=>{r=!0,this._abortController?.abort(),this._promiseWithResolvers.reject(s),this._workerTrackId!==null&&Sa({type:"stopTrack",trackId:this._workerTrackId})})};if(typeof MediaStreamTrackProcessor<"u"){let a=new MediaStreamTrackProcessor({track:this._track}),s=new WritableStream({write:n});a.readable.pipeTo(s,{signal:this._abortController.signal}).catch(o=>{o instanceof DOMException&&o.name==="AbortError"||this._promiseWithResolvers.reject(o)})}else if(await nc())this._workerTrackId=ic++,Sa({type:"videoTrack",trackId:this._workerTrackId,track:this._track},[this._track]),this._workerListener=s=>{let o=s.data;o.type==="videoFrame"&&o.trackId===this._workerTrackId?n(o.videoFrame):o.type==="error"&&o.trackId===this._workerTrackId&&this._promiseWithResolvers.reject(o.error)},he.addEventListener("message",this._workerListener);else throw new Error("MediaStreamTrackProcessor is required but not supported by this browser.")}async _flushAndClose(t){this._abortController&&(this._abortController.abort(),this._abortController=null),this._workerTrackId!==null&&(m(this._workerListener),Sa({type:"stopTrack",trackId:this._workerTrackId}),await new Promise(r=>{let n=a=>{let s=a.data;s.type==="trackStopped"&&s.trackId===this._workerTrackId&&(m(this._workerListener),he.removeEventListener("message",this._workerListener),he.removeEventListener("message",n),r())};he.addEventListener("message",n)})),await this._encoder.flushAndClose(t)}},Ee=class extends ct{constructor(t){super();this._connectedTrack=null;if(!X.includes(t))throw new TypeError(`Invalid audio codec '${t}'. Must be one of: ${X.join(", ")}.`);this._codec=t}},Vt=class extends Ee{constructor(e){super(e)}add(e,t){if(!(e instanceof M))throw new TypeError("packet must be an EncodedPacket.");if(e.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be added.");if(t!==void 0&&(!t||typeof t!="object"))throw new TypeError("meta, when provided, must be an object.");return this._ensureValidAdd(),this._connectedTrack.output._muxer.addEncodedAudioPacket(this._connectedTrack,e,t)}},gr=class{constructor(e,t){this.source=e;this.encodingConfig=t;this.ensureEncoderPromise=null;this.encoderInitialized=!1;this.encoder=null;this.muxer=null;this.lastNumberOfChannels=null;this.lastSampleRate=null;this.isPcmEncoder=!1;this.outputSampleSize=null;this.writeOutputValue=null;this.customEncoder=null;this.customEncoderCallSerializer=new Ve;this.customEncoderQueueSize=0;this.encoderError=null}async add(e,t){try{if(this.checkForEncoderError(),this.source._ensureValidAdd(),this.lastNumberOfChannels!==null&&this.lastSampleRate!==null){if(e.numberOfChannels!==this.lastNumberOfChannels||e.sampleRate!==this.lastSampleRate)throw new Error(`Audio parameters must remain constant. Expected ${this.lastNumberOfChannels} channels at ${this.lastSampleRate} Hz, got ${e.numberOfChannels} channels at ${e.sampleRate} Hz.`)}else this.lastNumberOfChannels=e.numberOfChannels,this.lastSampleRate=e.sampleRate;if(this.encoderInitialized||(this.ensureEncoderPromise||this.ensureEncoder(e),this.encoderInitialized||await this.ensureEncoderPromise),m(this.encoderInitialized),this.customEncoder){this.customEncoderQueueSize++;let r=e.clone(),n=this.customEncoderCallSerializer.call(()=>this.customEncoder.encode(r)).then(()=>this.customEncoderQueueSize--).catch(a=>this.encoderError??=a).finally(()=>{r.close()});this.customEncoderQueueSize>=4&&await n,await this.muxer.mutex.currentPromise}else if(this.isPcmEncoder)await this.doPcmEncoding(e,t);else{m(this.encoder);let r=e.toAudioData();this.encoder.encode(r),r.close(),t&&e.close(),this.encoder.encodeQueueSize>=4&&await new Promise(n=>this.encoder.addEventListener("dequeue",n,{once:!0})),await this.muxer.mutex.currentPromise}}finally{t&&e.close()}}async doPcmEncoding(e,t){m(this.outputSampleSize),m(this.writeOutputValue);let{numberOfChannels:r,numberOfFrames:n,sampleRate:a,timestamp:s}=e,o=2048,c=[];for(let f=0;f<n;f+=o){let h=Math.min(o,e.numberOfFrames-f),p=h*r*this.outputSampleSize,k=new ArrayBuffer(p),g=new DataView(k);c.push({frameCount:h,view:g})}let u=e.allocationSize({planeIndex:0,format:"f32-planar"}),d=new Float32Array(u/Float32Array.BYTES_PER_ELEMENT);for(let f=0;f<r;f++){e.copyTo(d,{planeIndex:f,format:"f32-planar"});for(let h=0;h<c.length;h++){let{frameCount:p,view:k}=c[h];for(let g=0;g<p;g++)this.writeOutputValue(k,(g*r+f)*this.outputSampleSize,d[h*o+g])}}t&&e.close();let l={decoderConfig:{codec:this.encodingConfig.codec,numberOfChannels:r,sampleRate:a}};for(let f=0;f<c.length;f++){let{frameCount:h,view:p}=c[f],k=p.buffer,g=f*o,b=new M(new Uint8Array(k),"key",s+g/a,h/a);this.encodingConfig.onEncodedPacket?.(b,l),await this.muxer.addEncodedAudioPacket(this.source._connectedTrack,b,l)}}ensureEncoder(e){if(!this.encoderInitialized)return this.ensureEncoderPromise=(async()=>{let{numberOfChannels:t,sampleRate:r}=e,n=xi({numberOfChannels:t,sampleRate:r,...this.encodingConfig});this.encodingConfig.onEncoderConfig?.(n);let a=nt.find(s=>s.supports(this.encodingConfig.codec,n));if(a)this.customEncoder=new a,this.customEncoder.codec=this.encodingConfig.codec,this.customEncoder.config=n,this.customEncoder.onPacket=(s,o)=>{if(!(s instanceof M))throw new TypeError("The first argument passed to onPacket must be an EncodedPacket.");if(o!==void 0&&(!o||typeof o!="object"))throw new TypeError("The second argument passed to onPacket must be an object or undefined.");this.encodingConfig.onEncodedPacket?.(s,o),this.muxer.addEncodedAudioPacket(this.source._connectedTrack,s,o)},await this.customEncoder.init();else if(U.includes(this.encodingConfig.codec))this.initPcmEncoder();else{if(typeof AudioEncoder>"u")throw new Error("AudioEncoder is not supported by this browser.");if(!(await AudioEncoder.isConfigSupported(n)).supported)throw new Error(`This specific encoder configuration (${n.codec}, ${n.bitrate} bps, ${n.numberOfChannels} channels, ${n.sampleRate} Hz) is not supported by this browser. Consider using another codec or changing your audio parameters.`);this.encoder=new AudioEncoder({output:(o,c)=>{let u=M.fromEncodedChunk(o);this.encodingConfig.onEncodedPacket?.(u,c),this.muxer.addEncodedAudioPacket(this.source._connectedTrack,u,c)},error:o=>{o.stack=new Error().stack,this.encoderError??=o}}),this.encoder.configure(n)}m(this.source._connectedTrack),this.muxer=this.source._connectedTrack.output._muxer,this.encoderInitialized=!0})()}initPcmEncoder(){this.isPcmEncoder=!0;let e=this.encodingConfig.codec,{dataType:t,sampleSize:r,littleEndian:n}=ee(e);switch(this.outputSampleSize=r,r){case 1:t==="unsigned"?this.writeOutputValue=(a,s,o)=>a.setUint8(s,J((o+1)*127.5,0,255)):t==="signed"?this.writeOutputValue=(a,s,o)=>{a.setInt8(s,J(Math.round(o*128),-128,127))}:t==="ulaw"?this.writeOutputValue=(a,s,o)=>{let c=J(Math.floor(o*32767),-32768,32767);a.setUint8(s,es(c))}:t==="alaw"?this.writeOutputValue=(a,s,o)=>{let c=J(Math.floor(o*32767),-32768,32767);a.setUint8(s,rs(c))}:m(!1);break;case 2:t==="unsigned"?this.writeOutputValue=(a,s,o)=>a.setUint16(s,J((o+1)*32767.5,0,65535),n):t==="signed"?this.writeOutputValue=(a,s,o)=>a.setInt16(s,J(Math.round(o*32767),-32768,32767),n):m(!1);break;case 3:t==="unsigned"?this.writeOutputValue=(a,s,o)=>Zi(a,s,J((o+1)*83886075e-1,0,16777215),n):t==="signed"?this.writeOutputValue=(a,s,o)=>Ja(a,s,J(Math.round(o*8388607),-8388608,8388607),n):m(!1);break;case 4:t==="unsigned"?this.writeOutputValue=(a,s,o)=>a.setUint32(s,J((o+1)*21474836475e-1,0,4294967295),n):t==="signed"?this.writeOutputValue=(a,s,o)=>a.setInt32(s,J(Math.round(o*2147483647),-2147483648,2147483647),n):t==="float"?this.writeOutputValue=(a,s,o)=>a.setFloat32(s,o,n):m(!1);break;case 8:t==="float"?this.writeOutputValue=(a,s,o)=>a.setFloat64(s,o,n):m(!1);break;default:ke(r),m(!1)}}async flushAndClose(e){this.checkForEncoderError(),this.customEncoder?(e||this.customEncoderCallSerializer.call(()=>this.customEncoder.flush()),await this.customEncoderCallSerializer.call(()=>this.customEncoder.close())):this.encoder&&(e||await this.encoder.flush(),this.encoder.close()),this.checkForEncoderError()}getQueueSize(){return this.customEncoder?this.customEncoderQueueSize:this.isPcmEncoder?0:this.encoder?.encodeQueueSize??0}checkForEncoderError(){if(this.encoderError)throw this.encoderError}},dt=class extends Ee{constructor(e){Pi(e),super(e.codec),this._encoder=new gr(this,e)}add(e){if(!(e instanceof se))throw new TypeError("audioSample must be an AudioSample.");return this._encoder.add(e,!1)}_flushAndClose(e){return this._encoder.flushAndClose(e)}},Ai=class extends Ee{constructor(t){Pi(t);super(t.codec);this._accumulatedTime=0;this._encoder=new gr(this,t)}async add(t){if(!(t instanceof AudioBuffer))throw new TypeError("audioBuffer must be an AudioBuffer.");let r=se._fromAudioBuffer(t,this._accumulatedTime);this._accumulatedTime+=t.duration;for(let n of r)await this._encoder.add(n,!0)}_flushAndClose(t){return this._encoder.flushAndClose(t)}},Ri=class extends Ee{constructor(t,r){if(!(t instanceof MediaStreamTrack)||t.kind!=="audio")throw new TypeError("track must be an audio MediaStreamTrack.");Pi(r);super(r.codec);this._abortController=null;this._audioContext=null;this._scriptProcessorNode=null;this._promiseWithResolvers=L();this._errorPromiseAccessed=!1;this._encoder=new gr(this,r),this._track=t}get errorPromise(){return this._errorPromiseAccessed=!0,this._promiseWithResolvers.promise}async _start(){if(this._errorPromiseAccessed||console.warn("Make sure not to ignore the `errorPromise` field on MediaStreamVideoTrackSource, so that any internal errors get bubbled up properly."),this._abortController=new AbortController,typeof MediaStreamTrackProcessor<"u"){let t=null,r=new MediaStreamTrackProcessor({track:this._track}),n=new WritableStream({write:a=>{if(t===null){t=a.timestamp/1e6;let s=this._connectedTrack.output._muxer;s.firstMediaStreamTimestamp===null?(s.firstMediaStreamTimestamp=performance.now()/1e3,this._timestampOffset=-t):this._timestampOffset=performance.now()/1e3-s.firstMediaStreamTimestamp-t}if(this._encoder.getQueueSize()>=4){a.close();return}this._encoder.add(new se(a),!0).catch(s=>{this._abortController?.abort(),this._promiseWithResolvers.reject(s)})}});r.readable.pipeTo(n,{signal:this._abortController.signal}).catch(a=>{a instanceof DOMException&&a.name==="AbortError"||this._promiseWithResolvers.reject(a)})}else{let t=window.AudioContext||window.webkitAudioContext;this._audioContext=new t({sampleRate:this._track.getSettings().sampleRate});let r=this._audioContext.createMediaStreamSource(new MediaStream([this._track]));this._scriptProcessorNode=this._audioContext.createScriptProcessor(4096),this._audioContext.state==="suspended"&&await this._audioContext.resume(),r.connect(this._scriptProcessorNode),this._scriptProcessorNode.connect(this._audioContext.destination);let n=!1,a=0;this._scriptProcessorNode.onaudioprocess=s=>{let o=se._fromAudioBuffer(s.inputBuffer,a);a+=s.inputBuffer.duration;for(let c of o){if(!n){n=!0;let u=this._connectedTrack.output._muxer;u.firstMediaStreamTimestamp===null?u.firstMediaStreamTimestamp=performance.now()/1e3:this._timestampOffset=performance.now()/1e3-u.firstMediaStreamTimestamp}if(this._encoder.getQueueSize()>=4){c.close();continue}this._encoder.add(c,!0).catch(u=>{this._audioContext.suspend(),this._promiseWithResolvers.reject(u)})}}}}async _flushAndClose(t){this._abortController&&(this._abortController.abort(),this._abortController=null),this._audioContext&&(m(this._scriptProcessorNode),this._scriptProcessorNode.disconnect(),await this._audioContext.suspend()),await this._encoder.flushAndClose(t)}},rc=()=>{let i=(r,n)=>{n?self.postMessage(r,{transfer:n}):self.postMessage(r)};i({type:"support",supported:typeof MediaStreamTrackProcessor<"u"});let e=new Map,t=new Set;self.addEventListener("message",r=>{let n=r.data;switch(n.type){case"videoTrack":{let a=new MediaStreamTrackProcessor({track:n.track}),s=new WritableStream({write:c=>{if(t.has(n.trackId)){c.close();return}i({type:"videoFrame",trackId:n.trackId,videoFrame:c},[c])}}),o=new AbortController;e.set(n.trackId,o),a.readable.pipeTo(s,{signal:o.signal}).catch(c=>{c instanceof DOMException&&c.name==="AbortError"||i({type:"error",trackId:n.trackId,error:c})})}break;case"stopTrack":{let a=e.get(n.trackId);a&&(a.abort(),e.delete(n.trackId)),t.add(n.trackId),i({type:"trackStopped",trackId:n.trackId})}break;default:ke(n)}})},ic=0,he=null,ac=()=>{let i=new Blob([`(${rc.toString()})()`],{type:"application/javascript"}),e=URL.createObjectURL(i);he=new Worker(e)},ya=null,nc=async()=>ya!==null?ya:(he||ac(),new Promise(i=>{m(he);let e=t=>{let r=t.data;r.type==="support"&&(ya=r.supported,he.removeEventListener("message",e),i(r.supported))};he.addEventListener("message",e)})),Sa=(i,e)=>{m(he),e?he.postMessage(i,e):he.postMessage(i)},ut=class extends ct{constructor(t){super();this._connectedTrack=null;if(!ce.includes(t))throw new TypeError(`Invalid subtitle codec '${t}'. Must be one of: ${ce.join(", ")}.`);this._codec=t}},Fi=class extends ut{constructor(e){super(e),this._parser=new Ur({codec:e,output:(t,r)=>this._connectedTrack?.output._muxer.addSubtitleCue(this._connectedTrack,t,r)})}add(e){if(typeof e!="string")throw new TypeError("text must be a string.");return this._ensureValidAdd(),this._parser.parse(e),this._connectedTrack.output._muxer.mutex.currentPromise}};var xa=["video","audio","subtitle"],Ca=i=>{if(!i||typeof i!="object")throw new TypeError("metadata must be an object.");if(i.languageCode!==void 0&&!Fe(i.languageCode))throw new TypeError("metadata.languageCode, when provided, must be a three-letter, ISO 639-2/T language code.");if(i.name!==void 0&&typeof i.name!="string")throw new TypeError("metadata.name, when provided, must be a string.")},Ut=class{constructor(e){this.state="pending";this._tracks=[];this._startPromise=null;this._cancelPromise=null;this._finalizePromise=null;this._mutex=new te;if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(!(e.format instanceof pe))throw new TypeError("options.format must be an OutputFormat.");if(!(e.target instanceof We))throw new TypeError("options.target must be a Target.");if(e.target._output)throw new Error("Target is already used for another output.");e.target._output=this,this.format=e.format,this.target=e.target,this._writer=e.target._createWriter(),this._muxer=e.format._createMuxer(this)}addVideoTrack(e,t={}){if(!(e instanceof Pe))throw new TypeError("source must be a VideoSource.");if(Ca(t),t.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError(`Invalid video rotation: ${t.rotation}. Has to be 0, 90, 180 or 270.`);if(!this.format.supportsVideoRotationMetadata&&t.rotation)throw new Error(`${this.format._name} does not support video rotation metadata.`);if(t.frameRate!==void 0&&(!Number.isFinite(t.frameRate)||t.frameRate<=0))throw new TypeError(`Invalid video frame rate: ${t.frameRate}. Must be a positive number.`);this._addTrack("video",e,t)}addAudioTrack(e,t={}){if(!(e instanceof Ee))throw new TypeError("source must be an AudioSource.");Ca(t),this._addTrack("audio",e,t)}addSubtitleTrack(e,t={}){if(!(e instanceof ut))throw new TypeError("source must be a SubtitleSource.");Ca(t),this._addTrack("subtitle",e,t)}_addTrack(e,t,r){if(this.state!=="pending")throw new Error("Cannot add track after output has been started or canceled.");if(t._connectedTrack)throw new Error("Source is already used for a track.");let n=this.format.getSupportedTrackCounts(),a=this._tracks.reduce((u,d)=>u+(d.type===e?1:0),0),s=n[e].max;if(a===s)throw new Error(s===0?`${this.format._name} does not support ${e} tracks.`:`${this.format._name} does not support more than ${s} ${e} track${s===1?"":"s"}.`);let o=n.total.max;if(this._tracks.length===o)throw new Error(`${this.format._name} does not support more than ${o} tracks${o===1?"":"s"} in total.`);let c={id:this._tracks.length+1,output:this,type:e,source:t,metadata:r};if(c.type==="video"){let u=this.format.getSupportedVideoCodecs();if(u.length===0)throw new Error(`${this.format._name} does not support video tracks.`+this.format._codecUnsupportedHint(c.source._codec));if(!u.includes(c.source._codec))throw new Error(`Codec '${c.source._codec}' cannot be contained within ${this.format._name}. Supported video codecs are: ${u.map(d=>`'${d}'`).join(", ")}.`+this.format._codecUnsupportedHint(c.source._codec))}else if(c.type==="audio"){let u=this.format.getSupportedAudioCodecs();if(u.length===0)throw new Error(`${this.format._name} does not support audio tracks.`+this.format._codecUnsupportedHint(c.source._codec));if(!u.includes(c.source._codec))throw new Error(`Codec '${c.source._codec}' cannot be contained within ${this.format._name}. Supported audio codecs are: ${u.map(d=>`'${d}'`).join(", ")}.`+this.format._codecUnsupportedHint(c.source._codec))}else if(c.type==="subtitle"){let u=this.format.getSupportedSubtitleCodecs();if(u.length===0)throw new Error(`${this.format._name} does not support subtitle tracks.`+this.format._codecUnsupportedHint(c.source._codec));if(!u.includes(c.source._codec))throw new Error(`Codec '${c.source._codec}' cannot be contained within ${this.format._name}. Supported subtitle codecs are: ${u.map(d=>`'${d}'`).join(", ")}.`+this.format._codecUnsupportedHint(c.source._codec))}this._tracks.push(c),t._connectedTrack=c}async start(){let e=this.format.getSupportedTrackCounts();for(let r of xa){let n=this._tracks.reduce((s,o)=>s+(o.type===r?1:0),0),a=e[r].min;if(n<a)throw new Error(a===e[r].max?`${this.format._name} requires exactly ${a} ${r} track${a===1?"":"s"}.`:`${this.format._name} requires at least ${a} ${r} track${a===1?"":"s"}.`)}let t=e.total.min;if(this._tracks.length<t)throw new Error(t===e.total.max?`${this.format._name} requires exactly ${t} track${t===1?"":"s"}.`:`${this.format._name} requires at least ${t} track${t===1?"":"s"}.`);if(this.state==="canceled")throw new Error("Output has been canceled.");return this._startPromise?(console.warn("Output has already been started."),this._startPromise):this._startPromise=(async()=>{this.state="started",this._writer.start();let r=await this._mutex.acquire();await this._muxer.start();let n=this._tracks.map(a=>a.source._start());await Promise.all(n),r()})()}getMimeType(){return this._muxer.getMimeType()}async cancel(){if(this._cancelPromise)return console.warn("Output has already been canceled."),this._cancelPromise;if(this.state==="finalizing"||this.state==="finalized"){console.warn("Output has already been finalized.");return}return this._cancelPromise=(async()=>{this.state="canceled";let e=await this._mutex.acquire(),t=this._tracks.map(r=>r.source._flushOrWaitForOngoingClose(!0));await Promise.all(t),await this._writer.close(),e()})()}async finalize(){if(this.state==="pending")throw new Error("Cannot finalize before starting.");if(this.state==="canceled")throw new Error("Cannot finalize after canceling.");return this._finalizePromise?(console.warn("Output has already been finalized."),this._finalizePromise):this._finalizePromise=(async()=>{this.state="finalizing";let e=await this._mutex.acquire(),t=this._tracks.map(r=>r.source._flushOrWaitForOngoingClose(!1));await Promise.all(t),await this._muxer.finalize(),await this._writer.flush(),await this._writer.finalize(),this.state="finalized",e()})()}};var Ie=class{constructor(){this._sizePromise=null;this.onread=null}getSize(){return this._sizePromise??=this._retrieveSize()}},Oi=class extends Ie{constructor(e){if(!(e instanceof ArrayBuffer)&&!(e instanceof Uint8Array))throw new TypeError("buffer must be an ArrayBuffer or Uint8Array.");super(),this._bytes=e instanceof Uint8Array?e:new Uint8Array(e)}async _read(e,t){return this._bytes.subarray(e,t)}async _retrieveSize(){return this._bytes.byteLength}},Mi=class extends Ie{constructor(e){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(typeof e.read!="function")throw new TypeError("options.read must be a function.");if(typeof e.getSize!="function")throw new TypeError("options.getSize must be a function.");super(),this._options=e}async _read(e,t){return this._options.read(e,t)}async _retrieveSize(){return this._options.getSize()}},Bi=class extends Ie{constructor(e){if(!(e instanceof Blob))throw new TypeError("blob must be a Blob.");super(),this._blob=e}async _read(e,t){let n=await this._blob.slice(e,t).arrayBuffer();return new Uint8Array(n)}async _retrieveSize(){return this._blob.size}},Di=class extends Ie{constructor(t,r={}){if(typeof t!="string"&&!(t instanceof URL))throw new TypeError("url must be a string or URL.");if(!r||typeof r!="object")throw new TypeError("options must be an object.");if(r.requestInit!==void 0&&(!r.requestInit||typeof r.requestInit!="object"))throw new TypeError("options.requestInit, when provided, must be an object.");if(r.getRetryDelay!==void 0&&typeof r.getRetryDelay!="function")throw new TypeError("options.getRetryDelay, when provided, must be a function.");super();this._fullData=null;this._nextUrlVersion=null;this._url=t instanceof URL?t:new URL(t,location.href),this._options=r}async _makeRequest(t){let r={};t&&(r.Range=`bytes=${t.start}-${t.end-1}`),this._nextUrlVersion!==null&&(this._url.searchParams.set("mediabunny_version",this._nextUrlVersion.toString()),this._nextUrlVersion++);let n=await Ar(this._url,Qt(this._options.requestInit??{},{method:"GET",headers:r}),this._options.getRetryDelay??(()=>null));if(!n.ok)throw new Error(`Error fetching ${this._url}: ${n.status} ${n.statusText}`);let a=await n.arrayBuffer();return n.status===206&&t&&a.byteLength!==t.end-t.start&&this._nextUrlVersion===null?(this._nextUrlVersion=1,this._makeRequest(t)):(n.status===200&&(this._fullData=a),{response:a,statusCode:n.status})}async _read(t,r){if(this._fullData)return new Uint8Array(this._fullData,t,r-t);let{response:n,statusCode:a}=await this._makeRequest({start:t,end:r});return a===200?new Uint8Array(n).subarray(t,r):new Uint8Array(n)}async _retrieveSize(){if(this._fullData)return this._fullData.byteLength;try{let n=await Ar(this._url,Qt(this._options.requestInit??{},{method:"HEAD"}),this._options.getRetryDelay??(()=>null));if(n.ok){let a=n.headers.get("Content-Length");if(a)return parseInt(a)}}catch{}let t=await Ar(this._url,Qt(this._options.requestInit??{},{method:"GET",headers:{Range:"bytes=0-0"}}),this._options.getRetryDelay??(()=>null));if(t.status===206){let n=t.headers.get("Content-Range");if(n){let a=n.match(/bytes \d+-\d+\/(\d+)/);if(a&&a[1])return parseInt(a[1])}}else if(t.status===200&&(this._fullData=await t.arrayBuffer(),this._fullData.byteLength!==1))return this._fullData.byteLength;let{response:r}=await this._makeRequest();return r.byteLength}};var Vi=class extends ue{constructor(t){super(t);this.currentTrack=null;this.tracks=[];this.metadataPromise=null;this.movieTimescale=-1;this.movieDurationInTimescale=-1;this.isQuickTime=!1;this.isFragmented=!1;this.fragmentTrackDefaults=[];this.fragments=[];this.currentFragment=null;this.fragmentLookupMutex=new te;this.metadataReader=new Xe(t._mainReader),this.chunkReader=new Xe(new fe(t.source,64*2**20))}async computeDuration(){let t=await this.getTracks(),r=await Promise.all(t.map(n=>n.computeDuration()));return Math.max(0,...r)}async getTracks(){return await this.readMetadata(),this.tracks.map(t=>t.inputTrack)}async getMimeType(){await this.readMetadata();let t=await Promise.all(this.tracks.map(r=>r.inputTrack.getCodecParameterString()));return Zr({isQuickTime:this.isQuickTime,hasVideo:this.tracks.some(r=>r.info?.type==="video"),hasAudio:this.tracks.some(r=>r.info?.type==="audio"),codecStrings:t.filter(Boolean)})}readMetadata(){return this.metadataPromise??=(async()=>{let t=await this.metadataReader.reader.source.getSize();for(;this.metadataReader.pos<t;){await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+Be);let r=this.metadataReader.pos,n=this.metadataReader.readBoxHeader();if(!n)break;if(n.name==="ftyp"){let a=this.metadataReader.readAscii(4);this.isQuickTime=a==="qt  "}else if(n.name==="moov"){await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+n.contentSize),this.readContiguousBoxes(n.contentSize);for(let a of this.tracks){let s=a.editListPreviousSegmentDurations/this.movieTimescale;a.editListOffset-=Math.round(s*a.timescale)}break}this.metadataReader.pos=r+n.totalSize}if(this.isFragmented){await this.metadataReader.reader.loadRange(t-4,t),this.metadataReader.pos=t-4;let r=this.metadataReader.readU32(),n=t-r;if(n>=0&&n<=t-Be){await this.metadataReader.reader.loadRange(n,n+2**16),this.metadataReader.pos=n;let a=this.metadataReader.readBoxHeader();a&&a.name==="mfra"&&(await this.metadataReader.reader.loadRange(n,n+a.totalSize),this.readContiguousBoxes(a.contentSize))}}})()}getSampleTableForTrack(t){if(t.sampleTable)return t.sampleTable;let r={sampleTimingEntries:[],sampleCompositionTimeOffsets:[],sampleSizes:[],keySampleIndices:null,chunkOffsets:[],sampleToChunk:[],presentationTimestamps:null,presentationTimestampIndexMap:null};if(t.sampleTable=r,this.metadataReader.pos=t.sampleTableByteOffset,this.currentTrack=t,this.traverseBox(),this.currentTrack=null,t.info?.type==="audio"&&t.info.codec&&U.includes(t.info.codec)&&r.sampleCompositionTimeOffsets.length===0){m(t.info?.type==="audio");let a=ee(t.info.codec),s=[],o=[];for(let c=0;c<r.sampleToChunk.length;c++){let u=r.sampleToChunk[c],d=r.sampleToChunk[c+1],l=(d?d.startChunkIndex:r.chunkOffsets.length)-u.startChunkIndex;for(let f=0;f<l;f++){let h=u.startSampleIndex+f*u.samplesPerChunk,p=h+u.samplesPerChunk,k=B(r.sampleTimingEntries,h,P=>P.startIndex),g=r.sampleTimingEntries[k],b=B(r.sampleTimingEntries,p,P=>P.startIndex),w=r.sampleTimingEntries[b],S=g.startDecodeTimestamp+(h-g.startIndex)*g.delta,y=w.startDecodeTimestamp+(p-w.startIndex)*w.delta-S,T=z(s);T&&T.delta===y?T.count++:s.push({startIndex:u.startChunkIndex+f,startDecodeTimestamp:S,count:1,delta:y});let C=u.samplesPerChunk*a.sampleSize*t.info.numberOfChannels;o.push(C)}u.startSampleIndex=u.startChunkIndex,u.samplesPerChunk=1}r.sampleTimingEntries=s,r.sampleSizes=o}if(r.sampleCompositionTimeOffsets.length>0){r.presentationTimestamps=[];for(let a of r.sampleTimingEntries)for(let s=0;s<a.count;s++)r.presentationTimestamps.push({presentationTimestamp:a.startDecodeTimestamp+s*a.delta,sampleIndex:a.startIndex+s});for(let a of r.sampleCompositionTimeOffsets)for(let s=0;s<a.count;s++){let o=a.startIndex+s,c=r.presentationTimestamps[o];c&&(c.presentationTimestamp+=a.offset)}r.presentationTimestamps.sort((a,s)=>a.presentationTimestamp-s.presentationTimestamp),r.presentationTimestampIndexMap=Array(r.presentationTimestamps.length).fill(-1);for(let a=0;a<r.presentationTimestamps.length;a++)r.presentationTimestampIndexMap[r.presentationTimestamps[a].sampleIndex]=a}return r}async readFragment(){let t=this.metadataReader.pos;await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+Be);let r=this.metadataReader.readBoxHeader();m(r?.name==="moof");let n=this.metadataReader.pos;await this.metadataReader.reader.loadRange(n,n+r.contentSize),this.metadataReader.pos=t,this.traverseBox();let a=W(this.fragments,t,o=>o.moofOffset);m(a!==-1);let s=this.fragments[a];m(s.moofOffset===t),this.metadataReader.reader.forgetRange(n,n+r.contentSize);for(let[o,c]of s.trackData){if(c.startTimestampIsFinal)continue;let u=this.tracks.find(p=>p.id===o);this.metadataReader.pos=0;let d=null,l=null,f=B(u.fragments,t-1,p=>p.moofOffset);f!==-1&&(d=u.fragments[f],l=d,this.metadataReader.pos=d.moofOffset+d.moofSize);let h=this.metadataReader.pos===0;for(;this.metadataReader.pos<=t-Ye;){if(d?.nextFragment)d=d.nextFragment,this.metadataReader.pos=d.moofOffset+d.moofSize;else{await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+Be);let p=this.metadataReader.pos,k=this.metadataReader.readBoxHeader();if(!k)break;if(k.name==="moof"){let g=W(this.fragments,p,w=>w.moofOffset),b;g===-1?(this.metadataReader.pos=p,b=await this.readFragment()):b=this.fragments[g],d&&(d.nextFragment=b),d=b,h&&(b.isKnownToBeFirstFragment=!0,h=!1)}this.metadataReader.pos=p+k.totalSize}d&&d.trackData.has(o)&&(l=d)}if(l){let p=l.trackData.get(o);m(p.startTimestampIsFinal),ms(c,p.endTimestamp)}c.startTimestampIsFinal=!0}return s}readContiguousBoxes(t){let r=this.metadataReader.pos;for(;this.metadataReader.pos-r<=t-Ye&&this.traverseBox(););}traverseBox(){let t=this.metadataReader.pos,r=this.metadataReader.readBoxHeader();if(!r)return!1;let n=t+r.totalSize;switch(r.name){case"mdia":case"minf":case"dinf":case"mfra":case"edts":case"udta":this.readContiguousBoxes(r.contentSize);break;case"mvhd":{let a=this.metadataReader.readU8();this.metadataReader.pos+=3,a===1?(this.metadataReader.pos+=16,this.movieTimescale=this.metadataReader.readU32(),this.movieDurationInTimescale=this.metadataReader.readU64()):(this.metadataReader.pos+=8,this.movieTimescale=this.metadataReader.readU32(),this.movieDurationInTimescale=this.metadataReader.readU32())}break;case"trak":{let a={id:-1,demuxer:this,inputTrack:null,info:null,timescale:-1,durationInMovieTimescale:-1,durationInMediaTimescale:-1,rotation:0,internalCodecId:null,name:null,languageCode:Q,sampleTableByteOffset:-1,sampleTable:null,fragmentLookupTable:null,currentFragmentState:null,fragments:[],fragmentsWithKeyFrame:[],editListPreviousSegmentDurations:0,editListOffset:0};if(this.currentTrack=a,this.readContiguousBoxes(r.contentSize),a.id!==-1&&a.timescale!==-1&&a.info!==null){if(a.info.type==="video"&&a.info.width!==-1){let s=a;a.inputTrack=new me(new va(s)),this.tracks.push(a)}else if(a.info.type==="audio"&&a.info.numberOfChannels!==-1){let s=a;a.inputTrack=new $(new Pa(s)),this.tracks.push(a)}}this.currentTrack=null}break;case"tkhd":{let a=this.currentTrack;m(a);let s=this.metadataReader.readU8();if(!((this.metadataReader.readU24()&1)!==0))break;if(s===0)this.metadataReader.pos+=8,a.id=this.metadataReader.readU32(),this.metadataReader.pos+=4,a.durationInMovieTimescale=this.metadataReader.readU32();else if(s===1)this.metadataReader.pos+=16,a.id=this.metadataReader.readU32(),this.metadataReader.pos+=4,a.durationInMovieTimescale=this.metadataReader.readU64();else throw new Error(`Incorrect track header version ${s}.`);this.metadataReader.pos+=2*4+2+2+2+2;let u=[this.metadataReader.readFixed_16_16(),this.metadataReader.readFixed_16_16(),this.metadataReader.readFixed_2_30(),this.metadataReader.readFixed_16_16(),this.metadataReader.readFixed_16_16(),this.metadataReader.readFixed_2_30(),this.metadataReader.readFixed_16_16(),this.metadataReader.readFixed_16_16(),this.metadataReader.readFixed_2_30()],d=Ue(qt(dc(u),90));m(d===0||d===90||d===180||d===270),a.rotation=d}break;case"elst":{let a=this.currentTrack;m(a);let s=this.metadataReader.readU8();this.metadataReader.pos+=3;let o=!1,c=0,u=this.metadataReader.readU32();for(let d=0;d<u;d++){let l=s===1?this.metadataReader.readU64():this.metadataReader.readU32(),f=s===1?this.metadataReader.readI64():this.metadataReader.readI32(),h=this.metadataReader.readFixed_16_16();if(l!==0){if(o){console.warn("Unsupported edit list: multiple edits are not currently supported. Only using first edit.");break}if(f===-1){c+=l;continue}if(h!==1){console.warn("Unsupported edit list entry: media rate must be 1.");break}a.editListPreviousSegmentDurations=c,a.editListOffset=f,o=!0}}}break;case"mdhd":{let a=this.currentTrack;m(a);let s=this.metadataReader.readU8();this.metadataReader.pos+=3,s===0?(this.metadataReader.pos+=8,a.timescale=this.metadataReader.readU32(),a.durationInMediaTimescale=this.metadataReader.readU32()):s===1&&(this.metadataReader.pos+=16,a.timescale=this.metadataReader.readU32(),a.durationInMediaTimescale=this.metadataReader.readU64());let o=this.metadataReader.readU16();if(o>0){a.languageCode="";for(let c=0;c<3;c++)a.languageCode=String.fromCharCode(96+(o&31))+a.languageCode,o>>=5;Fe(a.languageCode)||(a.languageCode=Q)}}break;case"hdlr":{let a=this.currentTrack;m(a),this.metadataReader.pos+=8;let s=this.metadataReader.readAscii(4);s==="vide"?a.info={type:"video",width:-1,height:-1,codec:null,codecDescription:null,colorSpace:null,avcCodecInfo:null,hevcCodecInfo:null,vp9CodecInfo:null,av1CodecInfo:null}:s==="soun"&&(a.info={type:"audio",numberOfChannels:-1,sampleRate:-1,codec:null,codecDescription:null,aacCodecInfo:null})}break;case"stbl":{let a=this.currentTrack;m(a),a.sampleTableByteOffset=t,this.readContiguousBoxes(r.contentSize)}break;case"stsd":{let a=this.currentTrack;if(m(a),a.info===null||a.sampleTable)break;let s=this.metadataReader.readU8();this.metadataReader.pos+=3;let o=this.metadataReader.readU32();for(let c=0;c<o;c++){let u=this.metadataReader.pos,d=this.metadataReader.readBoxHeader();if(!d)break;a.internalCodecId=d.name;let l=d.name.toLowerCase();if(a.info.type==="video")l==="avc1"?a.info.codec="avc":l==="hvc1"||l==="hev1"?a.info.codec="hevc":l==="vp08"?a.info.codec="vp8":l==="vp09"?a.info.codec="vp9":l==="av01"?a.info.codec="av1":console.warn(`Unsupported video codec (sample entry type '${d.name}').`),this.metadataReader.pos+=6*1+2+2+2+3*4,a.info.width=this.metadataReader.readU16(),a.info.height=this.metadataReader.readU16(),this.metadataReader.pos+=50,this.readContiguousBoxes(u+d.totalSize-this.metadataReader.pos);else{l==="mp4a"||(l==="opus"?a.info.codec="opus":l==="flac"?a.info.codec="flac":l==="twos"||l==="sowt"||l==="raw "||l==="in24"||l==="in32"||l==="fl32"||l==="fl64"||l==="lpcm"||l==="ipcm"||l==="fpcm"||(l==="ulaw"?a.info.codec="ulaw":l==="alaw"?a.info.codec="alaw":console.warn(`Unsupported audio codec (sample entry type '${d.name}').`))),this.metadataReader.pos+=6*1+2;let f=this.metadataReader.readU16();this.metadataReader.pos+=3*2;let h=this.metadataReader.readU16(),p=this.metadataReader.readU16();this.metadataReader.pos+=2*2;let k=this.metadataReader.readU32()/65536;if(s===0&&f>0){if(f===1)this.metadataReader.pos+=4,p=8*this.metadataReader.readU32(),this.metadataReader.pos+=2*4;else if(f===2){this.metadataReader.pos+=4,k=this.metadataReader.readF64(),h=this.metadataReader.readU32(),this.metadataReader.pos+=4,p=this.metadataReader.readU32();let g=this.metadataReader.readU32();if(this.metadataReader.pos+=2*4,l==="lpcm"){let b=p+7>>3,w=!!(g&1),S=!!(g&2),x=g&4?-1:0;p>0&&p<=64&&(w?p===32&&(a.info.codec=S?"pcm-f32be":"pcm-f32"):x&1<<b-1?b===1?a.info.codec="pcm-s8":b===2?a.info.codec=S?"pcm-s16be":"pcm-s16":b===3?a.info.codec=S?"pcm-s24be":"pcm-s24":b===4&&(a.info.codec=S?"pcm-s32be":"pcm-s32"):b===1&&(a.info.codec="pcm-u8")),a.info.codec===null&&console.warn("Unsupported PCM format.")}}}a.info.numberOfChannels=h,a.info.sampleRate=k,l==="twos"?p===8?a.info.codec="pcm-s8":p===16?a.info.codec="pcm-s16be":(console.warn(`Unsupported sample size ${p} for codec 'twos'.`),a.info.codec=null):l==="sowt"?p===8?a.info.codec="pcm-s8":p===16?a.info.codec="pcm-s16":(console.warn(`Unsupported sample size ${p} for codec 'sowt'.`),a.info.codec=null):l==="raw "?a.info.codec="pcm-u8":l==="in24"?a.info.codec="pcm-s24be":l==="in32"?a.info.codec="pcm-s32be":l==="fl32"?a.info.codec="pcm-f32be":l==="fl64"?a.info.codec="pcm-f64be":l==="ipcm"?a.info.codec="pcm-s16be":l==="fpcm"&&(a.info.codec="pcm-f32be"),this.readContiguousBoxes(u+d.totalSize-this.metadataReader.pos)}}}break;case"avcC":{let a=this.currentTrack;m(a&&a.info),a.info.codecDescription=this.metadataReader.readBytes(r.contentSize)}break;case"hvcC":{let a=this.currentTrack;m(a&&a.info),a.info.codecDescription=this.metadataReader.readBytes(r.contentSize)}break;case"vpcC":{let a=this.currentTrack;m(a&&a.info?.type==="video"),this.metadataReader.pos+=4;let s=this.metadataReader.readU8(),o=this.metadataReader.readU8(),c=this.metadataReader.readU8(),u=c>>4,d=c>>1&7,l=c&1,f=this.metadataReader.readU8(),h=this.metadataReader.readU8(),p=this.metadataReader.readU8();a.info.vp9CodecInfo={profile:s,level:o,bitDepth:u,chromaSubsampling:d,videoFullRangeFlag:l,colourPrimaries:f,transferCharacteristics:h,matrixCoefficients:p}}break;case"av1C":{let a=this.currentTrack;m(a&&a.info?.type==="video"),this.metadataReader.pos+=1;let s=this.metadataReader.readU8(),o=s>>5,c=s&31,u=this.metadataReader.readU8(),d=u>>7,l=u>>6&1,f=u>>5&1,h=u>>4&1,p=u>>3&1,k=u>>2&1,g=u&3,b=o===2&&l?f?12:10:l?10:8;a.info.av1CodecInfo={profile:o,level:c,tier:d,bitDepth:b,monochrome:h,chromaSubsamplingX:p,chromaSubsamplingY:k,chromaSamplePosition:g}}break;case"colr":{let a=this.currentTrack;if(m(a&&a.info?.type==="video"),this.metadataReader.readAscii(4)!=="nclx")break;let o=this.metadataReader.readU16(),c=this.metadataReader.readU16(),u=this.metadataReader.readU16(),d=!!(this.metadataReader.readU8()&128);a.info.colorSpace={primaries:vr[o],transfer:Pr[c],matrix:Er[u],fullRange:d}}break;case"wave":this.readContiguousBoxes(r.contentSize);break;case"esds":{let a=this.currentTrack;m(a&&a.info?.type==="audio"),this.metadataReader.pos+=4;let s=this.metadataReader.readU8();m(s===3),this.metadataReader.readIsomVariableInteger(),this.metadataReader.pos+=2;let o=this.metadataReader.readU8(),c=(o&128)!==0,u=(o&64)!==0,d=(o&32)!==0;if(c&&(this.metadataReader.pos+=2),u){let k=this.metadataReader.readU8();this.metadataReader.pos+=k}d&&(this.metadataReader.pos+=2);let l=this.metadataReader.readU8();m(l===4);let f=this.metadataReader.readIsomVariableInteger(),h=this.metadataReader.pos,p=this.metadataReader.readU8();if(p===64||p===103?(a.info.codec="aac",a.info.aacCodecInfo={isMpeg2:p===103}):p===105||p===107?a.info.codec="mp3":p===221?a.info.codec="vorbis":console.warn(`Unsupported audio codec (objectTypeIndication ${p}) - discarding track.`),this.metadataReader.pos+=12,f>this.metadataReader.pos-h){let k=this.metadataReader.readU8();m(k===5);let g=this.metadataReader.readIsomVariableInteger();if(a.info.codecDescription=this.metadataReader.readBytes(g),a.info.codec==="aac"){let b=$t(a.info.codecDescription);b.numberOfChannels!==null&&(a.info.numberOfChannels=b.numberOfChannels),b.sampleRate!==null&&(a.info.sampleRate=b.sampleRate)}}}break;case"enda":{let a=this.currentTrack;m(a&&a.info?.type==="audio"),this.metadataReader.readU16()&255&&(a.info.codec==="pcm-s16be"?a.info.codec="pcm-s16":a.info.codec==="pcm-s24be"?a.info.codec="pcm-s24":a.info.codec==="pcm-s32be"?a.info.codec="pcm-s32":a.info.codec==="pcm-f32be"?a.info.codec="pcm-f32":a.info.codec==="pcm-f64be"&&(a.info.codec="pcm-f64"))}break;case"pcmC":{let a=this.currentTrack;m(a&&a.info?.type==="audio"),this.metadataReader.pos+=4;let o=!!(this.metadataReader.readU8()&1),c=this.metadataReader.readU8();a.info.codec==="pcm-s16be"?o?c===16?a.info.codec="pcm-s16":c===24?a.info.codec="pcm-s24":c===32?a.info.codec="pcm-s32":(console.warn(`Invalid ipcm sample size ${c}.`),a.info.codec=null):c===16?a.info.codec="pcm-s16be":c===24?a.info.codec="pcm-s24be":c===32?a.info.codec="pcm-s32be":(console.warn(`Invalid ipcm sample size ${c}.`),a.info.codec=null):a.info.codec==="pcm-f32be"&&(o?c===32?a.info.codec="pcm-f32":c===64?a.info.codec="pcm-f64":(console.warn(`Invalid fpcm sample size ${c}.`),a.info.codec=null):c===32?a.info.codec="pcm-f32be":c===64?a.info.codec="pcm-f64be":(console.warn(`Invalid fpcm sample size ${c}.`),a.info.codec=null));break}case"dOps":{let a=this.currentTrack;m(a&&a.info?.type==="audio"),this.metadataReader.pos+=1;let s=this.metadataReader.readU8(),o=this.metadataReader.readU16(),c=this.metadataReader.readU32(),u=this.metadataReader.readI16(),d=this.metadataReader.readU8(),l;d!==0?l=this.metadataReader.readBytes(2+s):l=new Uint8Array(0);let f=new Uint8Array(19+l.byteLength),h=new DataView(f.buffer);h.setUint32(0,1332770163,!1),h.setUint32(4,1214603620,!1),h.setUint8(8,1),h.setUint8(9,s),h.setUint16(10,o,!0),h.setUint32(12,c,!0),h.setInt16(16,u,!0),h.setUint8(18,d),f.set(l,19),a.info.codecDescription=f,a.info.numberOfChannels=s,a.info.sampleRate=c}break;case"dfLa":{let a=this.currentTrack;m(a&&a.info?.type==="audio"),this.metadataReader.pos+=4;let s=127,o=128,c=this.metadataReader.pos;for(;this.metadataReader.pos<n;){let h=this.metadataReader.readU8(),p=this.metadataReader.readU24();if((h&s)===0){this.metadataReader.pos+=10;let g=this.metadataReader.readU32(),b=g>>>12,w=(g>>9&7)+1;a.info.sampleRate=b,a.info.numberOfChannels=w,this.metadataReader.pos+=20}else this.metadataReader.pos+=p;if(h&o)break}let u=this.metadataReader.pos;this.metadataReader.pos=c;let d=this.metadataReader.readBytes(u-c),l=new Uint8Array(4+d.byteLength);new DataView(l.buffer).setUint32(0,1716281667,!1),l.set(d,4),a.info.codecDescription=l}break;case"stts":{let a=this.currentTrack;if(m(a),!a.sampleTable)break;this.metadataReader.pos+=4;let s=this.metadataReader.readU32(),o=0,c=0;for(let u=0;u<s;u++){let d=this.metadataReader.readU32(),l=this.metadataReader.readU32();a.sampleTable.sampleTimingEntries.push({startIndex:o,startDecodeTimestamp:c,count:d,delta:l}),o+=d,c+=d*l}}break;case"ctts":{let a=this.currentTrack;if(m(a),!a.sampleTable)break;this.metadataReader.pos+=4;let s=this.metadataReader.readU32(),o=0;for(let c=0;c<s;c++){let u=this.metadataReader.readU32(),d=this.metadataReader.readI32();a.sampleTable.sampleCompositionTimeOffsets.push({startIndex:o,count:u,offset:d}),o+=u}}break;case"stsz":{let a=this.currentTrack;if(m(a),!a.sampleTable)break;this.metadataReader.pos+=4;let s=this.metadataReader.readU32(),o=this.metadataReader.readU32();if(s===0)for(let c=0;c<o;c++){let u=this.metadataReader.readU32();a.sampleTable.sampleSizes.push(u)}else a.sampleTable.sampleSizes.push(s)}break;case"stz2":{let a=this.currentTrack;if(m(a),!a.sampleTable)break;this.metadataReader.pos+=4,this.metadataReader.pos+=3;let s=this.metadataReader.readU8(),o=this.metadataReader.readU32(),c=this.metadataReader.readBytes(Math.ceil(o*s/8)),u=new N(c);for(let d=0;d<o;d++){let l=u.readBits(s);a.sampleTable.sampleSizes.push(l)}}break;case"stss":{let a=this.currentTrack;if(m(a),!a.sampleTable)break;this.metadataReader.pos+=4,a.sampleTable.keySampleIndices=[];let s=this.metadataReader.readU32();for(let o=0;o<s;o++){let c=this.metadataReader.readU32()-1;a.sampleTable.keySampleIndices.push(c)}a.sampleTable.keySampleIndices[0]!==0&&a.sampleTable.keySampleIndices.unshift(0)}break;case"stsc":{let a=this.currentTrack;if(m(a),!a.sampleTable)break;this.metadataReader.pos+=4;let s=this.metadataReader.readU32();for(let c=0;c<s;c++){let u=this.metadataReader.readU32()-1,d=this.metadataReader.readU32(),l=this.metadataReader.readU32();a.sampleTable.sampleToChunk.push({startSampleIndex:-1,startChunkIndex:u,samplesPerChunk:d,sampleDescriptionIndex:l})}let o=0;for(let c=0;c<a.sampleTable.sampleToChunk.length;c++)if(a.sampleTable.sampleToChunk[c].startSampleIndex=o,c<a.sampleTable.sampleToChunk.length-1){let d=a.sampleTable.sampleToChunk[c+1].startChunkIndex-a.sampleTable.sampleToChunk[c].startChunkIndex;o+=d*a.sampleTable.sampleToChunk[c].samplesPerChunk}}break;case"stco":{let a=this.currentTrack;if(m(a),!a.sampleTable)break;this.metadataReader.pos+=4;let s=this.metadataReader.readU32();for(let o=0;o<s;o++){let c=this.metadataReader.readU32();a.sampleTable.chunkOffsets.push(c)}}break;case"co64":{let a=this.currentTrack;if(m(a),!a.sampleTable)break;this.metadataReader.pos+=4;let s=this.metadataReader.readU32();for(let o=0;o<s;o++){let c=this.metadataReader.readU64();a.sampleTable.chunkOffsets.push(c)}}break;case"mvex":this.isFragmented=!0,this.readContiguousBoxes(r.contentSize);break;case"mehd":{let a=this.metadataReader.readU8();this.metadataReader.pos+=3;let s=a===1?this.metadataReader.readU64():this.metadataReader.readU32();this.movieDurationInTimescale=s}break;case"trex":{this.metadataReader.pos+=4;let a=this.metadataReader.readU32(),s=this.metadataReader.readU32(),o=this.metadataReader.readU32(),c=this.metadataReader.readU32(),u=this.metadataReader.readU32();this.fragmentTrackDefaults.push({trackId:a,defaultSampleDescriptionIndex:s,defaultSampleDuration:o,defaultSampleSize:c,defaultSampleFlags:u})}break;case"tfra":{let a=this.metadataReader.readU8();this.metadataReader.pos+=3;let s=this.metadataReader.readU32(),o=this.tracks.find(w=>w.id===s);if(!o)break;o.fragmentLookupTable=[];let c=this.metadataReader.readU32(),u=(c&48)>>4,d=(c&12)>>2,l=c&3,f=this.metadataReader,h=[f.readU8.bind(f),f.readU16.bind(f),f.readU24.bind(f),f.readU32.bind(f)],p=h[u],k=h[d],g=h[l],b=this.metadataReader.readU32();for(let w=0;w<b;w++){let S=a===1?this.metadataReader.readU64():this.metadataReader.readU32(),x=a===1?this.metadataReader.readU64():this.metadataReader.readU32(),y=p(),T=k(),C=g();o.fragmentLookupTable.push({timestamp:S,moofOffset:x})}}break;case"moof":{this.currentFragment={moofOffset:t,moofSize:r.totalSize,implicitBaseDataOffset:t,trackData:new Map,dataStart:1/0,dataEnd:0,nextFragment:null,isKnownToBeFirstFragment:!1},this.readContiguousBoxes(r.contentSize),be(this.fragments,this.currentFragment,a=>a.moofOffset);for(let[,a]of this.currentFragment.trackData){let s=a.samples[0],o=z(a.samples);this.currentFragment.dataStart=Math.min(this.currentFragment.dataStart,s.byteOffset),this.currentFragment.dataEnd=Math.max(this.currentFragment.dataEnd,o.byteOffset+o.byteSize)}this.currentFragment=null}break;case"traf":if(m(this.currentFragment),this.readContiguousBoxes(r.contentSize),this.currentTrack){let a=this.currentFragment.trackData.get(this.currentTrack.id);if(a){be(this.currentTrack.fragments,this.currentFragment,c=>c.moofOffset),a.firstKeyFrameTimestamp!==null&&be(this.currentTrack.fragmentsWithKeyFrame,this.currentFragment,c=>c.moofOffset);let{currentFragmentState:o}=this.currentTrack;m(o),o.startTimestamp!==null&&(ms(a,o.startTimestamp),a.startTimestampIsFinal=!0)}this.currentTrack.currentFragmentState=null,this.currentTrack=null}break;case"tfhd":{m(this.currentFragment),this.metadataReader.pos+=1;let a=this.metadataReader.readU24(),s=!!(a&1),o=!!(a&2),c=!!(a&8),u=!!(a&16),d=!!(a&32),l=!!(a&65536),f=!!(a&131072),h=this.metadataReader.readU32(),p=this.tracks.find(g=>g.id===h);if(!p)break;let k=this.fragmentTrackDefaults.find(g=>g.trackId===h);this.currentTrack=p,p.currentFragmentState={baseDataOffset:this.currentFragment.implicitBaseDataOffset,sampleDescriptionIndex:k?.defaultSampleDescriptionIndex??null,defaultSampleDuration:k?.defaultSampleDuration??null,defaultSampleSize:k?.defaultSampleSize??null,defaultSampleFlags:k?.defaultSampleFlags??null,startTimestamp:null},s?p.currentFragmentState.baseDataOffset=this.metadataReader.readU64():f&&(p.currentFragmentState.baseDataOffset=this.currentFragment.moofOffset),o&&(p.currentFragmentState.sampleDescriptionIndex=this.metadataReader.readU32()),c&&(p.currentFragmentState.defaultSampleDuration=this.metadataReader.readU32()),u&&(p.currentFragmentState.defaultSampleSize=this.metadataReader.readU32()),d&&(p.currentFragmentState.defaultSampleFlags=this.metadataReader.readU32()),l&&(p.currentFragmentState.defaultSampleDuration=0)}break;case"tfdt":{let a=this.currentTrack;if(!a)break;m(a.currentFragmentState);let s=this.metadataReader.readU8();this.metadataReader.pos+=3;let o=s===0?this.metadataReader.readU32():this.metadataReader.readU64();a.currentFragmentState.startTimestamp=o}break;case"trun":{let a=this.currentTrack;if(!a)break;if(m(this.currentFragment),m(a.currentFragmentState),this.currentFragment.trackData.has(a.id)){console.warn("Can't have two trun boxes for the same track in one fragment. Ignoring...");break}let s=this.metadataReader.readU8(),o=this.metadataReader.readU24(),c=!!(o&1),u=!!(o&4),d=!!(o&256),l=!!(o&512),f=!!(o&1024),h=!!(o&2048),p=this.metadataReader.readU32(),k=a.currentFragmentState.baseDataOffset;c&&(k+=this.metadataReader.readI32());let g=null;u&&(g=this.metadataReader.readU32());let b=k;if(p===0){this.currentFragment.implicitBaseDataOffset=b;break}let w=0,S={startTimestamp:0,endTimestamp:0,firstKeyFrameTimestamp:null,samples:[],presentationTimestamps:[],startTimestampIsFinal:!1};this.currentFragment.trackData.set(a.id,S);for(let T=0;T<p;T++){let C;d?C=this.metadataReader.readU32():(m(a.currentFragmentState.defaultSampleDuration!==null),C=a.currentFragmentState.defaultSampleDuration);let P;l?P=this.metadataReader.readU32():(m(a.currentFragmentState.defaultSampleSize!==null),P=a.currentFragmentState.defaultSampleSize);let E;f?E=this.metadataReader.readU32():(m(a.currentFragmentState.defaultSampleFlags!==null),E=a.currentFragmentState.defaultSampleFlags),T===0&&g!==null&&(E=g);let _=0;h&&(s===0?_=this.metadataReader.readU32():_=this.metadataReader.readI32());let A=!(E&65536);S.samples.push({presentationTimestamp:w+_,duration:C,byteOffset:b,byteSize:P,isKeyFrame:A}),b+=P,w+=C}S.presentationTimestamps=S.samples.map((T,C)=>({presentationTimestamp:T.presentationTimestamp,sampleIndex:C})).sort((T,C)=>T.presentationTimestamp-C.presentationTimestamp);for(let T=0;T<S.presentationTimestamps.length;T++){let C=S.presentationTimestamps[T],P=S.samples[C.sampleIndex];if(S.firstKeyFrameTimestamp===null&&P.isKeyFrame&&(S.firstKeyFrameTimestamp=P.presentationTimestamp),T<S.presentationTimestamps.length-1){let E=S.presentationTimestamps[T+1];P.duration=E.presentationTimestamp-C.presentationTimestamp}}let x=S.samples[S.presentationTimestamps[0].sampleIndex],y=S.samples[z(S.presentationTimestamps).sampleIndex];S.startTimestamp=x.presentationTimestamp,S.endTimestamp=y.presentationTimestamp+y.duration,this.currentFragment.implicitBaseDataOffset=b}break;case"\xA9nam":case"name":{if(!this.currentTrack)break;this.currentTrack.name=xr.decode(this.metadataReader.readBytes(r.contentSize))}break}return this.metadataReader.pos=n,!0}},Ui=class{constructor(e){this.internalTrack=e;this.packetToSampleIndex=new WeakMap;this.packetToFragmentLocation=new WeakMap}getId(){return this.internalTrack.id}getCodec(){throw new Error("Not implemented on base class.")}getInternalCodecId(){return this.internalTrack.internalCodecId}getName(){return this.internalTrack.name}getLanguageCode(){return this.internalTrack.languageCode}getTimeResolution(){return this.internalTrack.timescale}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}async getFirstTimestamp(){return(await this.getFirstPacket({metadataOnly:!0}))?.timestamp??0}async getFirstPacket(e){let t=await this.fetchPacketForSampleIndex(0,e);return t||!this.internalTrack.demuxer.isFragmented?t:this.performFragmentedLookup(()=>{let r=this.internalTrack.demuxer.fragments[0]??null;if(r?.isKnownToBeFirstFragment){let n=r;for(;n;){if(n.trackData.get(this.internalTrack.id))return{fragmentIndex:W(this.internalTrack.fragments,n.moofOffset,s=>s.moofOffset),sampleIndex:0,correctSampleFound:!0};n=n.nextFragment}}return{fragmentIndex:-1,sampleIndex:-1,correctSampleFound:!1}},-1/0,1/0,e)}mapTimestampIntoTimescale(e){return pt(e*this.internalTrack.timescale,14)+this.internalTrack.editListOffset}async getPacket(e,t){let r=this.mapTimestampIntoTimescale(e),n=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),a=ls(n,r),s=await this.fetchPacketForSampleIndex(a,t);return!fs(n)||!this.internalTrack.demuxer.isFragmented?s:this.performFragmentedLookup(()=>this.findSampleInFragmentsForTimestamp(r),r,r,t)}async getNextPacket(e,t){let r=this.packetToSampleIndex.get(e);if(r!==void 0)return this.fetchPacketForSampleIndex(r+1,t);let n=this.packetToFragmentLocation.get(e);if(n===void 0)throw new Error("Packet was not created from this track.");let a=n.fragment.trackData.get(this.internalTrack.id),s=W(this.internalTrack.fragments,n.fragment.moofOffset,o=>o.moofOffset);return m(s!==-1),this.performFragmentedLookup(()=>{if(n.sampleIndex+1<a.samples.length)return{fragmentIndex:s,sampleIndex:n.sampleIndex+1,correctSampleFound:!0};{let o=n.fragment;for(;o.nextFragment;)if(o=o.nextFragment,o.trackData.get(this.internalTrack.id)){let u=W(this.internalTrack.fragments,o.moofOffset,d=>d.moofOffset);return m(u!==-1),{fragmentIndex:u,sampleIndex:0,correctSampleFound:!0}}return{fragmentIndex:s,sampleIndex:-1,correctSampleFound:!1}}},-1/0,1/0,t)}async getKeyPacket(e,t){let r=this.mapTimestampIntoTimescale(e),n=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),a=ls(n,r),s=a===-1?-1:oc(n,a),o=await this.fetchPacketForSampleIndex(s,t);return!fs(n)||!this.internalTrack.demuxer.isFragmented?o:this.performFragmentedLookup(()=>this.findKeySampleInFragmentsForTimestamp(r),r,r,t)}async getNextKeyPacket(e,t){let r=this.packetToSampleIndex.get(e);if(r!==void 0){let o=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),c=cc(o,r);return this.fetchPacketForSampleIndex(c,t)}let n=this.packetToFragmentLocation.get(e);if(n===void 0)throw new Error("Packet was not created from this track.");let a=n.fragment.trackData.get(this.internalTrack.id),s=W(this.internalTrack.fragments,n.fragment.moofOffset,o=>o.moofOffset);return m(s!==-1),this.performFragmentedLookup(()=>{let o=a.samples.findIndex((c,u)=>c.isKeyFrame&&u>n.sampleIndex);if(o!==-1)return{fragmentIndex:s,sampleIndex:o,correctSampleFound:!0};{let c=n.fragment;for(;c.nextFragment;){c=c.nextFragment;let u=c.trackData.get(this.internalTrack.id);if(u&&u.firstKeyFrameTimestamp!==null){let d=W(this.internalTrack.fragments,c.moofOffset,f=>f.moofOffset);m(d!==-1);let l=u.samples.findIndex(f=>f.isKeyFrame);return m(l!==-1),{fragmentIndex:d,sampleIndex:l,correctSampleFound:!0}}}return{fragmentIndex:s,sampleIndex:-1,correctSampleFound:!1}}},-1/0,1/0,t)}async fetchPacketForSampleIndex(e,t){if(e===-1)return null;let r=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),n=sc(r,e);if(!n)return null;let a;t.metadataOnly?a=ie:(await this.internalTrack.demuxer.chunkReader.reader.loadRange(n.chunkOffset,n.chunkOffset+n.chunkSize),this.internalTrack.demuxer.chunkReader.pos=n.sampleOffset,a=this.internalTrack.demuxer.chunkReader.readBytes(n.sampleSize));let s=(n.presentationTimestamp-this.internalTrack.editListOffset)/this.internalTrack.timescale,o=n.duration/this.internalTrack.timescale,c=new M(a,n.isKeyFrame?"key":"delta",s,o,e,n.sampleSize);return this.packetToSampleIndex.set(c,e),c}async fetchPacketInFragment(e,t,r){if(t===-1)return null;let a=e.trackData.get(this.internalTrack.id).samples[t];m(a);let s;r.metadataOnly?s=ie:(await this.internalTrack.demuxer.chunkReader.reader.loadRange(e.dataStart,e.dataEnd),this.internalTrack.demuxer.chunkReader.pos=a.byteOffset,s=this.internalTrack.demuxer.chunkReader.readBytes(a.byteSize));let o=(a.presentationTimestamp-this.internalTrack.editListOffset)/this.internalTrack.timescale,c=a.duration/this.internalTrack.timescale,u=new M(s,a.isKeyFrame?"key":"delta",o,c,e.moofOffset+t,a.byteSize);return this.packetToFragmentLocation.set(u,{fragment:e,sampleIndex:t}),u}findSampleInFragmentsForTimestamp(e){let t=B(this.internalTrack.fragments,e,a=>a.trackData.get(this.internalTrack.id).startTimestamp),r=-1,n=!1;if(t!==-1){let s=this.internalTrack.fragments[t].trackData.get(this.internalTrack.id),o=B(s.presentationTimestamps,e,c=>c.presentationTimestamp);m(o!==-1),r=s.presentationTimestamps[o].sampleIndex,n=e<s.endTimestamp}return{fragmentIndex:t,sampleIndex:r,correctSampleFound:n}}findKeySampleInFragmentsForTimestamp(e){let t=B(this.internalTrack.fragmentsWithKeyFrame,e,s=>s.trackData.get(this.internalTrack.id).startTimestamp),r=-1,n=-1,a=!1;if(t!==-1){let s=this.internalTrack.fragmentsWithKeyFrame[t];r=W(this.internalTrack.fragments,s.moofOffset,d=>d.moofOffset),m(r!==-1);let o=s.trackData.get(this.internalTrack.id),c=_r(o.presentationTimestamps,d=>o.samples[d.sampleIndex].isKeyFrame&&d.presentationTimestamp<=e);m(c!==-1),n=o.presentationTimestamps[c].sampleIndex,a=e<o.endTimestamp}return{fragmentIndex:r,sampleIndex:n,correctSampleFound:a}}async performFragmentedLookup(e,t,r,n){let a=this.internalTrack.demuxer,s=await a.fragmentLookupMutex.acquire();try{let{fragmentIndex:o,sampleIndex:c,correctSampleFound:u}=e();if(u){let S=this.internalTrack.fragments[o];return this.fetchPacketInFragment(S,c,n)}let d=a.metadataReader,l=await d.reader.source.getSize(),f=null,h=o,p=c,k=this.internalTrack.fragmentLookupTable?B(this.internalTrack.fragmentLookupTable,t,S=>S.timestamp):-1,g=k!==-1?this.internalTrack.fragmentLookupTable[k]:null,b=!1;if(o===-1)d.pos=g?.moofOffset??0,b=d.pos===0;else{let S=this.internalTrack.fragments[o];!g||S.moofOffset>=g.moofOffset?(d.pos=S.moofOffset+S.moofSize,f=S):d.pos=g.moofOffset}for(;d.pos<l;){if(f){let y=f.trackData.get(this.internalTrack.id);if(y&&y.startTimestamp>r)break;if(f.nextFragment){d.pos=f.nextFragment.moofOffset+f.nextFragment.moofSize,f=f.nextFragment;continue}}await d.reader.loadRange(d.pos,d.pos+Be);let S=d.pos,x=d.readBoxHeader();if(!x)break;if(x.name==="moof"){let y=W(a.fragments,S,_=>_.moofOffset),T;y===-1?(d.pos=S,T=await a.readFragment()):T=a.fragments[y],f&&(f.nextFragment=T),f=T,b&&(T.isKnownToBeFirstFragment=!0,b=!1);let{fragmentIndex:C,sampleIndex:P,correctSampleFound:E}=e();if(E){let _=this.internalTrack.fragments[C];return this.fetchPacketInFragment(_,P,n)}C!==-1&&(h=C,p=P)}d.pos=S+x.totalSize}let w=h!==-1?this.internalTrack.fragments[h]:null;if(g&&(!w||w.moofOffset<g.moofOffset)){let x=this.internalTrack.fragmentLookupTable[k-1]?.timestamp??-1/0;return this.performFragmentedLookup(e,x,r,n)}return w?this.fetchPacketInFragment(w,p,n):null}finally{s()}}},va=class extends Ui{constructor(t){super(t);this.decoderConfigPromise=null;this.internalTrack=t}getCodec(){return this.internalTrack.info.codec}getCodedWidth(){return this.internalTrack.info.width}getCodedHeight(){return this.internalTrack.info.height}getRotation(){return this.internalTrack.rotation}async getColorSpace(){return{primaries:this.internalTrack.info.colorSpace?.primaries,transfer:this.internalTrack.info.colorSpace?.transfer,matrix:this.internalTrack.info.colorSpace?.matrix,fullRange:this.internalTrack.info.colorSpace?.fullRange}}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfigPromise??=(async()=>{if(this.internalTrack.info.codec==="vp9"&&!this.internalTrack.info.vp9CodecInfo){let t=await this.getFirstPacket({});this.internalTrack.info.vp9CodecInfo=t&&Kr(t.data)}else if(this.internalTrack.info.codec==="av1"&&!this.internalTrack.info.av1CodecInfo){let t=await this.getFirstPacket({});this.internalTrack.info.av1CodecInfo=t&&qr(t.data)}return{codec:Or(this.internalTrack.info),codedWidth:this.internalTrack.info.width,codedHeight:this.internalTrack.info.height,description:this.internalTrack.info.codecDescription??void 0,colorSpace:this.internalTrack.info.colorSpace??void 0}})():null}},Pa=class extends Ui{constructor(t){super(t);this.decoderConfig=null;this.internalTrack=t}getCodec(){return this.internalTrack.info.codec}getNumberOfChannels(){return this.internalTrack.info.numberOfChannels}getSampleRate(){return this.internalTrack.info.sampleRate}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfig??={codec:Mr(this.internalTrack.info),numberOfChannels:this.internalTrack.info.numberOfChannels,sampleRate:this.internalTrack.info.sampleRate,description:this.internalTrack.info.codecDescription??void 0}:null}},ls=(i,e)=>{if(i.presentationTimestamps){let t=B(i.presentationTimestamps,e,r=>r.presentationTimestamp);return t===-1?-1:i.presentationTimestamps[t].sampleIndex}else{let t=B(i.sampleTimingEntries,e,n=>n.startDecodeTimestamp);if(t===-1)return-1;let r=i.sampleTimingEntries[t];return r.startIndex+Math.min(Math.floor((e-r.startDecodeTimestamp)/r.delta),r.count-1)}},sc=(i,e)=>{let t=B(i.sampleTimingEntries,e,b=>b.startIndex),r=i.sampleTimingEntries[t];if(!r||r.startIndex+r.count<=e)return null;let a=r.startDecodeTimestamp+(e-r.startIndex)*r.delta,s=B(i.sampleCompositionTimeOffsets,e,b=>b.startIndex),o=i.sampleCompositionTimeOffsets[s];o&&e-o.startIndex<o.count&&(a+=o.offset);let c=i.sampleSizes[Math.min(e,i.sampleSizes.length-1)],u=B(i.sampleToChunk,e,b=>b.startSampleIndex),d=i.sampleToChunk[u];m(d);let l=d.startChunkIndex+Math.floor((e-d.startSampleIndex)/d.samplesPerChunk),f=i.chunkOffsets[l],h=d.startSampleIndex+(l-d.startChunkIndex)*d.samplesPerChunk,p=0,k=f;if(i.sampleSizes.length===1)k+=c*(e-h),p+=c*d.samplesPerChunk;else for(let b=h;b<h+d.samplesPerChunk;b++){let w=i.sampleSizes[b];b<e&&(k+=w),p+=w}let g=r.delta;if(i.presentationTimestamps){let b=i.presentationTimestampIndexMap[e];m(b!==void 0),b<i.presentationTimestamps.length-1&&(g=i.presentationTimestamps[b+1].presentationTimestamp-a)}return{presentationTimestamp:a,duration:g,sampleOffset:k,sampleSize:c,chunkOffset:f,chunkSize:p,isKeyFrame:i.keySampleIndices?W(i.keySampleIndices,e,b=>b)!==-1:!0}},oc=(i,e)=>{if(!i.keySampleIndices)return e;let t=B(i.keySampleIndices,e,r=>r);return i.keySampleIndices[t]??-1},cc=(i,e)=>{if(!i.keySampleIndices)return e+1;let t=B(i.keySampleIndices,e,r=>r);return i.keySampleIndices[t+1]??-1},ms=(i,e)=>{i.startTimestamp+=e,i.endTimestamp+=e;for(let t of i.samples)t.presentationTimestamp+=e;for(let t of i.presentationTimestamps)t.presentationTimestamp+=e},dc=i=>{let[e,,,t]=i,r=Math.hypot(e,t),n=e/r,a=t/r,s=-Math.atan2(a,n)*(180/Math.PI);return Number.isFinite(s)?s:0},fs=i=>i.sampleSizes.length===0;var Ea=[{id:290298740,flag:"seekHeadSeen"},{id:357149030,flag:"infoSeen"},{id:374648427,flag:"tracksSeen"},{id:475249515,flag:"cuesSeen"}],ps=10*2**20,zi=class extends ue{constructor(t){super(t);this.readMetadataPromise=null;this.segments=[];this.currentSegment=null;this.currentTrack=null;this.currentCluster=null;this.currentBlock=null;this.currentCueTime=null;this.isWebM=!1;this.metadataReader=new et(t._mainReader),this.clusterReader=new et(new fe(t.source,64*2**20))}async computeDuration(){let t=await this.getTracks(),r=await Promise.all(t.map(n=>n.computeDuration()));return Math.max(0,...r)}async getTracks(){return await this.readMetadata(),this.segments.flatMap(t=>t.tracks.map(r=>r.inputTrack))}async getMimeType(){await this.readMetadata();let t=await this.getTracks(),r=await Promise.all(t.map(n=>n.getCodecParameterString()));return ri({isWebM:this.isWebM,hasVideo:this.segments.some(n=>n.tracks.some(a=>a.info?.type==="video")),hasAudio:this.segments.some(n=>n.tracks.some(a=>a.info?.type==="audio")),codecStrings:r.filter(Boolean)})}readMetadata(){return this.readMetadataPromise??=(async()=>{this.metadataReader.pos=0;let t=await this.input.source.getSize();for(;this.metadataReader.pos<=t-ve;){await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+Je);let r=this.metadataReader.readElementHeader();if(!r)break;let n=r.id,a=r.size,s=this.metadataReader.pos;if(n===440786851)tt(a),await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+a),this.readContiguousElements(this.metadataReader,a);else if(n===408125543){if(await this.readSegment(a),a===null)break}else if(n===524531317){a===null&&(a=(await this.clusterReader.searchForNextElementId(ti,t)??t)-s);let o=z(this.segments);o&&(o.elementEndPos=s+a)}tt(a),this.metadataReader.pos=s+a}})()}async readSegment(t){let r=this.metadataReader.pos;this.currentSegment={seekHeadSeen:!1,infoSeen:!1,tracksSeen:!1,cuesSeen:!1,timestampScale:-1,timestampFactor:-1,duration:-1,seekEntries:[],tracks:[],cuePoints:[],dataStartPos:r,elementEndPos:t===null?await this.input.source.getSize():r+t,clusterSeekStartPos:r,clusters:[],clusterLookupMutex:new te},this.segments.push(this.currentSegment),await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+2**14);let n=!1;for(;this.metadataReader.pos<=this.currentSegment.elementEndPos-ve;){await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+Je);let u=this.metadataReader.pos,d=this.metadataReader.readElementHeader();if(!d||!yt.includes(d.id)){this.metadataReader.pos=u;let k=await this.metadataReader.resync(yt,Math.min(this.currentSegment.elementEndPos,this.metadataReader.pos+ps));if(k){this.metadataReader.pos=k;continue}else break}let{id:l,size:f}=d,h=this.metadataReader.pos,p=Ea.findIndex(k=>k.id===l);if(p!==-1){let k=Ea[p].flag;this.currentSegment[k]=!0,tt(f),await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+f),this.readContiguousElements(this.metadataReader,f)}else l===524531317&&(n||(n=!0,this.currentSegment.clusterSeekStartPos=u));if(f!==null&&(this.metadataReader.pos=h+f),this.currentSegment.infoSeen&&this.currentSegment.tracksSeen&&this.currentSegment.cuesSeen)break;if(this.currentSegment.seekHeadSeen){let k=this.currentSegment.infoSeen,g=this.currentSegment.tracksSeen,b=this.currentSegment.cuesSeen;for(let w of this.currentSegment.seekEntries)w.id===357149030?k=!0:w.id===374648427?g=!0:w.id===475249515&&(b=!0);if(k&&g&&b)break}if(f===null)break}if(!n){let u=this.currentSegment.seekEntries.find(d=>d.id===524531317);u?this.currentSegment.clusterSeekStartPos=r+u.segmentPosition:this.currentSegment.clusterSeekStartPos=this.metadataReader.pos}for(let u of Ea){if(this.currentSegment[u.flag])continue;let d=this.currentSegment.seekEntries.find(p=>p.id===u.id);if(!d)continue;this.metadataReader.pos=r+d.segmentPosition,await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+2**12);let l=this.metadataReader.readElementHeader();if(!l)continue;let{id:f,size:h}=l;f===u.id&&(tt(h),this.currentSegment[u.flag]=!0,await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+h),this.readContiguousElements(this.metadataReader,h))}this.currentSegment.timestampScale===-1&&(this.currentSegment.timestampScale=1e6,this.currentSegment.timestampFactor=1e9/1e6),this.currentSegment.tracks.sort((u,d)=>Number(d.isDefault)-Number(u.isDefault)),this.currentSegment.cuePoints.sort((u,d)=>u.clusterPosition-d.clusterPosition);let a=this.currentSegment.tracks.map(u=>u.id),s=new Set,o=null,c=null;for(let u of this.currentSegment.cuePoints){if(u.clusterPosition!==o){for(let l of s)m(c),this.currentSegment.tracks.find(h=>h.id===l).cuePoints.push(c);for(let l of a)s.add(l)}if(c=u,!s.has(u.trackId))continue;this.currentSegment.tracks.find(l=>l.id===u.trackId).cuePoints.push(u),s.delete(u.trackId),o=u.clusterPosition}for(let u of s)m(c),this.currentSegment.tracks.find(l=>l.id===u).cuePoints.push(c);for(let u of this.currentSegment.tracks)u.cuePoints.sort((d,l)=>d.time-l.time);this.currentSegment=null}async readCluster(t){await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+Je);let r=this.metadataReader.pos,n=this.metadataReader.readElementHeader();m(n);let a=n.id,s=n.size,o=this.metadataReader.pos;s===null&&(this.clusterReader.pos=o,s=(await this.clusterReader.searchForNextElementId(ti,t.elementEndPos)??t.elementEndPos)-o),m(a===524531317),this.clusterReader.pos=o,await this.clusterReader.reader.loadRange(this.clusterReader.pos,this.clusterReader.pos+s);let c={elementStartPos:r,elementEndPos:o+s,dataStartPos:o,timestamp:-1,trackData:new Map,nextCluster:null,isKnownToBeFirstCluster:!1};this.currentCluster=c,this.readContiguousElements(this.clusterReader,s);for(let[u,d]of c.trackData){let l=t.tracks.find(g=>g.id===u)??null;m(d.blocks.length>0);let f=!1,h=!1;for(let g=0;g<d.blocks.length;g++){let b=d.blocks[g];b.timestamp+=c.timestamp,f||=b.referencedTimestamps.length>0,h||=b.lacing!==0}f&&(d.blocks=uc(d.blocks)),d.presentationTimestamps=d.blocks.map((g,b)=>({timestamp:g.timestamp,blockIndex:b})).sort((g,b)=>g.timestamp-b.timestamp);for(let g=0;g<d.presentationTimestamps.length;g++){let b=d.presentationTimestamps[g],w=d.blocks[b.blockIndex];if(d.firstKeyFrameTimestamp===null&&w.isKeyFrame&&(d.firstKeyFrameTimestamp=w.timestamp),g<d.presentationTimestamps.length-1){let S=d.presentationTimestamps[g+1];w.duration=S.timestamp-w.timestamp}else w.duration===0&&l?.defaultDuration!=null&&w.lacing===0&&(w.duration=l.defaultDuration)}h&&(this.expandLacedBlocks(d.blocks,l),d.presentationTimestamps=d.blocks.map((g,b)=>({timestamp:g.timestamp,blockIndex:b})).sort((g,b)=>g.timestamp-b.timestamp));let p=d.blocks[d.presentationTimestamps[0].blockIndex],k=d.blocks[z(d.presentationTimestamps).blockIndex];d.startTimestamp=p.timestamp,d.endTimestamp=k.timestamp+k.duration,l&&(be(l.clusters,c,b=>b.elementStartPos),d.firstKeyFrameTimestamp!==null&&be(l.clustersWithKeyFrame,c,b=>b.elementStartPos))}return be(t.clusters,c,u=>u.elementStartPos),this.currentCluster=null,c}getTrackDataInCluster(t,r){let n=t.trackData.get(r);return n||(n={startTimestamp:0,endTimestamp:0,firstKeyFrameTimestamp:null,blocks:[],presentationTimestamps:[]},t.trackData.set(r,n)),n}expandLacedBlocks(t,r){for(let n=0;n<t.length;n++){let a=t[n];if(a.lacing===0)continue;let s=a.data,o=0,c=[],u=s[o]+1;switch(o++,a.lacing){case 1:{let l=0;for(let f=0;f<u-1;f++){let h=0;for(;o<s.length;){let p=s[o];if(h+=p,o++,p<255){c.push(h),l+=h;break}}}c.push(s.length-(o+l))}break;case 2:{let l=s.length-1,f=Math.floor(l/u);for(let h=0;h<u;h++)c.push(f)}break;case 3:{let l=da(s,o),f=l.value;c.push(f),o+=l.width;let h=f;for(let p=1;p<u-1;p++){let k=da(s,o),g=k.value,b=(1<<k.width*7-1)-1,w=g-b;f+=w,c.push(f),o+=k.width,h+=f}c.push(s.length-(o+h))}break;default:m(!1)}m(c.length===u),t.splice(n,1);let d=o;for(let l=0;l<u;l++){let f=c[l],h=s.subarray(d,d+f),p=a.duration||u*(r?.defaultDuration??0),k=a.timestamp+p*l/u,g=p/u;t.splice(n+l,0,{timestamp:k,duration:g,isKeyFrame:a.isKeyFrame,referencedTimestamps:a.referencedTimestamps,data:h,lacing:0}),d+=f}n+=u,n--}}readContiguousElements(t,r){let n=t.pos;for(;t.pos-n<=r-ve&&this.traverseElement(t););}traverseElement(t){let r=t.readElementHeader();if(!r)return!1;let{id:n,size:a}=r,s=t.pos;switch(tt(a),n){case 17026:this.isWebM=t.readAsciiString(a)==="webm";break;case 19899:{if(!this.currentSegment)break;let o={id:-1,segmentPosition:-1};this.currentSegment.seekEntries.push(o),this.readContiguousElements(t,a),(o.id===-1||o.segmentPosition===-1)&&this.currentSegment.seekEntries.pop()}break;case 21419:{let o=this.currentSegment?.seekEntries[this.currentSegment.seekEntries.length-1];if(!o)break;o.id=t.readUnsignedInt(a)}break;case 21420:{let o=this.currentSegment?.seekEntries[this.currentSegment.seekEntries.length-1];if(!o)break;o.segmentPosition=t.readUnsignedInt(a)}break;case 2807729:{if(!this.currentSegment)break;this.currentSegment.timestampScale=t.readUnsignedInt(a),this.currentSegment.timestampFactor=1e9/this.currentSegment.timestampScale}break;case 17545:{if(!this.currentSegment)break;this.currentSegment.duration=t.readFloat(a)}break;case 174:{if(!this.currentSegment)break;if(this.currentTrack={id:-1,segment:this.currentSegment,demuxer:this,clusters:[],clustersWithKeyFrame:[],cuePoints:[],isDefault:!1,inputTrack:null,codecId:null,codecPrivate:null,defaultDuration:null,name:null,languageCode:Q,info:null},this.readContiguousElements(t,a),this.currentTrack&&this.currentTrack.id!==-1&&this.currentTrack.codecId&&this.currentTrack.info){let o=this.currentTrack.codecId.indexOf("/"),c=o===-1?this.currentTrack.codecId:this.currentTrack.codecId.slice(0,o);if(this.currentTrack.info.type==="video"&&this.currentTrack.info.width!==-1&&this.currentTrack.info.height!==-1){this.currentTrack.codecId===le.avc?(this.currentTrack.info.codec="avc",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId===le.hevc?(this.currentTrack.info.codec="hevc",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):c===le.vp8?this.currentTrack.info.codec="vp8":c===le.vp9?this.currentTrack.info.codec="vp9":c===le.av1&&(this.currentTrack.info.codec="av1");let u=this.currentTrack,d=new me(new Ia(u));this.currentTrack.inputTrack=d,this.currentSegment.tracks.push(this.currentTrack)}else if(this.currentTrack.info.type==="audio"&&this.currentTrack.info.numberOfChannels!==-1&&this.currentTrack.info.sampleRate!==-1){c===le.aac?(this.currentTrack.info.codec="aac",this.currentTrack.info.aacCodecInfo={isMpeg2:this.currentTrack.codecId.includes("MPEG2")},this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId===le.mp3?this.currentTrack.info.codec="mp3":c===le.opus?(this.currentTrack.info.codec="opus",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):c===le.vorbis?(this.currentTrack.info.codec="vorbis",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):c===le.flac?(this.currentTrack.info.codec="flac",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId==="A_PCM/INT/LIT"?this.currentTrack.info.bitDepth===8?this.currentTrack.info.codec="pcm-u8":this.currentTrack.info.bitDepth===16?this.currentTrack.info.codec="pcm-s16":this.currentTrack.info.bitDepth===24?this.currentTrack.info.codec="pcm-s24":this.currentTrack.info.bitDepth===32&&(this.currentTrack.info.codec="pcm-s32"):this.currentTrack.codecId==="A_PCM/INT/BIG"?this.currentTrack.info.bitDepth===8?this.currentTrack.info.codec="pcm-u8":this.currentTrack.info.bitDepth===16?this.currentTrack.info.codec="pcm-s16be":this.currentTrack.info.bitDepth===24?this.currentTrack.info.codec="pcm-s24be":this.currentTrack.info.bitDepth===32&&(this.currentTrack.info.codec="pcm-s32be"):this.currentTrack.codecId==="A_PCM/FLOAT/IEEE"&&(this.currentTrack.info.bitDepth===32?this.currentTrack.info.codec="pcm-f32":this.currentTrack.info.bitDepth===64&&(this.currentTrack.info.codec="pcm-f64"));let u=this.currentTrack,d=new $(new _a(u));this.currentTrack.inputTrack=d,this.currentSegment.tracks.push(this.currentTrack)}}this.currentTrack=null}break;case 215:{if(!this.currentTrack)break;this.currentTrack.id=t.readUnsignedInt(a)}break;case 131:{if(!this.currentTrack)break;let o=t.readUnsignedInt(a);o===1?this.currentTrack.info={type:"video",width:-1,height:-1,rotation:0,codec:null,codecDescription:null,colorSpace:null}:o===2&&(this.currentTrack.info={type:"audio",numberOfChannels:-1,sampleRate:-1,bitDepth:-1,codec:null,codecDescription:null,aacCodecInfo:null})}break;case 185:{if(!this.currentTrack)break;t.readUnsignedInt(a)||(this.currentSegment.tracks.pop(),this.currentTrack=null)}break;case 136:{if(!this.currentTrack)break;this.currentTrack.isDefault=!!t.readUnsignedInt(a)}break;case 134:{if(!this.currentTrack)break;this.currentTrack.codecId=t.readAsciiString(a)}break;case 25506:{if(!this.currentTrack)break;this.currentTrack.codecPrivate=t.readBytes(a)}break;case 2352003:{if(!this.currentTrack)break;this.currentTrack.defaultDuration=this.currentTrack.segment.timestampFactor*t.readUnsignedInt(a)/1e9}break;case 21358:{if(!this.currentTrack)break;this.currentTrack.name=t.readUnicodeString(a)}break;case 2274716:{if(!this.currentTrack||this.currentTrack.languageCode!==Q)break;this.currentTrack.languageCode=t.readAsciiString(a),Fe(this.currentTrack.languageCode)||(this.currentTrack.languageCode=Q)}break;case 2274717:{if(!this.currentTrack)break;let c=t.readAsciiString(a).split("-")[0];c?this.currentTrack.languageCode=c:this.currentTrack.languageCode=Q}break;case 224:{if(this.currentTrack?.info?.type!=="video")break;this.readContiguousElements(t,a)}break;case 176:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.width=t.readUnsignedInt(a)}break;case 186:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.height=t.readUnsignedInt(a)}break;case 21936:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.colorSpace={},this.readContiguousElements(t,a)}break;case 21937:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;let o=t.readUnsignedInt(a),c=Er[o]??null;this.currentTrack.info.colorSpace.matrix=c}break;case 21945:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;this.currentTrack.info.colorSpace.fullRange=t.readUnsignedInt(a)===2}break;case 21946:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;let o=t.readUnsignedInt(a),c=Pr[o]??null;this.currentTrack.info.colorSpace.transfer=c}break;case 21947:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;let o=t.readUnsignedInt(a),c=vr[o]??null;this.currentTrack.info.colorSpace.primaries=c}break;case 30320:{if(this.currentTrack?.info?.type!=="video")break;this.readContiguousElements(t,a)}break;case 30325:{if(this.currentTrack?.info?.type!=="video")break;let c=-t.readFloat(a);try{this.currentTrack.info.rotation=Ue(c)}catch{}}break;case 225:{if(this.currentTrack?.info?.type!=="audio")break;this.readContiguousElements(t,a)}break;case 181:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.sampleRate=t.readFloat(a)}break;case 159:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.numberOfChannels=t.readUnsignedInt(a)}break;case 25188:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.bitDepth=t.readUnsignedInt(a)}break;case 187:{if(!this.currentSegment)break;this.readContiguousElements(t,a),this.currentCueTime=null}break;case 179:this.currentCueTime=t.readUnsignedInt(a);break;case 183:{if(this.currentCueTime===null)break;m(this.currentSegment);let o={time:this.currentCueTime,trackId:-1,clusterPosition:-1};this.currentSegment.cuePoints.push(o),this.readContiguousElements(t,a),(o.trackId===-1||o.clusterPosition===-1)&&this.currentSegment.cuePoints.pop()}break;case 247:{let o=this.currentSegment?.cuePoints[this.currentSegment.cuePoints.length-1];if(!o)break;o.trackId=t.readUnsignedInt(a)}break;case 241:{let o=this.currentSegment?.cuePoints[this.currentSegment.cuePoints.length-1];if(!o)break;m(this.currentSegment),o.clusterPosition=this.currentSegment.dataStartPos+t.readUnsignedInt(a)}break;case 231:{if(!this.currentCluster)break;this.currentCluster.timestamp=t.readUnsignedInt(a)}break;case 163:{if(!this.currentCluster)break;let o=t.readVarInt();if(o===null)break;let c=t.readS16(),u=t.readU8(),d=!!(u&128),l=u>>1&3;this.getTrackDataInCluster(this.currentCluster,o).blocks.push({timestamp:c,duration:0,isKeyFrame:d,referencedTimestamps:[],data:t.readBytes(a-(t.pos-s)),lacing:l})}break;case 160:{if(!this.currentCluster)break;if(this.readContiguousElements(t,a),this.currentBlock){for(let o=0;o<this.currentBlock.referencedTimestamps.length;o++)this.currentBlock.referencedTimestamps[o]+=this.currentBlock.timestamp;this.currentBlock=null}}break;case 161:{if(!this.currentCluster)break;let o=t.readVarInt();if(o===null)break;let c=t.readS16(),d=t.readU8()>>1&3,l=this.getTrackDataInCluster(this.currentCluster,o);this.currentBlock={timestamp:c,duration:0,isKeyFrame:!0,referencedTimestamps:[],data:t.readBytes(a-(t.pos-s)),lacing:d},l.blocks.push(this.currentBlock)}break;case 155:{if(!this.currentBlock)break;this.currentBlock.duration=t.readUnsignedInt(a)}break;case 251:{if(!this.currentBlock)break;this.currentBlock.isKeyFrame=!1;let o=t.readSignedInt(a);this.currentBlock.referencedTimestamps.push(o)}break}return t.pos=s+a,!0}},Ni=class{constructor(e){this.internalTrack=e;this.packetToClusterLocation=new WeakMap}getId(){return this.internalTrack.id}getCodec(){throw new Error("Not implemented on base class.")}getInternalCodecId(){return this.internalTrack.codecId}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getName(){return this.internalTrack.name}getLanguageCode(){return this.internalTrack.languageCode}async getFirstTimestamp(){return(await this.getFirstPacket({metadataOnly:!0}))?.timestamp??0}getTimeResolution(){return this.internalTrack.segment.timestampFactor}async getFirstPacket(e){return this.performClusterLookup(()=>{let t=this.internalTrack.segment.clusters[0]??null;if(t?.isKnownToBeFirstCluster){let r=t;for(;r;){if(r.trackData.get(this.internalTrack.id))return{clusterIndex:W(this.internalTrack.clusters,r.elementStartPos,a=>a.elementStartPos),blockIndex:0,correctBlockFound:!0};r=r.nextCluster}}return{clusterIndex:-1,blockIndex:-1,correctBlockFound:!1}},-1/0,1/0,e)}intoTimescale(e){return pt(e*this.internalTrack.segment.timestampFactor,14)}async getPacket(e,t){let r=this.intoTimescale(e);return this.performClusterLookup(()=>this.findBlockInClustersForTimestamp(r),r,r,t)}async getNextPacket(e,t){let r=this.packetToClusterLocation.get(e);if(r===void 0)throw new Error("Packet was not created from this track.");let n=r.cluster.trackData.get(this.internalTrack.id),a=W(this.internalTrack.clusters,r.cluster.elementStartPos,s=>s.elementStartPos);return m(a!==-1),this.performClusterLookup(()=>{if(r.blockIndex+1<n.blocks.length)return{clusterIndex:a,blockIndex:r.blockIndex+1,correctBlockFound:!0};{let s=r.cluster;for(;s.nextCluster;)if(s=s.nextCluster,s.trackData.get(this.internalTrack.id)){let c=W(this.internalTrack.clusters,s.elementStartPos,u=>u.elementStartPos);return m(c!==-1),{clusterIndex:c,blockIndex:0,correctBlockFound:!0}}return{clusterIndex:a,blockIndex:-1,correctBlockFound:!1}}},-1/0,1/0,t)}async getKeyPacket(e,t){let r=this.intoTimescale(e);return this.performClusterLookup(()=>this.findKeyBlockInClustersForTimestamp(r),r,r,t)}async getNextKeyPacket(e,t){let r=this.packetToClusterLocation.get(e);if(r===void 0)throw new Error("Packet was not created from this track.");let n=r.cluster.trackData.get(this.internalTrack.id),a=W(this.internalTrack.clusters,r.cluster.elementStartPos,s=>s.elementStartPos);return m(a!==-1),this.performClusterLookup(()=>{let s=n.blocks.findIndex((o,c)=>o.isKeyFrame&&c>r.blockIndex);if(s!==-1)return{clusterIndex:a,blockIndex:s,correctBlockFound:!0};{let o=r.cluster;for(;o.nextCluster;){o=o.nextCluster;let c=o.trackData.get(this.internalTrack.id);if(c&&c.firstKeyFrameTimestamp!==null){let u=W(this.internalTrack.clusters,o.elementStartPos,l=>l.elementStartPos);m(u!==-1);let d=c.blocks.findIndex(l=>l.isKeyFrame);return m(d!==-1),{clusterIndex:u,blockIndex:d,correctBlockFound:!0}}}return{clusterIndex:a,blockIndex:-1,correctBlockFound:!1}}},-1/0,1/0,t)}async fetchPacketInCluster(e,t,r){if(t===-1)return null;let a=e.trackData.get(this.internalTrack.id).blocks[t];m(a);let s=r.metadataOnly?ie:a.data,o=a.timestamp/this.internalTrack.segment.timestampFactor,c=a.duration/this.internalTrack.segment.timestampFactor,u=new M(s,a.isKeyFrame?"key":"delta",o,c,e.dataStartPos+t,a.data.byteLength);return this.packetToClusterLocation.set(u,{cluster:e,blockIndex:t}),u}findBlockInClustersForTimestamp(e){let t=B(this.internalTrack.clusters,e,a=>a.trackData.get(this.internalTrack.id).startTimestamp),r=-1,n=!1;if(t!==-1){let s=this.internalTrack.clusters[t].trackData.get(this.internalTrack.id),o=B(s.presentationTimestamps,e,c=>c.timestamp);m(o!==-1),r=s.presentationTimestamps[o].blockIndex,n=e<s.endTimestamp}return{clusterIndex:t,blockIndex:r,correctBlockFound:n}}findKeyBlockInClustersForTimestamp(e){let t=B(this.internalTrack.clustersWithKeyFrame,e,s=>s.trackData.get(this.internalTrack.id).firstKeyFrameTimestamp),r=-1,n=-1,a=!1;if(t!==-1){let s=this.internalTrack.clustersWithKeyFrame[t];r=W(this.internalTrack.clusters,s.elementStartPos,d=>d.elementStartPos),m(r!==-1);let o=s.trackData.get(this.internalTrack.id),c=_r(o.presentationTimestamps,d=>o.blocks[d.blockIndex].isKeyFrame&&d.timestamp<=e);m(c!==-1),n=o.presentationTimestamps[c].blockIndex,a=e<o.endTimestamp}return{clusterIndex:r,blockIndex:n,correctBlockFound:a}}async performClusterLookup(e,t,r,n){let{demuxer:a,segment:s}=this.internalTrack,o=await s.clusterLookupMutex.acquire();try{let{clusterIndex:c,blockIndex:u,correctBlockFound:d}=e();if(d){let x=this.internalTrack.clusters[c];return this.fetchPacketInCluster(x,u,n)}let l=a.metadataReader,f=a.clusterReader,h=null,p=c,k=u,g=B(this.internalTrack.cuePoints,t,x=>x.time),b=g!==-1?this.internalTrack.cuePoints[g]:null,w=!1;if(c===-1)l.pos=b?.clusterPosition??s.clusterSeekStartPos,w=l.pos===s.clusterSeekStartPos;else{let x=this.internalTrack.clusters[c];!b||x.elementStartPos>=b.clusterPosition?(l.pos=x.elementEndPos,h=x):l.pos=b.clusterPosition}for(;l.pos<=s.elementEndPos-ve;){if(h){let E=h.trackData.get(this.internalTrack.id);if(E&&E.startTimestamp>r)break;if(h.nextCluster){l.pos=h.nextCluster.elementEndPos,h=h.nextCluster;continue}}await l.reader.loadRange(l.pos,l.pos+Je);let x=l.pos,y=l.readElementHeader();if(!y||!yt.includes(y.id)){l.pos=x;let E=await l.resync(yt,Math.min(s.elementEndPos,l.pos+ps));if(E){l.pos=E;continue}else break}let T=y.id,C=y.size,P=l.pos;if(T===524531317){let E=W(s.clusters,x,Z=>Z.elementStartPos),_;E===-1?(l.pos=x,_=await a.readCluster(s)):_=s.clusters[E],h&&(h.nextCluster=_),h=_,w&&(_.isKnownToBeFirstCluster=!0,w=!1);let{clusterIndex:A,blockIndex:V,correctBlockFound:H}=e();if(H){let Z=this.internalTrack.clusters[A];return this.fetchPacketInCluster(Z,V,n)}A!==-1&&(p=A,k=V)}if(C===null){T===524531317?(m(h),C=h.elementEndPos-P):(f.pos=P,C=(await f.searchForNextElementId(ti,s.elementEndPos)??s.elementEndPos)-P);let E=P+C;if(E>s.elementEndPos-ve)break;if(f.pos=E,f.readElementId()===408125543){s.elementEndPos=E;break}}l.pos=P+C}let S=p!==-1?this.internalTrack.clusters[p]:null;if(b&&(!S||S.elementStartPos<b.clusterPosition)){let y=this.internalTrack.cuePoints[g-1]?.time??-1/0;return this.performClusterLookup(e,y,r,n)}return S?this.fetchPacketInCluster(S,k,n):null}finally{o()}}},Ia=class extends Ni{constructor(t){super(t);this.decoderConfigPromise=null;this.internalTrack=t}getCodec(){return this.internalTrack.info.codec}getCodedWidth(){return this.internalTrack.info.width}getCodedHeight(){return this.internalTrack.info.height}getRotation(){return this.internalTrack.info.rotation}async getColorSpace(){return{primaries:this.internalTrack.info.colorSpace?.primaries,transfer:this.internalTrack.info.colorSpace?.transfer,matrix:this.internalTrack.info.colorSpace?.matrix,fullRange:this.internalTrack.info.colorSpace?.fullRange}}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfigPromise??=(async()=>{let t=null;return(this.internalTrack.info.codec==="vp9"||this.internalTrack.info.codec==="av1"||this.internalTrack.info.codec==="avc"&&!this.internalTrack.info.codecDescription||this.internalTrack.info.codec==="hevc"&&!this.internalTrack.info.codecDescription)&&(t=await this.getFirstPacket({})),{codec:Or({width:this.internalTrack.info.width,height:this.internalTrack.info.height,codec:this.internalTrack.info.codec,codecDescription:this.internalTrack.info.codecDescription,colorSpace:this.internalTrack.info.colorSpace,avcCodecInfo:this.internalTrack.info.codec==="avc"&&t?Wr(t.data):null,hevcCodecInfo:this.internalTrack.info.codec==="hevc"&&t?Hr(t.data):null,vp9CodecInfo:this.internalTrack.info.codec==="vp9"&&t?Kr(t.data):null,av1CodecInfo:this.internalTrack.info.codec==="av1"&&t?qr(t.data):null}),codedWidth:this.internalTrack.info.width,codedHeight:this.internalTrack.info.height,description:this.internalTrack.info.codecDescription??void 0,colorSpace:this.internalTrack.info.colorSpace??void 0}})():null}},_a=class extends Ni{constructor(t){super(t);this.decoderConfig=null;this.internalTrack=t}getCodec(){return this.internalTrack.info.codec}getNumberOfChannels(){return this.internalTrack.info.numberOfChannels}getSampleRate(){return this.internalTrack.info.sampleRate}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfig??={codec:Mr({codec:this.internalTrack.info.codec,codecDescription:this.internalTrack.info.codecDescription,aacCodecInfo:this.internalTrack.info.aacCodecInfo}),numberOfChannels:this.internalTrack.info.numberOfChannels,sampleRate:this.internalTrack.info.sampleRate,description:this.internalTrack.info.codecDescription??void 0}:null}},uc=i=>{let e=new Map;for(let a=0;a<i.length;a++){let s=i[a];e.set(s.timestamp,s)}let t=new Set,r=[],n=a=>{if(!t.has(a)){t.add(a);for(let s=0;s<a.referencedTimestamps.length;s++){let o=a.referencedTimestamps[s],c=e.get(o);c&&n(c)}r.push(a)}};for(let a=0;a<i.length;a++)n(i[a]);return r};var zt=class{constructor(e){this.reader=e;this.pos=0;this.fileSize=null}readBytes(e){let{view:t,offset:r}=this.reader.getViewAndOffset(this.pos,this.pos+e);return this.pos+=e,new Uint8Array(t.buffer,r,e)}readU16(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+2);return this.pos+=2,e.getUint16(t,!1)}readU32(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+4);return this.pos+=4,e.getUint32(t,!1)}readAscii(e){let{view:t,offset:r}=this.reader.getViewAndOffset(this.pos,this.pos+e);this.pos+=e;let n="";for(let a=0;a<e;a++)n+=String.fromCharCode(t.getUint8(r+a));return n}readId3(){return this.readAscii(3)!=="ID3"?(this.pos-=3,null):(this.pos+=3,{size:lc(this.readU32())})}readNextFrameHeader(e){for(m(this.fileSize),e??=this.fileSize;this.pos<=e-4;){let t=this.readU32();this.pos-=4;let r=si(t,this);if(r)return r}return null}},lc=i=>{let e=2130706432,t=0;for(;e!==0;)t>>=1,t|=i&e,e>>=8;return t};var Li=class extends ue{constructor(t){super(t);this.metadataPromise=null;this.firstFrameHeader=null;this.loadedSamples=[];this.tracks=[];this.readingMutex=new te;this.lastLoadedPos=0;this.fileSize=0;this.nextTimestampInSamples=0;this.reader=new zt(t._mainReader)}async readMetadata(){return this.metadataPromise??=(async()=>{for(this.fileSize=await this.input.source.getSize(),this.reader.fileSize=this.fileSize;!this.firstFrameHeader&&this.lastLoadedPos<this.fileSize;)await this.loadNextChunk();m(this.firstFrameHeader),this.tracks=[new $(new Ra(this))]})()}async loadNextChunk(){m(this.lastLoadedPos<this.fileSize);let t=.5*1024*1024,r=Math.min(this.lastLoadedPos+t,this.fileSize);if(await this.reader.reader.loadRange(this.lastLoadedPos,r),this.lastLoadedPos=r,m(this.lastLoadedPos<=this.fileSize),this.reader.pos===0){let n=this.reader.readId3();n&&(this.reader.pos+=n.size)}this.parseFramesFromLoadedData()}parseFramesFromLoadedData(){for(;;){let t=this.reader.pos,r=this.reader.readNextFrameHeader();if(!r)break;if(r.startPos+r.totalSize>this.lastLoadedPos){this.reader.pos=t,this.lastLoadedPos=t;break}let n=Ct(r.mpegVersionId,r.channel);this.reader.pos=r.startPos+n;let a=this.reader.readU32(),s=a===St||a===ai;if(this.reader.pos=r.startPos+r.totalSize-1,s)continue;this.firstFrameHeader||(this.firstFrameHeader=r);let o=r.audioSamplesInFrame/r.sampleRate,c={timestamp:this.nextTimestampInSamples/r.sampleRate,duration:o,dataStart:r.startPos,dataSize:r.totalSize};this.loadedSamples.push(c),this.nextTimestampInSamples+=r.audioSamplesInFrame}}async getMimeType(){return"audio/mpeg"}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){await this.readMetadata();let t=this.tracks[0];return m(t),t.computeDuration()}},Ra=class{constructor(e){this.demuxer=e}getId(){return 1}async getFirstTimestamp(){return 0}getTimeResolution(){return m(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.sampleRate/this.demuxer.firstFrameHeader.audioSamplesInFrame}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getName(){return null}getLanguageCode(){return Q}getCodec(){return"mp3"}getInternalCodecId(){return null}getNumberOfChannels(){return m(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.channel===3?1:2}getSampleRate(){return m(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.sampleRate}async getDecoderConfig(){return m(this.demuxer.firstFrameHeader),{codec:"mp3",numberOfChannels:this.demuxer.firstFrameHeader.channel===3?1:2,sampleRate:this.demuxer.firstFrameHeader.sampleRate}}getPacketAtIndex(e,t){if(e===-1)return null;let r=this.demuxer.loadedSamples[e];if(!r)return null;let n;return t.metadataOnly?n=ie:(this.demuxer.reader.pos=r.dataStart,n=this.demuxer.reader.readBytes(r.dataSize)),new M(n,"key",r.timestamp,r.duration,e,r.dataSize)}async getFirstPacket(e){return this.getPacketAtIndex(0,e)}async getNextPacket(e,t){let r=await this.demuxer.readingMutex.acquire();try{let n=W(this.demuxer.loadedSamples,e.timestamp,s=>s.timestamp);if(n===-1)throw new Error("Packet was not created from this track.");let a=n+1;for(;a>=this.demuxer.loadedSamples.length&&this.demuxer.lastLoadedPos<this.demuxer.fileSize;)await this.demuxer.loadNextChunk();return this.getPacketAtIndex(a,t)}finally{r()}}async getPacket(e,t){let r=await this.demuxer.readingMutex.acquire();try{for(;;){let n=B(this.demuxer.loadedSamples,e,a=>a.timestamp);if(n===-1&&this.demuxer.loadedSamples.length>0)return null;if(this.demuxer.lastLoadedPos===this.demuxer.fileSize)return this.getPacketAtIndex(n,t);if(n>=0&&n+1<this.demuxer.loadedSamples.length)return this.getPacketAtIndex(n,t);await this.demuxer.loadNextChunk()}}finally{r()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}};var Wi=class extends ue{constructor(t){super(t);this.readingMutex=new te;this.metadataPromise=null;this.fileSize=null;this.bitstreams=[];this.tracks=[];this.reader=new xt(new fe(t.source,64*2**20))}async readMetadata(){return this.metadataPromise??=(async()=>{for(this.fileSize=await this.input.source.getSize();this.reader.pos<this.fileSize-vt;){await this.reader.reader.loadRange(this.reader.pos,this.reader.pos+it);let t=this.reader.readPageHeader();if(!t||!!!(t.headerType&2))break;this.bitstreams.push({serialNumber:t.serialNumber,bosPage:t,description:null,numberOfChannels:-1,sampleRate:-1,codecInfo:{codec:null,vorbisInfo:null,opusInfo:null},lastMetadataPacket:null}),this.reader.pos=t.headerStartPos+t.totalSize}for(let t of this.bitstreams){let r=await this.readPacket(this.reader,t.bosPage,0);r&&(r.data.byteLength>=7&&r.data[0]===1&&r.data[1]===118&&r.data[2]===111&&r.data[3]===114&&r.data[4]===98&&r.data[5]===105&&r.data[6]===115?await this.readVorbisMetadata(r,t):r.data.byteLength>=8&&r.data[0]===79&&r.data[1]===112&&r.data[2]===117&&r.data[3]===115&&r.data[4]===72&&r.data[5]===101&&r.data[6]===97&&r.data[7]===100&&await this.readOpusMetadata(r,t),t.codecInfo.codec!==null&&this.tracks.push(new $(new Fa(t,this))))}})()}async readVorbisMetadata(t,r){let n=await this.findNextPacketStart(this.reader,t);if(!n)return;let a=await this.readPacket(this.reader,n.startPage,n.startSegmentIndex);if(!a||(n=await this.findNextPacketStart(this.reader,a),!n))return;let s=await this.readPacket(this.reader,n.startPage,n.startSegmentIndex);if(!s||a.data[0]!==3||s.data[0]!==5)return;let o=[],c=f=>{for(;o.push(Math.min(255,f)),!(f<255);)f-=255};c(t.data.length),c(a.data.length);let u=new Uint8Array(1+o.length+t.data.length+a.data.length+s.data.length);u[0]=o.length,u.set(o,1),u.set(t.data,1+o.length),u.set(a.data,1+o.length+t.data.length),u.set(s.data,1+o.length+t.data.length+a.data.length),r.codecInfo.codec="vorbis",r.description=u,r.lastMetadataPacket=s;let d=re(t.data);r.numberOfChannels=d.getUint8(11),r.sampleRate=d.getUint32(12,!0);let l=d.getUint8(28);r.codecInfo.vorbisInfo={blocksizes:[1<<(l&15),1<<(l>>4)],modeBlockflags:Qr(s.data).modeBlockflags}}async readOpusMetadata(t,r){let n=await this.findNextPacketStart(this.reader,t);if(!n)return;let a=await this.readPacket(this.reader,n.startPage,n.startSegmentIndex);if(!a)return;r.codecInfo.codec="opus",r.description=t.data,r.lastMetadataPacket=a;let s=ze(t.data);r.numberOfChannels=s.outputChannelCount,r.sampleRate=s.inputSampleRate,r.codecInfo.opusInfo={preSkip:s.preSkip}}async readPacket(t,r,n){m(n<r.lacingValues.length),m(this.fileSize);let a=0;for(let h=0;h<n;h++)a+=r.lacingValues[h];let s=r,o=a,c=n,u=[];e:for(;;){await t.reader.loadRange(s.dataStartPos,s.dataStartPos+s.dataSize),t.pos=s.dataStartPos;let h=t.readBytes(s.dataSize);for(;;){if(c===s.lacingValues.length){u.push(h.subarray(a,o));break}let p=s.lacingValues[c];if(o+=p,p<255){u.push(h.subarray(a,o));break e}c++}for(;;){if(t.pos=s.headerStartPos+s.totalSize,t.pos>=this.fileSize-vt)return null;await t.reader.loadRange(t.pos,t.pos+it);let p=t.readPageHeader();if(!p)return null;if(s=p,s.serialNumber===r.serialNumber)break}a=0,o=0,c=0}let d=u.reduce((h,p)=>h+p.length,0),l=new Uint8Array(d),f=0;for(let h=0;h<u.length;h++){let p=u[h];l.set(p,f),f+=p.length}return{data:l,endPage:s,endSegmentIndex:c}}async findNextPacketStart(t,r){if(m(this.fileSize!==null),r.endSegmentIndex<r.endPage.lacingValues.length-1)return{startPage:r.endPage,startSegmentIndex:r.endSegmentIndex+1};if(!!(r.endPage.headerType&4))return null;for(t.pos=r.endPage.headerStartPos+r.endPage.totalSize;;){if(t.pos>=this.fileSize-vt)return null;await t.reader.loadRange(t.pos,t.pos+it);let a=t.readPageHeader();if(!a)return null;if(a.serialNumber===r.endPage.serialNumber)return{startPage:a,startSegmentIndex:0};t.pos=a.headerStartPos+a.totalSize}}async getMimeType(){await this.readMetadata();let t=await Promise.all(this.tracks.map(r=>r.getCodecParameterString()));return li({codecStrings:t.filter(Boolean)})}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){let t=await this.getTracks(),r=await Promise.all(t.map(n=>n.computeDuration()));return Math.max(0,...r)}},Fa=class{constructor(e,t){this.bitstream=e;this.demuxer=t;this.encodedPacketToMetadata=new WeakMap;this.internalSampleRate=e.codecInfo.codec==="opus"?ht:e.sampleRate}getId(){return this.bitstream.serialNumber}getNumberOfChannels(){return this.bitstream.numberOfChannels}getSampleRate(){return this.bitstream.sampleRate}getTimeResolution(){return this.bitstream.sampleRate}getCodec(){return this.bitstream.codecInfo.codec}getInternalCodecId(){return null}async getDecoderConfig(){return m(this.bitstream.codecInfo.codec),{codec:this.bitstream.codecInfo.codec,numberOfChannels:this.bitstream.numberOfChannels,sampleRate:this.bitstream.sampleRate,description:this.bitstream.description??void 0}}getName(){return null}getLanguageCode(){return Q}async getFirstTimestamp(){return 0}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}granulePositionToTimestampInSamples(e){return this.bitstream.codecInfo.codec==="opus"?(m(this.bitstream.codecInfo.opusInfo),e-this.bitstream.codecInfo.opusInfo.preSkip):e}createEncodedPacketFromOggPacket(e,t,r){if(!e)return null;let{durationInSamples:n,vorbisBlockSize:a}=ui(e.data,this.bitstream.codecInfo,t.vorbisLastBlocksize),s=new M(r.metadataOnly?ie:e.data,"key",Math.max(0,t.timestampInSamples)/this.internalSampleRate,n/this.internalSampleRate,e.endPage.headerStartPos+e.endSegmentIndex,e.data.byteLength);return this.encodedPacketToMetadata.set(s,{packet:e,timestampInSamples:t.timestampInSamples,durationInSamples:n,vorbisBlockSize:a}),s}async getFirstPacket(e,t=!0){let r=t?await this.demuxer.readingMutex.acquire():null;try{m(this.bitstream.lastMetadataPacket);let n=await this.demuxer.findNextPacketStart(this.demuxer.reader,this.bitstream.lastMetadataPacket);if(!n)return null;let a=0;this.bitstream.codecInfo.codec==="opus"&&(m(this.bitstream.codecInfo.opusInfo),a-=this.bitstream.codecInfo.opusInfo.preSkip);let s=await this.demuxer.readPacket(this.demuxer.reader,n.startPage,n.startSegmentIndex);return this.createEncodedPacketFromOggPacket(s,{timestampInSamples:a,vorbisLastBlocksize:null},e)}finally{r?.()}}async getNextPacket(e,t){let r=await this.demuxer.readingMutex.acquire();try{let n=this.encodedPacketToMetadata.get(e);if(!n)throw new Error("Packet was not created from this track.");let a=await this.demuxer.findNextPacketStart(this.demuxer.reader,n.packet);if(!a)return null;let s=n.timestampInSamples+n.durationInSamples,o=await this.demuxer.readPacket(this.demuxer.reader,a.startPage,a.startSegmentIndex);return this.createEncodedPacketFromOggPacket(o,{timestampInSamples:s,vorbisLastBlocksize:n.vorbisBlockSize},t)}finally{r()}}async getPacket(e,t){let r=await this.demuxer.readingMutex.acquire();try{m(this.demuxer.fileSize!==null);let n=pt(e*this.internalSampleRate,14);if(n===0)return this.getFirstPacket(t,!1);if(n<0)return null;let a=this.demuxer.reader;m(this.bitstream.lastMetadataPacket);let s=await this.demuxer.findNextPacketStart(a,this.bitstream.lastMetadataPacket);if(!s)return null;let o=s.startPage,c=this.demuxer.fileSize,u=[o];e:for(;o.headerStartPos+o.totalSize<c;){let x=o.headerStartPos,y=Math.floor((x+c)/2),T=y;for(;;){let C=Math.min(T+mi,c-vt);if(await a.reader.loadRange(T,C),a.pos=T,!a.findNextPageHeader(C)){c=y+vt;continue e}await a.reader.loadRange(a.pos,a.pos+it);let E=a.readPageHeader();m(E);let _=!1;if(E.serialNumber===this.bitstream.serialNumber)_=!0;else{await a.reader.loadRange(E.headerStartPos,E.headerStartPos+E.totalSize),a.pos=E.headerStartPos;let V=a.readBytes(E.totalSize);_=di(V)===E.checksum}if(!_){T=E.headerStartPos+4;continue}if(_&&E.serialNumber!==this.bitstream.serialNumber){T=E.headerStartPos+E.totalSize;continue}if(E.granulePosition===-1){T=E.headerStartPos+E.totalSize;continue}this.granulePositionToTimestampInSamples(E.granulePosition)>n?c=E.headerStartPos:(o=E,u.push(E));continue e}}let d=s.startPage;for(let x of u){if(x.granulePosition===o.granulePosition)break;(!d||x.headerStartPos>d.headerStartPos)&&(d=x)}let l=d,f=[l];for(;!(l.serialNumber===this.bitstream.serialNumber&&l.granulePosition===o.granulePosition);){a.pos=l.headerStartPos+l.totalSize,await a.reader.loadRange(a.pos,a.pos+it);let x=a.readPageHeader();m(x),l=x,l.serialNumber===this.bitstream.serialNumber&&f.push(l)}m(l.granulePosition!==-1);let h=null,p,k,g=l,b=0;if(l.headerStartPos===s.startPage.headerStartPos)p=this.granulePositionToTimestampInSamples(0),k=!0,h=0;else{p=0,k=!1;for(let T=l.lacingValues.length-1;T>=0;T--)if(l.lacingValues[T]<255){h=T+1;break}if(h===null)throw new Error("Invalid page with granule position: no packets end on this page.");b=h-1;let x={data:ie,endPage:g,endSegmentIndex:b};if(await this.demuxer.findNextPacketStart(a,x)){let T=gs(f,l,h);m(T);let C=hs(f,T.page,T.segmentIndex);C&&(l=C.page,h=C.segmentIndex)}else for(;;){let T=gs(f,l,h);if(!T)break;let C=hs(f,T.page,T.segmentIndex);if(!C)break;if(l=C.page,h=C.segmentIndex,T.page.headerStartPos!==g.headerStartPos){g=T.page,b=T.segmentIndex;break}}}let w=null,S=null;for(;l!==null;){m(h!==null);let x=await this.demuxer.readPacket(a,l,h);if(!x)break;if(!(l.headerStartPos===s.startPage.headerStartPos&&h<s.startSegmentIndex)){let C=this.createEncodedPacketFromOggPacket(x,{timestampInSamples:p,vorbisLastBlocksize:S?.vorbisBlockSize??null},t);m(C);let P=this.encodedPacketToMetadata.get(C);if(m(P),!k&&x.endPage.headerStartPos===g.headerStartPos&&x.endSegmentIndex===b?(p=this.granulePositionToTimestampInSamples(l.granulePosition),k=!0,C=this.createEncodedPacketFromOggPacket(x,{timestampInSamples:p-P.durationInSamples,vorbisLastBlocksize:S?.vorbisBlockSize??null},t),m(C),P=this.encodedPacketToMetadata.get(C),m(P)):p+=P.durationInSamples,w=C,S=P,k&&(Math.max(p,0)>n||Math.max(P.timestampInSamples,0)===n))break}let T=await this.demuxer.findNextPacketStart(a,x);if(!T)break;l=T.startPage,h=T.startSegmentIndex}return w}finally{r()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}},hs=(i,e,t)=>{let r=e,n=t;e:for(;;){for(n--,n;n>=0;n--)if(r.lacingValues[n]<255){n++;break e}if(m(n===-1),!(r.headerType&1)){n=0;break}let s=Xi(i,o=>o.headerStartPos<r.headerStartPos);if(!s)return null;r=s,n=r.lacingValues.length}if(m(n!==-1),n===r.lacingValues.length){let a=i[i.indexOf(r)+1];m(a),r=a,n=0}return{page:r,segmentIndex:n}},gs=(i,e,t)=>{if(t>0)return{page:e,segmentIndex:t-1};let r=Xi(i,n=>n.headerStartPos<e.headerStartPos);return r?{page:r,segmentIndex:r.lacingValues.length-1}:null};var qe=9,Nt=class{constructor(e){this.reader=e;this.pos=0}readBytes(e){let{view:t,offset:r}=this.reader.getViewAndOffset(this.pos,this.pos+e);return this.pos+=e,new Uint8Array(t.buffer,r,e)}readFrameHeader(){let e=this.pos,t=this.readBytes(9),r=new N(t);if(r.readBits(12)!==4095||(r.skipBits(1),r.readBits(2)!==0))return null;let s=r.readBits(1),o=r.readBits(2)+1,c=r.readBits(4);if(c===15)return null;r.skipBits(1);let u=r.readBits(3);if(u===0)throw new Error("ADTS frames with channel configuration 0 are not supported.");r.skipBits(1),r.skipBits(1),r.skipBits(1),r.skipBits(1);let d=r.readBits(13);r.skipBits(11);let l=r.readBits(2)+1;if(l!==1)throw new Error("ADTS frames with more than one AAC frame are not supported.");let f=null;return s===1?this.pos-=2:f=r.readBits(16),{objectType:o,samplingFrequencyIndex:c,channelConfiguration:u,frameLength:d,numberOfAacFrames:l,crcCheck:f,startPos:e}}};var Oa=1024,Hi=class extends ue{constructor(t){super(t);this.metadataPromise=null;this.firstFrameHeader=null;this.loadedSamples=[];this.tracks=[];this.readingMutex=new te;this.lastLoadedPos=0;this.fileSize=0;this.nextTimestampInSamples=0;this.reader=new Nt(t._mainReader)}async readMetadata(){return this.metadataPromise??=(async()=>{this.fileSize=await this.input.source.getSize(),await this.loadNextChunk(),m(this.firstFrameHeader),this.tracks=[new $(new Ma(this))]})()}async loadNextChunk(){m(this.lastLoadedPos<this.fileSize);let t=.5*1024*1024,r=Math.min(this.lastLoadedPos+t,this.fileSize);await this.reader.reader.loadRange(this.lastLoadedPos,r),this.lastLoadedPos=r,m(this.lastLoadedPos<=this.fileSize),this.parseFramesFromLoadedData()}parseFramesFromLoadedData(){for(;this.reader.pos<=this.fileSize-qe;){let t=this.reader.pos,r=this.reader.readFrameHeader();if(!r)break;if(t+r.frameLength>this.lastLoadedPos){this.reader.pos=t,this.lastLoadedPos=t;break}this.firstFrameHeader||(this.firstFrameHeader=r);let n=jt[r.samplingFrequencyIndex];m(n!==void 0);let a=Oa/n,s=r.crcCheck?qe:qe-2,o={timestamp:this.nextTimestampInSamples/n,duration:a,dataStart:t+s,dataSize:r.frameLength-s};this.loadedSamples.push(o),this.nextTimestampInSamples+=Oa,this.reader.pos=t+r.frameLength}}async getMimeType(){return"audio/aac"}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){await this.readMetadata();let t=this.tracks[0];return m(t),t.computeDuration()}},Ma=class{constructor(e){this.demuxer=e}getId(){return 1}async getFirstTimestamp(){return 0}getTimeResolution(){return this.getSampleRate()/Oa}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getName(){return null}getLanguageCode(){return Q}getCodec(){return"aac"}getInternalCodecId(){return m(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.objectType}getNumberOfChannels(){m(this.demuxer.firstFrameHeader);let e=Ji[this.demuxer.firstFrameHeader.channelConfiguration];return m(e!==void 0),e}getSampleRate(){m(this.demuxer.firstFrameHeader);let e=jt[this.demuxer.firstFrameHeader.samplingFrequencyIndex];return m(e!==void 0),e}async getDecoderConfig(){m(this.demuxer.firstFrameHeader);let e=new Uint8Array(3),t=new N(e),{objectType:r,samplingFrequencyIndex:n,channelConfiguration:a}=this.demuxer.firstFrameHeader;return r>31?(t.writeBits(5,31),t.writeBits(6,r-32)):t.writeBits(5,r),t.writeBits(4,n),t.writeBits(4,a),{codec:`mp4a.40.${this.demuxer.firstFrameHeader.objectType}`,numberOfChannels:this.getNumberOfChannels(),sampleRate:this.getSampleRate(),description:e.subarray(0,Math.ceil((t.pos-1)/8))}}getPacketAtIndex(e,t){if(e===-1)return null;let r=this.demuxer.loadedSamples[e];if(!r)return null;let n;return t.metadataOnly?n=ie:(this.demuxer.reader.pos=r.dataStart,n=this.demuxer.reader.readBytes(r.dataSize)),new M(n,"key",r.timestamp,r.duration,e,r.dataSize)}async getFirstPacket(e){return this.getPacketAtIndex(0,e)}async getNextPacket(e,t){let r=await this.demuxer.readingMutex.acquire();try{let n=W(this.demuxer.loadedSamples,e.timestamp,s=>s.timestamp);if(n===-1)throw new Error("Packet was not created from this track.");let a=n+1;for(;a>=this.demuxer.loadedSamples.length&&this.demuxer.lastLoadedPos<this.demuxer.fileSize;)await this.demuxer.loadNextChunk();return this.getPacketAtIndex(a,t)}finally{r()}}async getPacket(e,t){let r=await this.demuxer.readingMutex.acquire();try{for(;;){let n=B(this.demuxer.loadedSamples,e,a=>a.timestamp);if(n===-1&&this.demuxer.loadedSamples.length>0)return null;if(this.demuxer.lastLoadedPos===this.demuxer.fileSize)return this.getPacketAtIndex(n,t);if(n>=0&&n+1<this.demuxer.loadedSamples.length)return this.getPacketAtIndex(n,t);await this.demuxer.loadNextChunk()}}finally{r()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}};var ge=class{},Lt=class extends ge{async _getMajorBrand(e){if(await e._mainReader.source.getSize()<12)return null;let r=new Xe(e._mainReader);return r.pos=4,r.readAscii(4)!=="ftyp"?null:r.readAscii(4)}_createDemuxer(e){return new Vi(e)}},br=class extends Lt{async _canReadInput(e){let t=await this._getMajorBrand(e);return!!t&&t!=="qt  "}get name(){return"MP4"}get mimeType(){return"video/mp4"}},kr=class extends Lt{async _canReadInput(e){return await this._getMajorBrand(e)==="qt  "}get name(){return"QuickTime File Format"}get mimeType(){return"video/quicktime"}};function mc(){return 5}var Wt=class extends ge{async isSupportedEBMLOfDocType(e,t){if(await e._mainReader.source.getSize()<8)return!1;let n=new et(e._mainReader),a=n.readVarIntSize();if(a===null||(mc(),a<1||a>8)||n.readUnsignedInt(a)!==440786851)return!1;let o=n.readElementSize();if(o===null)return!1;let c=n.pos;for(;n.pos<=c+o-ve;){let u=n.readElementHeader();if(!u)break;let{id:d,size:l}=u,f=n.pos;if(l===null)return!1;switch(d){case 17030:if(n.readUnsignedInt(l)!==1)return!1;break;case 17143:if(n.readUnsignedInt(l)!==1)return!1;break;case 17026:if(n.readAsciiString(l)!==t)return!1;break;case 17031:if(n.readUnsignedInt(l)>4)return!1;break}n.pos=f+l}return!0}_canReadInput(e){return this.isSupportedEBMLOfDocType(e,"matroska")}_createDemuxer(e){return new zi(e)}get name(){return"Matroska"}get mimeType(){return"video/x-matroska"}},wr=class extends Wt{_canReadInput(e){return this.isSupportedEBMLOfDocType(e,"webm")}get name(){return"WebM"}get mimeType(){return"video/webm"}},Tr=class extends ge{async _canReadInput(e){let t=await e._mainReader.source.getSize();if(t<4)return!1;let r=new zt(e._mainReader);r.fileSize=t;let n=r.readId3();n&&(r.pos+=n.size);let a=r.pos;await r.reader.loadRange(r.pos,r.pos+4096);let s=r.readNextFrameHeader(Math.min(a+4096,t));if(!s)return!1;if(n)return!0;r.pos=s.startPos+s.totalSize,await r.reader.loadRange(r.pos,r.pos+4);let o=r.readNextFrameHeader(r.pos+4);return!(!o||s.channel!==o.channel||s.sampleRate!==o.sampleRate)}_createDemuxer(e){return new Li(e)}get name(){return"MP3"}get mimeType(){return"audio/mpeg"}},yr=class extends ge{async _canReadInput(e){if(await e._mainReader.source.getSize()<12)return!1;let r=new ot(e._mainReader),n=r.readAscii(4);return n!=="RIFF"&&n!=="RIFX"&&n!=="RF64"?!1:(r.pos=8,r.readAscii(4)==="WAVE")}_createDemuxer(e){return new gi(e)}get name(){return"WAVE"}get mimeType(){return"audio/wav"}},Sr=class extends ge{async _canReadInput(e){return await e._mainReader.source.getSize()<4?!1:new xt(e._mainReader).readAscii(4)==="OggS"}_createDemuxer(e){return new Wi(e)}get name(){return"Ogg"}get mimeType(){return"application/ogg"}},Ba=class extends ge{async _canReadInput(e){let t=await e._mainReader.source.getSize();if(t<qe)return!1;let r=new Nt(e._mainReader),n=r.readFrameHeader();if(!n||t<n.frameLength+qe)return!1;r.pos=n.frameLength,await r.reader.loadRange(r.pos,r.pos+qe);let a=r.readFrameHeader();return a?n.objectType===a.objectType&&n.samplingFrequencyIndex===a.samplingFrequencyIndex&&n.channelConfiguration===a.channelConfiguration:!1}_createDemuxer(e){return new Hi(e)}get name(){return"ADTS"}get mimeType(){return"audio/aac"}},Da=new br,Va=new kr,Ua=new Wt,za=new wr,Na=new Tr,La=new yr,Wa=new Sr,fc=new Ba,bs=[Da,Va,Ua,za,La,Wa,Na,fc];var Ht=class{constructor(e){this._demuxerPromise=null;this._format=null;if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(!Array.isArray(e.formats)||e.formats.some(t=>!(t instanceof ge)))throw new TypeError("options.formats must be an array of InputFormat.");if(!(e.source instanceof Ie))throw new TypeError("options.source must be a Source.");this._formats=e.formats,this._source=e.source,this._mainReader=new fe(e.source)}_getDemuxer(){return this._demuxerPromise??=(async()=>{await this._mainReader.loadRange(0,4096);for(let e of this._formats)if(await e._canReadInput(this))return this._format=e,e._createDemuxer(this);throw new Error("Input has an unsupported or unrecognizable format.")})()}get source(){return this._source}async getFormat(){return await this._getDemuxer(),m(this._format),this._format}async computeDuration(){return(await this._getDemuxer()).computeDuration()}async getTracks(){return(await this._getDemuxer()).getTracks()}async getVideoTracks(){return(await this.getTracks()).filter(t=>t.isVideoTrack())}async getPrimaryVideoTrack(){return(await this.getTracks()).find(t=>t.isVideoTrack())??null}async getAudioTracks(){return(await this.getTracks()).filter(t=>t.isAudioTrack())}async getPrimaryAudioTrack(){return(await this.getTracks()).find(t=>t.isAudioTrack())??null}async getMimeType(){return(await this._getDemuxer()).getMimeType()}};var ks=i=>{if(i!==void 0&&(!i||typeof i!="object"))throw new TypeError("options.video, when provided, must be an object.");if(i?.discard!==void 0&&typeof i.discard!="boolean")throw new TypeError("options.video.discard, when provided, must be a boolean.");if(i?.forceTranscode!==void 0&&typeof i.forceTranscode!="boolean")throw new TypeError("options.video.forceTranscode, when provided, must be a boolean.");if(i?.codec!==void 0&&!j.includes(i.codec))throw new TypeError(`options.video.codec, when provided, must be one of: ${j.join(", ")}.`);if(i?.bitrate!==void 0&&!(i.bitrate instanceof G)&&(!Number.isInteger(i.bitrate)||i.bitrate<=0))throw new TypeError("options.video.bitrate, when provided, must be a positive integer or a quality.");if(i?.width!==void 0&&(!Number.isInteger(i.width)||i.width<=0))throw new TypeError("options.video.width, when provided, must be a positive integer.");if(i?.height!==void 0&&(!Number.isInteger(i.height)||i.height<=0))throw new TypeError("options.video.height, when provided, must be a positive integer.");if(i?.fit!==void 0&&!["fill","contain","cover"].includes(i.fit))throw new TypeError('options.video.fit, when provided, must be one of "fill", "contain", or "cover".');if(i?.width!==void 0&&i.height!==void 0&&i.fit===void 0)throw new TypeError("When both options.video.width and options.video.height are provided, options.video.fit must also be provided.");if(i?.rotate!==void 0&&![0,90,180,270].includes(i.rotate))throw new TypeError("options.video.rotate, when provided, must be 0, 90, 180 or 270.");if(i?.frameRate!==void 0&&(!Number.isFinite(i.frameRate)||i.frameRate<=0))throw new TypeError("options.video.frameRate, when provided, must be a finite positive number.")},ws=i=>{if(i!==void 0&&(!i||typeof i!="object"))throw new TypeError("options.audio, when provided, must be an object.");if(i?.discard!==void 0&&typeof i.discard!="boolean")throw new TypeError("options.audio.discard, when provided, must be a boolean.");if(i?.forceTranscode!==void 0&&typeof i.forceTranscode!="boolean")throw new TypeError("options.audio.forceTranscode, when provided, must be a boolean.");if(i?.codec!==void 0&&!X.includes(i.codec))throw new TypeError(`options.audio.codec, when provided, must be one of: ${X.join(", ")}.`);if(i?.bitrate!==void 0&&!(i.bitrate instanceof G)&&(!Number.isInteger(i.bitrate)||i.bitrate<=0))throw new TypeError("options.audio.bitrate, when provided, must be a positive integer or a quality.");if(i?.numberOfChannels!==void 0&&(!Number.isInteger(i.numberOfChannels)||i.numberOfChannels<=0))throw new TypeError("options.audio.numberOfChannels, when provided, must be a positive integer.");if(i?.sampleRate!==void 0&&(!Number.isInteger(i.sampleRate)||i.sampleRate<=0))throw new TypeError("options.audio.sampleRate, when provided, must be a positive integer.")},Ha=2,Ka=48e3,Ki=class i{constructor(e){this._addedCounts={video:0,audio:0,subtitle:0};this._totalTrackCount=0;this._trackPromises=[];this._executed=!1;this._synchronizer=new qa;this._totalDuration=null;this._maxTimestamps=new Map;this._canceled=!1;this.onProgress=void 0;this._computeProgress=!1;this._lastProgress=0;this.utilizedTracks=[];this.discardedTracks=[];if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(!(e.input instanceof Ht))throw new TypeError("options.input must be an Input.");if(!(e.output instanceof Ut))throw new TypeError("options.output must be an Output.");if(e.output._tracks.length>0||e.output.state!=="pending")throw new TypeError("options.output must be fresh: no tracks added and not started.");if(typeof e.video!="function"&&ks(e.video),typeof e.audio!="function"&&ws(e.audio),e.trim!==void 0&&(!e.trim||typeof e.trim!="object"))throw new TypeError("options.trim, when provided, must be an object.");if(e.trim?.start!==void 0&&(!Number.isFinite(e.trim.start)||e.trim.start<0))throw new TypeError("options.trim.start, when provided, must be a non-negative number.");if(e.trim?.end!==void 0&&(!Number.isFinite(e.trim.end)||e.trim.end<0))throw new TypeError("options.trim.end, when provided, must be a non-negative number.");if(e.trim?.start!==void 0&&e.trim.end!==void 0&&e.trim.start>=e.trim.end)throw new TypeError("options.trim.start must be less than options.trim.end.");this._options=e,this.input=e.input,this.output=e.output,this._startTimestamp=e.trim?.start??0,this._endTimestamp=e.trim?.end??1/0;let{promise:t,resolve:r}=L();this._started=t,this._start=r}static async init(e){let t=new i(e);return await t._init(),t}async _init(){let e=await this.input.getTracks(),t=this.output.format.getSupportedTrackCounts(),r=1,n=1;for(let s of e){let o;if(s.isVideoTrack()?this._options.video&&(typeof this._options.video=="function"?(o=await this._options.video(s,r),ks(o),r++):o=this._options.video):s.isAudioTrack()?this._options.audio&&(typeof this._options.audio=="function"?(o=await this._options.audio(s,n),ws(o),n++):o=this._options.audio):m(!1),o?.discard){this.discardedTracks.push({track:s,reason:"discarded_by_user"});continue}if(this._totalTrackCount===t.total.max){this.discardedTracks.push({track:s,reason:"max_track_count_reached"});continue}if(this._addedCounts[s.type]===t[s.type].max){this.discardedTracks.push({track:s,reason:"max_track_count_of_type_reached"});continue}s.isVideoTrack()?await this._processVideoTrack(s,o??{}):s.isAudioTrack()&&await this._processAudioTrack(s,o??{})}let a=this.discardedTracks.filter(s=>s.reason!=="discarded_by_user");a.length>0&&console.warn("Some tracks had to be discarded from the conversion:",a)}async execute(){if(this._executed)throw new Error("Conversion cannot be executed twice.");this._executed=!0,this.onProgress&&(this._computeProgress=!0,this._totalDuration=Math.min(await this.input.computeDuration()-this._startTimestamp,this._endTimestamp-this._startTimestamp),this.onProgress?.(0)),await this.output.start(),this._start();try{await Promise.all(this._trackPromises)}catch(e){throw this._canceled||this.cancel(),e}this._canceled&&await new Promise(()=>{}),await this.output.finalize(),this._computeProgress&&this.onProgress?.(1)}async cancel(){if(!(this.output.state==="finalizing"||this.output.state==="finalized")){if(this._canceled){console.warn("Conversion already canceled.");return}this._canceled=!0,await this.output.cancel()}}async _processVideoTrack(e,t){let r=e.codec;if(!r){this.discardedTracks.push({track:e,reason:"unknown_source_codec"});return}let n,a=Ue(e.rotation+(t.rotate??0)),s=this.output.format.supportsVideoRotationMetadata,[o,c]=a%180===0?[e.codedWidth,e.codedHeight]:[e.codedHeight,e.codedWidth],u=o,d=c,l=u/d,f=b=>Math.ceil(b/2)*2;t.width!==void 0&&t.height===void 0?(u=f(t.width),d=f(Math.round(u/l))):t.width===void 0&&t.height!==void 0?(d=f(t.height),u=f(Math.round(d*l))):t.width!==void 0&&t.height!==void 0&&(u=f(t.width),d=f(t.height));let h=await e.getFirstTimestamp(),p=!!t.forceTranscode||this._startTimestamp>0||h<0||!!t.frameRate,k=u!==o||d!==c||a!==0&&!s,g=this.output.format.getSupportedVideoCodecs();if(!p&&!t.bitrate&&!k&&g.includes(r)&&(!t.codec||t.codec===r)){let b=new Bt(r);n=b,this._trackPromises.push((async()=>{await this._started;let w=new we(e),x={decoderConfig:await e.getDecoderConfig()??void 0},y=Number.isFinite(this._endTimestamp)?await w.getPacket(this._endTimestamp,{metadataOnly:!0})??void 0:void 0;for await(let T of w.packets(void 0,y,{verifyKeyPackets:!0})){if(this._synchronizer.shouldWait(e.id,T.timestamp)&&await this._synchronizer.wait(T.timestamp),this._canceled)return;await b.add(T,x),this._reportProgress(e.id,T.timestamp+T.duration)}b.close(),this._synchronizer.closeTrack(e.id)})())}else{if(!await e.canDecode()){this.discardedTracks.push({track:e,reason:"undecodable_source_codec"});return}t.codec&&(g=g.filter(T=>T===t.codec));let w=t.bitrate??Gt,S=await Ei(g,{width:u,height:d,bitrate:w});if(!S){this.discardedTracks.push({track:e,reason:"no_encodable_target_codec"});return}let x={codec:S,bitrate:w,sizeChangeBehavior:t.fit??"passThrough",onEncodedPacket:T=>this._reportProgress(e.id,T.timestamp+T.duration)},y=new Dt(x);n=y,k?this._trackPromises.push((async()=>{await this._started;let C=new At(e,{width:u,height:d,fit:t.fit??"fill",rotation:a,poolSize:1}).canvases(this._startTimestamp,this._endTimestamp),P=t.frameRate,E=null,_=null,A=null,V=async H=>{m(E),m(P!==void 0);let Z=Math.round((H-_)*P);for(let lt=1;lt<Z;lt++){let Qe=new ne(E,{timestamp:_+lt/P,duration:1/P});await y.add(Qe)}};for await(let{canvas:H,timestamp:Z,duration:lt}of C){if(this._synchronizer.shouldWait(e.id,Z)&&await this._synchronizer.wait(Z),this._canceled)return;let Qe=Math.max(Z-this._startTimestamp,0);if(A=Qe+lt,P!==void 0){let Cr=Math.floor(Qe*P)/P;if(E!==null)if(Cr<=_){E=H,_=Cr;continue}else await V(Cr);Qe=Cr}let ja=new ne(H,{timestamp:Qe,duration:P!==void 0?1/P:lt});await y.add(ja),P!==void 0?(E=H,_=Qe):ja.close()}E&&(m(A!==null),m(P!==void 0),await V(Math.floor(A*P)/P)),y.close(),this._synchronizer.closeTrack(e.id)})()):this._trackPromises.push((async()=>{await this._started;let T=new st(e),C=t.frameRate,P=null,E=null,_=null,A=async V=>{m(P),m(C!==void 0);let H=Math.round((V-E)*C);for(let Z=1;Z<H;Z++)P.setTimestamp(E+Z/C),P.setDuration(1/C),await y.add(P);P.close()};for await(let V of T.samples(this._startTimestamp,this._endTimestamp)){if(this._synchronizer.shouldWait(e.id,V.timestamp)&&await this._synchronizer.wait(V.timestamp),this._canceled){P?.close();return}let H=Math.max(V.timestamp-this._startTimestamp,0);if(_=H+V.duration,C!==void 0){let Z=Math.floor(H*C)/C;if(P!==null)if(Z<=E){P.close(),P=V,E=Z;continue}else await A(Z);H=Z,V.setDuration(1/C)}V.setTimestamp(H),await y.add(V),C!==void 0?(P=V,E=H):V.close()}P&&(m(_!==null),m(C!==void 0),await A(Math.floor(_*C)/C)),y.close(),this._synchronizer.closeTrack(e.id)})())}this.output.addVideoTrack(n,{frameRate:t.frameRate,languageCode:Fe(e.languageCode)?e.languageCode:void 0,name:e.name??void 0,rotation:k?0:a}),this._addedCounts.video++,this._totalTrackCount++,this.utilizedTracks.push(e)}async _processAudioTrack(e,t){let r=e.codec;if(!r){this.discardedTracks.push({track:e,reason:"unknown_source_codec"});return}let n,a=e.numberOfChannels,s=e.sampleRate,o=await e.getFirstTimestamp(),c=t.numberOfChannels??a,u=t.sampleRate??s,d=c!==a||u!==s||this._startTimestamp>0||o<0,l=this.output.format.getSupportedAudioCodecs();if(!t.forceTranscode&&!t.bitrate&&!d&&l.includes(r)&&(!t.codec||t.codec===r)){let f=new Vt(r);n=f,this._trackPromises.push((async()=>{await this._started;let h=new we(e),k={decoderConfig:await e.getDecoderConfig()??void 0},g=Number.isFinite(this._endTimestamp)?await h.getPacket(this._endTimestamp,{metadataOnly:!0})??void 0:void 0;for await(let b of h.packets(void 0,g)){if(this._synchronizer.shouldWait(e.id,b.timestamp)&&await this._synchronizer.wait(b.timestamp),this._canceled)return;await f.add(b,k),this._reportProgress(e.id,b.timestamp+b.duration)}f.close(),this._synchronizer.closeTrack(e.id)})())}else{if(!await e.canDecode()){this.discardedTracks.push({track:e,reason:"undecodable_source_codec"});return}let h=null;t.codec&&(l=l.filter(g=>g===t.codec));let p=t.bitrate??Gt,k=await Mt(l,{numberOfChannels:c,sampleRate:u,bitrate:p});if(!k.some(g=>ye.includes(g))&&l.some(g=>ye.includes(g))&&(c!==Ha||u!==Ka)){let b=(await Mt(l,{numberOfChannels:Ha,sampleRate:Ka,bitrate:p})).find(w=>ye.includes(w));b&&(d=!0,h=b,c=Ha,u=Ka)}else h=k[0]??null;if(h===null){this.discardedTracks.push({track:e,reason:"no_encodable_target_codec"});return}if(d)n=this._resampleAudio(e,h,c,u,p);else{let g=new dt({codec:h,bitrate:p,onEncodedPacket:b=>this._reportProgress(e.id,b.timestamp+b.duration)});n=g,this._trackPromises.push((async()=>{await this._started;let b=new He(e);for await(let w of b.samples(void 0,this._endTimestamp)){if(this._synchronizer.shouldWait(e.id,w.timestamp)&&await this._synchronizer.wait(w.timestamp),this._canceled)return;await g.add(w),w.close()}g.close(),this._synchronizer.closeTrack(e.id)})())}}this.output.addAudioTrack(n,{languageCode:Fe(e.languageCode)?e.languageCode:void 0,name:e.name??void 0}),this._addedCounts.audio++,this._totalTrackCount++,this.utilizedTracks.push(e)}_resampleAudio(e,t,r,n,a){let s=new dt({codec:t,bitrate:a,onEncodedPacket:o=>this._reportProgress(e.id,o.timestamp+o.duration)});return this._trackPromises.push((async()=>{await this._started;let o=new Qa({sourceNumberOfChannels:e.numberOfChannels,sourceSampleRate:e.sampleRate,targetNumberOfChannels:r,targetSampleRate:n,startTime:this._startTimestamp,endTime:this._endTimestamp,onSample:d=>s.add(d)}),u=new He(e).samples(this._startTimestamp,this._endTimestamp);for await(let d of u){if(this._synchronizer.shouldWait(e.id,d.timestamp)&&await this._synchronizer.wait(d.timestamp),this._canceled)return;await o.add(d)}await o.finalize(),s.close(),this._synchronizer.closeTrack(e.id)})()),s}_reportProgress(e,t){if(!this._computeProgress)return;m(this._totalDuration!==null),this._maxTimestamps.set(e,Math.max(t,this._maxTimestamps.get(e)??-1/0));let r=0;for(let[,s]of this._maxTimestamps)r+=s;let n=r/this._totalTrackCount,a=J(n/this._totalDuration,0,1);a!==this._lastProgress&&(this._lastProgress=a,this.onProgress?.(a))}},Ts=5,qa=class{constructor(){this.maxTimestamps=new Map;this.resolvers=[]}computeMinAndMaybeResolve(){let e=1/0;for(let[,t]of this.maxTimestamps)e=Math.min(e,t);for(let t=0;t<this.resolvers.length;t++){let r=this.resolvers[t];r.timestamp-e<Ts&&(r.resolve(),this.resolvers.splice(t,1),t--)}return e}shouldWait(e,t){this.maxTimestamps.set(e,Math.max(t,this.maxTimestamps.get(e)??-1/0));let r=this.computeMinAndMaybeResolve();return t-r>=Ts}wait(e){let{promise:t,resolve:r}=L();return this.resolvers.push({timestamp:e,resolve:r}),t}closeTrack(e){this.maxTimestamps.delete(e),this.computeMinAndMaybeResolve()}},Qa=class{constructor(e){this.sourceSampleRate=e.sourceSampleRate,this.targetSampleRate=e.targetSampleRate,this.sourceNumberOfChannels=e.sourceNumberOfChannels,this.targetNumberOfChannels=e.targetNumberOfChannels,this.startTime=e.startTime,this.endTime=e.endTime,this.onSample=e.onSample,this.bufferSizeInFrames=Math.floor(this.targetSampleRate*5),this.bufferSizeInSamples=this.bufferSizeInFrames*this.targetNumberOfChannels,this.outputBuffer=new Float32Array(this.bufferSizeInSamples),this.bufferStartFrame=0,this.maxWrittenFrame=-1,this.setupChannelMixer(),this.tempSourceBuffer=new Float32Array(this.sourceSampleRate*this.sourceNumberOfChannels)}setupChannelMixer(){let e=this.sourceNumberOfChannels,t=this.targetNumberOfChannels;e===1&&t===2?this.channelMixer=(r,n)=>r[n*e]:e===1&&t===4?this.channelMixer=(r,n,a)=>r[n*e]*+(a<2):e===1&&t===6?this.channelMixer=(r,n,a)=>r[n*e]*+(a===2):e===2&&t===1?this.channelMixer=(r,n)=>{let a=n*e;return .5*(r[a]+r[a+1])}:e===2&&t===4?this.channelMixer=(r,n,a)=>r[n*e+a]*+(a<2):e===2&&t===6?this.channelMixer=(r,n,a)=>r[n*e+a]*+(a<2):e===4&&t===1?this.channelMixer=(r,n)=>{let a=n*e;return .25*(r[a]+r[a+1]+r[a+2]+r[a+3])}:e===4&&t===2?this.channelMixer=(r,n,a)=>{let s=n*e;return .5*(r[s+a]+r[s+a+2])}:e===4&&t===6?this.channelMixer=(r,n,a)=>{let s=n*e;return a<2?r[s+a]:a===2||a===3?0:r[s+a-2]}:e===6&&t===1?this.channelMixer=(r,n)=>{let a=n*e;return Math.SQRT1_2*(r[a]+r[a+1])+r[a+2]+.5*(r[a+4]+r[a+5])}:e===6&&t===2?this.channelMixer=(r,n,a)=>{let s=n*e;return r[s+a]+Math.SQRT1_2*(r[s+2]+r[s+a+4])}:e===6&&t===4?this.channelMixer=(r,n,a)=>{let s=n*e;return a<2?r[s+a]+Math.SQRT1_2*r[s+2]:r[s+a+2]}:this.channelMixer=(r,n,a)=>a<e?r[n*e+a]:0}ensureTempBufferSize(e){let t=this.tempSourceBuffer.length;for(;t<e;)t*=2;if(t!==this.tempSourceBuffer.length){let r=new Float32Array(t);r.set(this.tempSourceBuffer),this.tempSourceBuffer=r}}async add(e){if(!e||e._closed)return;let t=e.numberOfFrames*e.numberOfChannels;this.ensureTempBufferSize(t);let r=e.allocationSize({planeIndex:0,format:"f32"}),n=new Float32Array(this.tempSourceBuffer.buffer,0,r/4);e.copyTo(n,{planeIndex:0,format:"f32"});let a=e.timestamp-this.startTime,s=e.numberOfFrames/this.sourceSampleRate,o=Math.min(a+s,this.endTime-this.startTime),c=Math.floor(a*this.targetSampleRate),u=Math.ceil(o*this.targetSampleRate);for(let d=c;d<u;d++){if(d<this.bufferStartFrame)continue;for(;d>=this.bufferStartFrame+this.bufferSizeInFrames;)await this.finalizeCurrentBuffer(),this.bufferStartFrame+=this.bufferSizeInFrames;let l=d-this.bufferStartFrame;m(l<this.bufferSizeInFrames);let p=(d/this.targetSampleRate-a)*this.sourceSampleRate,k=Math.floor(p),g=Math.ceil(p),b=p-k;for(let w=0;w<this.targetNumberOfChannels;w++){let S=0,x=0;k>=0&&k<e.numberOfFrames&&(S=this.channelMixer(n,k,w)),g>=0&&g<e.numberOfFrames&&(x=this.channelMixer(n,g,w));let y=S+b*(x-S),T=l*this.targetNumberOfChannels+w;this.outputBuffer[T]+=y}this.maxWrittenFrame=Math.max(this.maxWrittenFrame,l)}}async finalizeCurrentBuffer(){if(this.maxWrittenFrame<0)return;let e=(this.maxWrittenFrame+1)*this.targetNumberOfChannels,t=new Float32Array(e);t.set(this.outputBuffer.subarray(0,e));let r=this.bufferStartFrame/this.targetSampleRate,n=new se({format:"f32",sampleRate:this.targetSampleRate,numberOfChannels:this.targetNumberOfChannels,timestamp:r,data:t});await this.onSample(n),this.outputBuffer.fill(0),this.maxWrittenFrame=-1}finalize(){return this.finalizeCurrentBuffer()}};return Ps(pc);})();
if (typeof module === "object" && typeof module.exports === "object") Object.assign(module.exports, Mediabunny)
